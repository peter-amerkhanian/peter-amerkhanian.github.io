<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Peter Amerkhanian">
<meta name="dcterms.date" content="2025-07-20">
<meta name="description" content="An overview of several geospatial techniques and thematic map styles in python.">

<title>Thematic maps with Python – Peter Amerkhanian</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../profile_backup.jpg" rel="icon" type="image/jpeg">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-1092c56c6cadf2eb47b1bc8063ab382a.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-5d17cd34d2e348db00e20f83fc65b062.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-V95HGLKTEB"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-V95HGLKTEB', { 'anonymize_ip': true});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<meta name="quarto:status" content="draft">


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner"><div id="quarto-draft-alert" class="alert alert-warning"><i class="bi bi-pencil-square"></i>Draft</div>
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../profile_backup.jpg" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Home</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../projects.html"> 
<span class="menu-text">Professional</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">Thematic maps with Python</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li></ul></div></div>
                  <div>
        <div class="description">
          An overview of several geospatial techniques and thematic map styles in python.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">Python</div>
                <div class="quarto-category">GIS</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Peter Amerkhanian </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">July 20, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
        <h2 id="toc-title"><a href="#" class="nav-link">Thematic maps with Python</a></h2>
     
    <ul>
    <li><a href="#question" id="toc-question" class="nav-link active" data-scroll-target="#question">Question</a></li>
    <li><a href="#data" id="toc-data" class="nav-link" data-scroll-target="#data">Data</a>
    <ul class="collapse">
    <li><a href="#gtfs-data-from-cal-itp" id="toc-gtfs-data-from-cal-itp" class="nav-link" data-scroll-target="#gtfs-data-from-cal-itp">GTFS Data from Cal ITP</a></li>
    <li><a href="#census-shapes-with-tigrispygris" id="toc-census-shapes-with-tigrispygris" class="nav-link" data-scroll-target="#census-shapes-with-tigrispygris">Census shapes with <code>tigris</code>/<code>pygris</code></a></li>
    <li><a href="#dealing-with-coordinate-reference-systems" id="toc-dealing-with-coordinate-reference-systems" class="nav-link" data-scroll-target="#dealing-with-coordinate-reference-systems">Dealing with Coordinate Reference Systems</a></li>
    </ul></li>
    <li><a href="#exercise-1-point-plot-pros-and-cons" id="toc-exercise-1-point-plot-pros-and-cons" class="nav-link" data-scroll-target="#exercise-1-point-plot-pros-and-cons">Exercise 1: Point Plot Pros and Cons</a></li>
    <li><a href="#exercise-2-county-choropleths" id="toc-exercise-2-county-choropleths" class="nav-link" data-scroll-target="#exercise-2-county-choropleths">Exercise 2: County Choropleths</a></li>
    <li><a href="#exercise-3-a-region-choropleth" id="toc-exercise-3-a-region-choropleth" class="nav-link" data-scroll-target="#exercise-3-a-region-choropleth">Exercise 3: A Region Choropleth</a></li>
    <li><a href="#exercise-4-heatmaps-and-projected-crs" id="toc-exercise-4-heatmaps-and-projected-crs" class="nav-link" data-scroll-target="#exercise-4-heatmaps-and-projected-crs">Exercise 4: Heatmaps and Projected CRS</a></li>
    <li><a href="#exercise-5-refining-land-and-sea" id="toc-exercise-5-refining-land-and-sea" class="nav-link" data-scroll-target="#exercise-5-refining-land-and-sea">Exercise 5: Refining Land and Sea</a></li>
    </ul>
    <div class="quarto-alternate-formats">
    <ul><li>
    <a id="github" href="#" target="_blank"><i class="bi bi-github"></i>Source Code</a>
  </li></ul>
</div>

  </nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">






<script>
  var githubLink = document.getElementById("github");
  var currentPath = window.location.pathname;
  githubLink.href = "https://github.com/peter-amerkhanian/peter-amerkhanian.github.io/blob/master" + currentPath;
  document.getElementById('toc-title').addEventListener('click', function(event) {
  event.preventDefault(); // Prevent default behavior of anchor tag
  const firstHeader = document.querySelector('body'); // Select the first h2 element
  if (firstHeader) {
    firstHeader.scrollIntoView({ behavior: 'smooth', block: "start", inline: "nearest"}); // Scroll to the first header smoothly
  }
});
</script>
<div id="826d8159" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Import Statements</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Dataviz</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib <span class="im">as</span> mpl</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.ticker <span class="im">import</span> FuncFormatter</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.patches <span class="im">as</span> mpatches</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.colors <span class="im">import</span> LinearSegmentedColormap</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.patches <span class="im">import</span> Patch</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> adjustText <span class="im">import</span> adjust_text</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Geopatial</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shapely.geometry <span class="im">import</span> box</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> contextily <span class="im">as</span> cx</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pygris.utils</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pygris</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> osmnx <span class="im">as</span> ox</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="co"># IO</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> concurrent.futures <span class="im">import</span> ThreadPoolExecutor, as_completed</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm <span class="im">import</span> tqdm</span></code></pre></div>
</details>
</div>
<p>One of my favorite applications of Python is geospatial analysis. Python happens to have an amazing collection of GIS libraries that seem capable of doing almost any geospatial task I can imagine, from <a href="https://geopandas.org/en/stable/docs/user_guide/mapping.html">basic plots</a> to <a href="https://pysal.org/">spatial statistics</a> to <a href="https://geowombat.readthedocs.io/en/latest/">remote sensing</a> and more. I’m writing this blog post to give myself a brief overview of how I currently use several of those libraries for <strong>“thematic mapping”</strong> – plotting distributions of data across space <span class="citation" data-cites="tennekes_tmap_2018">(<a href="#ref-tennekes_tmap_2018" role="doc-biblioref">Tennekes 2018</a>)</span>. My main goal here is that I will have somewhere to go for boilerplate code/tutorials for myself, but hopefully an external reader gets some value out of it too.</p>
<p>I’ll cover the following:</p>
<ul>
<li>Some examples of Spatial Data: GTFS transit data, U.S. Census shape files, and dealing with Coordinate Reference Systems across different datasets.</li>
<li>Thematic Maps: I’ll cover plotting distributions across administrative boundaries and raster grids.</li>
<li>Zooming in and otherwise refining plots in <code>geopandas</code>.</li>
</ul>
<section id="question" class="level2">
<h2 class="anchored" data-anchor-id="question">Question</h2>
<p>I’ll base this post around a series of five exercises that get at the same basic question:</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Motivating Question">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Motivating Question
</div>
</div>
<div class="callout-body-container callout-body">
<p>How does the distribution of public transit stops in California vary by geography?</p>
</div>
</div>
<p>In the exercises, I’ll make maps that investigate the distribution at various geographic levels and in subregions within California.</p>
</section>
<section id="data" class="level2">
<h2 class="anchored" data-anchor-id="data">Data</h2>
<section id="gtfs-data-from-cal-itp" class="level3">
<h3 class="anchored" data-anchor-id="gtfs-data-from-cal-itp">GTFS Data from Cal ITP</h3>
<p>I will be using open data from CalTrans’ <a href="https://github.com/cal-itp/data-analyses/blob/main/high_quality_transit_areas/README.md">High Quality Transit Areas Analysis</a>. While that analysis is focused on defining high quality transit areas, they make their intermediary transit-stop dataset and high quality transit-stop datasets available to the public. Thanks, CalTrans!</p>
<p>The data that CalTrans are using are derived from “General Transit Feed Specification,” or, GTFS data. GTFS is a standardized data format that public transit agencies use to describe fixed-route transit services. It was initially developed in 2005 to provide support for public transit route planning in Google Maps <span class="citation" data-cites="barbeau_many_2015">(<a href="#ref-barbeau_many_2015" role="doc-biblioref">Barbeau and Antrim 2015</a>)</span>. The specific standards of GTFS are all documented at <a href="https://gtfs.org/getting-started/what-is-GTFS/">gtfs.org</a> and its complete history and many use cases are given an excellent overview in the previously cited <span class="citation" data-cites="barbeau_many_2015">(<a href="#ref-barbeau_many_2015" role="doc-biblioref">Barbeau and Antrim 2015</a>)</span> paper.</p>
<p>I’ll retrieve the CalTrans transit-stop data via parallel API requests (see the folded code for the details). This code should theoretically work with any ArcGIS Rest API.</p>
<div id="ac231b05" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>Code for parallel API calls: <code>paginate_api</code></summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fetch_gdf(url, offset, chunksize):</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    params <span class="op">=</span> {</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">"outFields"</span>: <span class="st">"*"</span>,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">"where"</span>: <span class="st">"1=1"</span>,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"f"</span>: <span class="st">"geojson"</span>,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"resultOffset"</span>: offset,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"resultRecordCount"</span>: chunksize,</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> requests.get(url, params<span class="op">=</span>params, timeout<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>        response.raise_for_status()</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> gpd.read_file(response.text)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Failed at offset </span><span class="sc">{</span>offset<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> gpd.GeoDataFrame()</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> paginate_api(url):</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    CHUNK_SIZE <span class="op">=</span> <span class="dv">2000</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    MAX_WORKERS <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get total record count</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    count_url <span class="op">=</span> url <span class="op">+</span> <span class="st">"?where=1=1&amp;returnCountOnly=true&amp;f=json"</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    max_records <span class="op">=</span> requests.get(count_url).json()[<span class="st">"count"</span>]</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Total records: </span><span class="sc">{</span>max_records<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    offsets <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">0</span>, max_records, CHUNK_SIZE))</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    gdfs <span class="op">=</span> []</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> ThreadPoolExecutor(max_workers<span class="op">=</span>MAX_WORKERS) <span class="im">as</span> executor:</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>        futures <span class="op">=</span> {</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>            executor.submit(fetch_gdf, url, offset, CHUNK_SIZE): offset</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> offset <span class="kw">in</span> offsets</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> future <span class="kw">in</span> tqdm(</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>            as_completed(futures), total<span class="op">=</span><span class="bu">len</span>(futures), desc<span class="op">=</span><span class="st">"Downloading"</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>        ):</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>            gdf <span class="op">=</span> future.result()</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>            gdfs.append(gdf)</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>    full_gdf <span class="op">=</span> gpd.GeoDataFrame(</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>        pd.concat(gdfs, ignore_index<span class="op">=</span><span class="va">True</span>), crs<span class="op">=</span>gdfs[<span class="dv">0</span>].crs <span class="cf">if</span> gdfs <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Final output</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Final GeoDataFrame shape: </span><span class="sc">{</span>full_gdf<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> full_gdf.shape[<span class="dv">0</span>] <span class="op">==</span> max_records</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> full_gdf</span></code></pre></div>
</details>
</div>
<div id="44decc28" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>rest_api <span class="op">=</span> <span class="st">"https://caltrans-gis.dot.ca.gov/arcgis/rest/"</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>all_stops <span class="op">=</span> <span class="st">"services/CHrailroad/CA_Transit_Stops/FeatureServer/0/query"</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>gdf_all <span class="op">=</span> paginate_api(rest_api <span class="op">+</span> all_stops)</span></code></pre></div>
</div>
<p>The resulting dataset contains each public transit stop in California, with various pieces of information about that stop.</p>
<div id="cbb716c9" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>gdf_all[[<span class="st">'district_name'</span>, <span class="st">'agency'</span>, <span class="st">'stop_id'</span>, <span class="st">'n_routes'</span>,</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>         <span class="st">'stop_name'</span>, <span class="st">'n_arrivals'</span>, <span class="st">'geometry'</span>]].head()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">district_name</th>
<th data-quarto-table-cell-role="th">agency</th>
<th data-quarto-table-cell-role="th">stop_id</th>
<th data-quarto-table-cell-role="th">n_routes</th>
<th data-quarto-table-cell-role="th">stop_name</th>
<th data-quarto-table-cell-role="th">n_arrivals</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>07 - Los Angeles / Ventura</td>
<td>City of Inglewood</td>
<td>3878454</td>
<td>1</td>
<td>Hillcrest Pharmacy</td>
<td>6</td>
<td>POINT (-118.35012 33.96022)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>07 - Los Angeles / Ventura</td>
<td>City of Inglewood</td>
<td>3878455</td>
<td>1</td>
<td>Social Security Office (230 E Spruce Ave)</td>
<td>6</td>
<td>POINT (-118.35137 33.95767)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>07 - Los Angeles / Ventura</td>
<td>City of Inglewood</td>
<td>3878456</td>
<td>1</td>
<td>Arbor Vitae / LaBrea</td>
<td>6</td>
<td>POINT (-118.35194 33.95264)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>07 - Los Angeles / Ventura</td>
<td>City of Inglewood</td>
<td>3878457</td>
<td>1</td>
<td>Hardy / Myrtle (Centinela Hospital)</td>
<td>6</td>
<td>POINT (-118.34874 33.94905)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>07 - Los Angeles / Ventura</td>
<td>City of Inglewood</td>
<td>3878458</td>
<td>1</td>
<td>Osage Senior Apartments</td>
<td>6</td>
<td>POINT (-118.34566 33.95134)</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>I noticed that a lot of geographic points that have a public transit stop are counted several times, perhaps to reflect different routes. I’m only interested in analyzing the distribution of unique physical transit stops without consideration of stop characteristics, so I drop duplicates based on geometry to get a unique geographic point for each transit stop.</p>
<div id="eea0e43b" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>gdf_all <span class="op">=</span> gdf_all.drop_duplicates(subset<span class="op">=</span><span class="st">'geometry'</span>)</span></code></pre></div>
</div>
<p>I always like to do quick quality checks on geospatial data via calls to <code>geopandas</code>’s <a href="https://geopandas.org/en/stable/docs/reference/api/geopandas.GeoDataFrame.explore.html"><code>.explore()</code> method</a>, which produces interactive plots in one line of code. I’ll look at the stops at San Pablo Ave. and Dwight Way in Berkeley, CA just to make sure everything looks as expected.</p>
<div id="5a5b27cf" class="cell" data-class-output="map" data-execution_count="14">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>gdf_all[gdf_all[<span class="st">'stop_name'</span>] <span class="op">==</span> <span class="st">'San Pablo Av &amp; Dwight Way'</span>].explore(</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    style_kwds<span class="op">=</span><span class="bu">dict</span>(fillOpacity<span class="op">=</span><span class="fl">0.7</span>, radius<span class="op">=</span><span class="dv">12</span>, color<span class="op">=</span><span class="st">'red'</span>), zoom_start<span class="op">=</span><span class="dv">17</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    )</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<div style="width:100%;"><div style="position:relative;width:100%;height:0;padding-bottom:60%;"><span style="color:#565656">Make this Notebook Trusted to load map: File -&gt; Trust Notebook</span><iframe srcdoc="<!DOCTYPE html>
<html>
<head>
    
    <meta http-equiv=&quot;content-type&quot; content=&quot;text/html; charset=UTF-8&quot; />
    <script src=&quot;https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js&quot;></script>
    <script src=&quot;https://code.jquery.com/jquery-3.7.1.min.js&quot;></script>
    <script src=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js&quot;></script>
    <script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js&quot;></script>
    <link rel=&quot;stylesheet&quot; href=&quot;https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css&quot;/>
    <link rel=&quot;stylesheet&quot; href=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css&quot;/>
    <link rel=&quot;stylesheet&quot; href=&quot;https://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css&quot;/>
    <link rel=&quot;stylesheet&quot; href=&quot;https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css&quot;/>
    <link rel=&quot;stylesheet&quot; href=&quot;https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css&quot;/>
    <link rel=&quot;stylesheet&quot; href=&quot;https://cdn.jsdelivr.net/gh/python-visualization/folium/folium/templates/leaflet.awesome.rotate.min.css&quot;/>
    
            <meta name=&quot;viewport&quot; content=&quot;width=device-width,
                initial-scale=1.0, maximum-scale=1.0, user-scalable=no&quot; />
            <style>
                #map_534a12ac38d2a22e97053c0230a1a79a {
                    position: relative;
                    width: 100.0%;
                    height: 100.0%;
                    left: 0.0%;
                    top: 0.0%;
                }
                .leaflet-container { font-size: 1rem; }
            </style>

            <style>html, body {
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }
            </style>

            <style>#map {
                position:absolute;
                top:0;
                bottom:0;
                right:0;
                left:0;
                }
            </style>

            <script>
                L_NO_TOUCH = false;
                L_DISABLE_3D = false;
            </script>

        
    
                    <style>
                        .foliumtooltip {
                            
                        }
                       .foliumtooltip table{
                            margin: auto;
                        }
                        .foliumtooltip tr{
                            text-align: left;
                        }
                        .foliumtooltip th{
                            padding: 2px; padding-right: 8px;
                        }
                    </style>
            
</head>
<body>
    
    
            <div class=&quot;folium-map&quot; id=&quot;map_534a12ac38d2a22e97053c0230a1a79a&quot; ></div>
        
</body>
<script>
    
    
            var map_534a12ac38d2a22e97053c0230a1a79a = L.map(
                &quot;map_534a12ac38d2a22e97053c0230a1a79a&quot;,
                {
                    center: [37.86113000021032, -122.28956450025885],
                    crs: L.CRS.EPSG3857,
                    ...{
  &quot;zoom&quot;: 17,
  &quot;zoomControl&quot;: true,
  &quot;preferCanvas&quot;: false,
}

                }
            );
            L.control.scale().addTo(map_534a12ac38d2a22e97053c0230a1a79a);

            

        
    
            var tile_layer_fc34df1e1b7f2b97d7fd04439ecb32af = L.tileLayer(
                &quot;https://tile.openstreetmap.org/{z}/{x}/{y}.png&quot;,
                {
  &quot;minZoom&quot;: 0,
  &quot;maxZoom&quot;: 19,
  &quot;maxNativeZoom&quot;: 19,
  &quot;noWrap&quot;: false,
  &quot;attribution&quot;: &quot;\u0026copy; \u003ca href=\&quot;https://www.openstreetmap.org/copyright\&quot;\u003eOpenStreetMap\u003c/a\u003e contributors&quot;,
  &quot;subdomains&quot;: &quot;abc&quot;,
  &quot;detectRetina&quot;: false,
  &quot;tms&quot;: false,
  &quot;opacity&quot;: 1,
}

            );
        
    
            tile_layer_fc34df1e1b7f2b97d7fd04439ecb32af.addTo(map_534a12ac38d2a22e97053c0230a1a79a);
        
    
        function geo_json_c554b4d6436ac649fae82b58bd63d7e3_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;red&quot;, &quot;fillOpacity&quot;: 0.7, &quot;radius&quot;: 12, &quot;weight&quot;: 2};
            }
        }
        function geo_json_c554b4d6436ac649fae82b58bd63d7e3_highlighter(feature) {
            switch(feature.id) {
                default:
                    return {&quot;fillOpacity&quot;: 0.75};
            }
        }
        function geo_json_c554b4d6436ac649fae82b58bd63d7e3_pointToLayer(feature, latlng) {
            var opts = {
  &quot;stroke&quot;: true,
  &quot;color&quot;: &quot;#3388ff&quot;,
  &quot;weight&quot;: 3,
  &quot;opacity&quot;: 1.0,
  &quot;lineCap&quot;: &quot;round&quot;,
  &quot;lineJoin&quot;: &quot;round&quot;,
  &quot;dashArray&quot;: null,
  &quot;dashOffset&quot;: null,
  &quot;fill&quot;: true,
  &quot;fillColor&quot;: &quot;#3388ff&quot;,
  &quot;fillOpacity&quot;: 0.2,
  &quot;fillRule&quot;: &quot;evenodd&quot;,
  &quot;bubblingMouseEvents&quot;: true,
  &quot;radius&quot;: 2,
};
            
            let style = geo_json_c554b4d6436ac649fae82b58bd63d7e3_styler(feature)
            Object.assign(opts, style)
            
            return new L.CircleMarker(latlng, opts)
        }

        function geo_json_c554b4d6436ac649fae82b58bd63d7e3_onEachFeature(feature, layer) {

            layer.on({
                mouseout: function(e) {
                    if(typeof e.target.setStyle === &quot;function&quot;){
                            geo_json_c554b4d6436ac649fae82b58bd63d7e3.resetStyle(e.target);
                    }
                },
                mouseover: function(e) {
                    if(typeof e.target.setStyle === &quot;function&quot;){
                        const highlightStyle = geo_json_c554b4d6436ac649fae82b58bd63d7e3_highlighter(e.target.feature)
                        e.target.setStyle(highlightStyle);
                    }
                },
            });
        };
        var geo_json_c554b4d6436ac649fae82b58bd63d7e3 = L.geoJson(null, {
                onEachFeature: geo_json_c554b4d6436ac649fae82b58bd63d7e3_onEachFeature,
            
                style: geo_json_c554b4d6436ac649fae82b58bd63d7e3_styler,
                pointToLayer: geo_json_c554b4d6436ac649fae82b58bd63d7e3_pointToLayer,
            ...{
}
        });

        function geo_json_c554b4d6436ac649fae82b58bd63d7e3_add (data) {
            geo_json_c554b4d6436ac649fae82b58bd63d7e3
                .addData(data);
        }
            geo_json_c554b4d6436ac649fae82b58bd63d7e3_add({&quot;bbox&quot;: [-122.28958300016382, 37.86079400026471, -122.2895460003539, 37.861466000155936], &quot;features&quot;: [{&quot;bbox&quot;: [-122.2895460003539, 37.861466000155936, -122.2895460003539, 37.861466000155936], &quot;geometry&quot;: {&quot;coordinates&quot;: [-122.2895460003539, 37.861466000155936], &quot;type&quot;: &quot;Point&quot;}, &quot;id&quot;: &quot;69776&quot;, &quot;properties&quot;: {&quot;OBJECTID&quot;: 69777, &quot;agency&quot;: &quot;Alameda-Contra Costa Transit District&quot;, &quot;base64_url&quot;: &quot;aHR0cHM6Ly9hcGkuNTExLm9yZy90cmFuc2l0L2RhdGFmZWVkcz9vcGVyYXRvcl9pZD1BQw==&quot;, &quot;district_name&quot;: &quot;04 - Bay Area / Oakland&quot;, &quot;meters_to_ca_state_highway&quot;: 7.7, &quot;n_arrivals&quot;: 143, &quot;n_hours_in_service&quot;: 24, &quot;n_routes&quot;: 4, &quot;org_id&quot;: &quot;recOZgevYf7Jimm9L&quot;, &quot;route_ids_served&quot;: &quot;72, 72M, 72R, 802&quot;, &quot;routetypes&quot;: &quot;3&quot;, &quot;stop_id&quot;: &quot;55880&quot;, &quot;stop_name&quot;: &quot;San Pablo Av \u0026 Dwight Way&quot;}, &quot;type&quot;: &quot;Feature&quot;}, {&quot;bbox&quot;: [-122.28958300016382, 37.86079400026471, -122.28958300016382, 37.86079400026471], &quot;geometry&quot;: {&quot;coordinates&quot;: [-122.28958300016382, 37.86079400026471], &quot;type&quot;: &quot;Point&quot;}, &quot;id&quot;: &quot;69792&quot;, &quot;properties&quot;: {&quot;OBJECTID&quot;: 69793, &quot;agency&quot;: &quot;Alameda-Contra Costa Transit District&quot;, &quot;base64_url&quot;: &quot;aHR0cHM6Ly9hcGkuNTExLm9yZy90cmFuc2l0L2RhdGFmZWVkcz9vcGVyYXRvcl9pZD1BQw==&quot;, &quot;district_name&quot;: &quot;04 - Bay Area / Oakland&quot;, &quot;meters_to_ca_state_highway&quot;: 1.5, &quot;n_arrivals&quot;: 145, &quot;n_hours_in_service&quot;: 24, &quot;n_routes&quot;: 4, &quot;org_id&quot;: &quot;recOZgevYf7Jimm9L&quot;, &quot;route_ids_served&quot;: &quot;72, 72M, 72R, 802&quot;, &quot;routetypes&quot;: &quot;3&quot;, &quot;stop_id&quot;: &quot;57755&quot;, &quot;stop_name&quot;: &quot;San Pablo Av \u0026 Dwight Way&quot;}, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
    geo_json_c554b4d6436ac649fae82b58bd63d7e3.bindTooltip(
    function(layer){
    let div = L.DomUtil.create('div');
    
    let handleObject = feature => {
        if (feature === null) {
            return '';
        } else if (typeof(feature)=='object') {
            return JSON.stringify(feature);
        } else {
            return feature;
        }
    }
    let fields = [&quot;OBJECTID&quot;, &quot;org_id&quot;, &quot;agency&quot;, &quot;stop_id&quot;, &quot;stop_name&quot;, &quot;n_routes&quot;, &quot;route_ids_served&quot;, &quot;routetypes&quot;, &quot;n_arrivals&quot;, &quot;n_hours_in_service&quot;, &quot;meters_to_ca_state_highway&quot;, &quot;base64_url&quot;, &quot;district_name&quot;];
    let aliases = [&quot;OBJECTID&quot;, &quot;org_id&quot;, &quot;agency&quot;, &quot;stop_id&quot;, &quot;stop_name&quot;, &quot;n_routes&quot;, &quot;route_ids_served&quot;, &quot;routetypes&quot;, &quot;n_arrivals&quot;, &quot;n_hours_in_service&quot;, &quot;meters_to_ca_state_highway&quot;, &quot;base64_url&quot;, &quot;district_name&quot;];
    let table = '<table>' +
        String(
        fields.map(
        (v,i)=>
        `<tr>
            <th>${aliases[i]}</th>
            
            <td>${handleObject(layer.feature.properties[v])}</td>
        </tr>`).join(''))
    +'</table>';
    div.innerHTML=table;
    
    return div
    }
    ,{
  &quot;sticky&quot;: true,
  &quot;className&quot;: &quot;foliumtooltip&quot;,
});
                     
    
            geo_json_c554b4d6436ac649fae82b58bd63d7e3.addTo(map_534a12ac38d2a22e97053c0230a1a79a);
        
</script>
</html>" style="position:absolute;width:100%;height:100%;left:0;top:0;border:none !important;" allowfullscreen="" webkitallowfullscreen="" mozallowfullscreen=""></iframe></div></div>
</div>
</div>
<p>Looks about how I’d expect! Now, returning to the motivating question:</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Motivating Question">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Motivating Question
</div>
</div>
<div class="callout-body-container callout-body">
<p>How does the distribution of public transit stops in California vary by geography?</p>
</div>
</div>
<p>We now have public transit stop data, but to answer this question we also need to be able to place those stops within geographies, defined broadly. For that, I’ll go to the census’ shapefile database.</p>
</section>
<section id="census-shapes-with-tigrispygris" class="level3">
<h3 class="anchored" data-anchor-id="census-shapes-with-tigrispygris">Census shapes with <code>tigris</code>/<code>pygris</code></h3>
<p>In my experience it’s rare that Census data are <strong>not</strong> essential to doing geospatial analysis within the U.S. I’m making plots of transit stops within California, so I will want the administrative boundaries of California and its counties to contextualize those stops. That means I need <a href="https://en.wikipedia.org/wiki/Shapefile">shapefiles</a> for states and counties, which the Census maintains.</p>
<div class="callout callout-style-default callout-note callout-titled" title="Census data and Kyle Walker">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Census data and Kyle Walker
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The universe of Census data – shapefiles and survey data – is large and confusing. Thankfully, a few extremely generous organizations and individuals have undertaken the herculean task of developing open source tools and documentation to make census data easy. I’ve blogged elsewhere about <a href="https://www.ipums.org/">IPUMS</a> and <a href="https://mcdc.missouri.edu/applications/geocorr.html">Geocorr</a>, but here I’m going to highlight some of the work of <a href="https://walker-data.com/">Kyle Walker</a>.</p>
<p>Whenever I need a reference on aggregate Census data or mapping, I turn to <a href="https://walker-data.com/census-r/">“Analyzing U.S. Census Data” by Kyle Walker</a>, <span class="citation" data-cites="walker_analyzing_2023">(<a href="#ref-walker_analyzing_2023" role="doc-biblioref">Walker 2023</a>)</span>. The book and accompanying geospatial libraries are written for R users, but almost all of the material applies directly in python, and the author has created python ports or else blog posts with python code that cover much of the material. In practice his libraries are so good that when there isn’t a direct python port for one of his R packages (e.g.&nbsp;tidycensus), I take the trouble of using R just for that package.</p>
</div>
</div>
</div>
<p>Census shapefiles are maintained in the Census’ <a href="https://www.census.gov/geographies/mapping-files/time-series/geo/tiger-geodatabase-file.html">TIGER/Line geodatabase</a>, which contains the shapes of basically any administrative or political boundary you could think of within the U.S. One can download files via the census’ <a href="https://www2.census.gov/geo/tiger/">FTP archive</a> (I’ve unfortunately <a href="https://github.com/peter-amerkhanian/sf-schools-simulation/blob/main/build_city.py">written code</a> to do this in the past), but it’s much easier to just use the excellent <a href="https://github.com/walkerke/tigris"><code>tigris</code></a>/<a href="https://walker-data.com/pygris/"><code>pygris</code></a> package that Kyle Walker developed for simplifying access to TIGER/Line shapefiles <span class="citation" data-cites="walker_tigris_2025">(<a href="#ref-walker_tigris_2025" role="doc-biblioref">Walker 2025</a>)</span>.</p>
<p>Using <code>tigris</code>/<code>pygris</code> is very simple – I just call the <code>states()</code> function<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> for a given year, and it will return the outlines of every state in the U.S. as set in 2024 (note that the boundaries typically do not change for states, but they do change for some smaller geographies). More information about the use of <code>tigris</code> is available in <span class="citation" data-cites="walker_analyzing_2023">(<a href="#ref-walker_analyzing_2023" role="doc-biblioref">Walker 2023, chap. 5</a>)</span>.</p>
<div id="1f31a346" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>state_shapes <span class="op">=</span> pygris.states(cache<span class="op">=</span><span class="va">True</span>, year<span class="op">=</span><span class="dv">2024</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>state_shapes.head(<span class="dv">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">STATEFP</th>
<th data-quarto-table-cell-role="th">STATENS</th>
<th data-quarto-table-cell-role="th">GEOIDFQ</th>
<th data-quarto-table-cell-role="th">GEOID</th>
<th data-quarto-table-cell-role="th">STUSPS</th>
<th data-quarto-table-cell-role="th">NAME</th>
<th data-quarto-table-cell-role="th">LSAD</th>
<th data-quarto-table-cell-role="th">ALAND</th>
<th data-quarto-table-cell-role="th">AWATER</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>35</td>
<td>00897535</td>
<td>0400000US35</td>
<td>35</td>
<td>NM</td>
<td>New Mexico</td>
<td>00</td>
<td>314198519809</td>
<td>726531289</td>
<td>POLYGON ((-109.05017 31.48, -109.04984 31.4995...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>46</td>
<td>01785534</td>
<td>0400000US46</td>
<td>46</td>
<td>SD</td>
<td>South Dakota</td>
<td>00</td>
<td>196341670967</td>
<td>3387563375</td>
<td>POLYGON ((-104.05788 44.9976, -104.05078 44.99...</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Here’s just California:</p>
<div id="50695242" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>california <span class="op">=</span> state_shapes[state_shapes[<span class="st">"GEOID"</span>] <span class="op">==</span> <span class="st">"06"</span>]</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>california <span class="op">=</span> california.set_index(<span class="st">"NAME"</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>california</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">STATEFP</th>
<th data-quarto-table-cell-role="th">STATENS</th>
<th data-quarto-table-cell-role="th">GEOIDFQ</th>
<th data-quarto-table-cell-role="th">GEOID</th>
<th data-quarto-table-cell-role="th">STUSPS</th>
<th data-quarto-table-cell-role="th">LSAD</th>
<th data-quarto-table-cell-role="th">ALAND</th>
<th data-quarto-table-cell-role="th">AWATER</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">NAME</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">California</td>
<td>06</td>
<td>01779778</td>
<td>0400000US06</td>
<td>06</td>
<td>CA</td>
<td>00</td>
<td>403673433805</td>
<td>20291632828</td>
<td>MULTIPOLYGON (((-118.60442 33.47855, -118.5987...</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>I’ll do the same with <code>counties()</code>, retrieving the boundaries for all of the counties within California (<code>state="06"</code>) in 2024.</p>
<div id="40d5470c" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>county_shapes <span class="op">=</span> pygris.counties(state<span class="op">=</span><span class="st">"06"</span>, year<span class="op">=</span><span class="st">'2024'</span>, cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>county_shapes[[<span class="st">'NAMELSAD'</span>, <span class="st">'geometry'</span>]].head()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">NAMELSAD</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>Sierra County</td>
<td>POLYGON ((-120.55587 39.50874, -120.55614 39.5...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">324</td>
<td>Sacramento County</td>
<td>POLYGON ((-121.43991 38.25553, -121.44002 38.2...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">328</td>
<td>Santa Barbara County</td>
<td>MULTIPOLYGON (((-120.58226 34.10752, -120.5790...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">345</td>
<td>Calaveras County</td>
<td>POLYGON ((-120.6318 38.34603, -120.63066 38.34...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">393</td>
<td>Ventura County</td>
<td>MULTIPOLYGON (((-119.63607 33.28071, -119.6348...</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>When we plot them together, it looks like we have the administrative boundaries we wanted.</p>
<div id="615e6768" class="cell" data-execution_count="18">
<details class="code-fold">
<summary>Plot Code: Counties and States from <code>pygris</code></summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">5</span>, <span class="dv">3</span>))</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].<span class="bu">set</span>(title<span class="op">=</span><span class="st">"Counties"</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_axis_off()</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].<span class="bu">set</span>(title<span class="op">=</span><span class="st">"State"</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_axis_off()</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>county_shapes.plot(facecolor<span class="op">=</span><span class="st">"none"</span>, ax<span class="op">=</span>ax[<span class="dv">0</span>])</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>california.plot(facecolor<span class="op">=</span><span class="st">"none"</span>, ax<span class="op">=</span>ax[<span class="dv">1</span>])<span class="op">;</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-11-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="dealing-with-coordinate-reference-systems" class="level3">
<h3 class="anchored" data-anchor-id="dealing-with-coordinate-reference-systems">Dealing with Coordinate Reference Systems</h3>
<p><img src="spherical.webp" class="img-fluid"></p>
<p>Geospatial datasets typically come with a set <strong>coordinate reference system</strong> (CRS), which defines how locations in the real world are represented as coordinates in the data. This may sound trivial, but given the imperfect spherical shape of the earth, defining a usable coordinate reference system is quite complex and systems aren’t one-size-fits-all. There are global CRS, CRS optimized for certain regions, and CRS optimized for distance calculations <span class="citation" data-cites="kennedy_understanding_2000">(<a href="#ref-kennedy_understanding_2000" role="doc-biblioref">Kennedy and Kopp 2000</a>)</span>.</p>
<p>For reference, here are all of the CRS that I will use in this post:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Purpose</th>
<th>CRS Name</th>
<th>EPSG</th>
<th>Type</th>
<th>Units</th>
<th>Region</th>
<th>Organizations / Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Plotting</td>
<td><a href="https://en.wikipedia.org/wiki/World_Geodetic_System#WGS84">WGS 84</a></td>
<td>4326</td>
<td>Geographic</td>
<td>Degrees</td>
<td>Global</td>
<td>Used globally for web and GPS data, published and maintained by the U.S. Department of Defense.</td>
</tr>
<tr class="even">
<td>Plotting</td>
<td><a href="https://en.wikipedia.org/wiki/North_American_Datum#">NAD83</a></td>
<td>4269</td>
<td>Geographic</td>
<td>Degrees</td>
<td>North America</td>
<td>US Census Bureau, USGS; preferred for U.S. datasets</td>
</tr>
<tr class="odd">
<td>Spatial Analysis</td>
<td>NAD83 / California Albers</td>
<td>3310</td>
<td>Projected</td>
<td>Meters</td>
<td>California</td>
<td>CA state agencies, minimizes distortion across the state</td>
</tr>
</tbody>
</table>
<div id="463437c0" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>WGS_84 <span class="op">=</span> <span class="st">"EPSG:4326"</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>NAD_CRS <span class="op">=</span> <span class="st">"EPSG:4269"</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>CA_ALBERS_CRS <span class="op">=</span> <span class="st">"EPSG:3310"</span></span></code></pre></div>
</div>
<p>The public transit stop data from the CalTrans come in a common and versatile CRS, <a href="https://en.wikipedia.org/wiki/World_Geodetic_System#WGS84">World Geodetic System (WGS) 84</a>, also known as <a href="https://epsg.io/4326?utm_source=chatgpt.com"><code>EPSG:4326</code></a>. Many global or multi-national datasets use <strong>WGS 84</strong>, including the Google Earth service. WGS84 is “geodetic,” meaning that distance is measured in longitudinal/latitudinal degrees. This is problematic for distance measurement and we’ll touch on that more in Exercise 4.</p>
<div id="f852f5e9" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>gdf_all.crs</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>&lt;Geographic 2D CRS: EPSG:4326&gt;
Name: WGS 84
Axis Info [ellipsoidal]:
- Lat[north]: Geodetic latitude (degree)
- Lon[east]: Geodetic longitude (degree)
Area of Use:
- name: World.
- bounds: (-180.0, -90.0, 180.0, 90.0)
Datum: World Geodetic System 1984 ensemble
- Ellipsoid: WGS 84
- Prime Meridian: Greenwich</code></pre>
</div>
</div>
<p>U.S. Census TIGER/Line data typically use <a href="https://en.wikipedia.org/wiki/North_American_Datum">North American Datum (NAD) 83</a>, EPSG code <a href="https://epsg.io/4269"><code>4269</code></a>. <strong>NAD83</strong> is commonly used by U.S. Federal Agencies and, like WGS84, it is “geodetic” and measures distance in degrees. Unlike WGS84, NAD83 is optimized for geographic accuracy within the United States.</p>
<div id="aacda072" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> california.crs <span class="op">==</span> county_shapes.crs</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>california.crs</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>&lt;Geographic 2D CRS: EPSG:4269&gt;
Name: NAD83
Axis Info [ellipsoidal]:
- Lat[north]: Geodetic latitude (degree)
- Lon[east]: Geodetic longitude (degree)
Area of Use:
- name: North America - onshore and offshore: Canada - Alberta; British Columbia; Manitoba; New Brunswick; Newfoundland and Labrador; Northwest Territories; Nova Scotia; Nunavut; Ontario; Prince Edward Island; Quebec; Saskatchewan; Yukon. Puerto Rico. United States (USA) - Alabama; Alaska; Arizona; Arkansas; California; Colorado; Connecticut; Delaware; Florida; Georgia; Hawaii; Idaho; Illinois; Indiana; Iowa; Kansas; Kentucky; Louisiana; Maine; Maryland; Massachusetts; Michigan; Minnesota; Mississippi; Missouri; Montana; Nebraska; Nevada; New Hampshire; New Jersey; New Mexico; New York; North Carolina; North Dakota; Ohio; Oklahoma; Oregon; Pennsylvania; Rhode Island; South Carolina; South Dakota; Tennessee; Texas; Utah; Vermont; Virginia; Washington; West Virginia; Wisconsin; Wyoming. US Virgin Islands. British Virgin Islands.
- bounds: (167.65, 14.92, -40.73, 86.45)
Datum: North American Datum 1983
- Ellipsoid: GRS 1980
- Prime Meridian: Greenwich</code></pre>
</div>
</div>
<p>When working with multiple datasets, it’s important to ensure that they share the same CRS. In GeoPandas, CRS alignment and conversion are straightforward. I’d like to work in the CRS provided by the U.S. Census – NAD83. I use simple variable assignment in python to bring the stops dataset (currently in WGS84) into NAD83.</p>
<div id="b1b52167" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>target_crs <span class="op">=</span> california.crs</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>gdf_all.crs <span class="op">=</span> target_crs</span></code></pre></div>
</div>
<div id="328773ff" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> gdf_all.crs <span class="op">==</span> california.crs</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(gdf_all.crs, <span class="st">"=="</span>, california.crs)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>EPSG:4269 == EPSG:4269</code></pre>
</div>
</div>
<p>Now that I have both the California shapefile and the public transit stops in the same CRS, I can start to use them together. First, I’ll do a spatial join – I’ll filter the public transit stops down to only those that are within the California shapefile.</p>
<div id="9d723bbc" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>gdf_ca <span class="op">=</span> gdf_all.copy().sjoin(california, how<span class="op">=</span><span class="st">"inner"</span>, predicate<span class="op">=</span><span class="st">"within"</span>)</span></code></pre></div>
</div>
<p>With the preliminary data processing complete, I’ll now move into a series of five thematic mapping exercises to examine the distribution of public transit stops.</p>
</section>
</section>
<section id="exercise-1-point-plot-pros-and-cons" class="level2">
<h2 class="anchored" data-anchor-id="exercise-1-point-plot-pros-and-cons">Exercise 1: Point Plot Pros and Cons</h2>
<p>Sometimes, a simple point plot – where we simply lay out the raw data as points over a map – is the best thematic map for the job. Consider a canonical example</p>
<p><img src="seaman.png" class="img-fluid" style="width:50.0%"></p>
<p>As a first exercise, I’ll make of the simplest thematic map – I’ll just plot all of the public transit stops as points over the California shapefile.</p>
<div id="5d8db0cf" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">4</span>, <span class="dv">5</span>))</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> california.crs <span class="op">==</span> gdf_ca.crs</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>california.plot(ax<span class="op">=</span>ax, edgecolor<span class="op">=</span><span class="st">"grey"</span>, facecolor<span class="op">=</span><span class="st">"none"</span>,</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>                linewidth<span class="op">=</span><span class="dv">1</span>, zorder<span class="op">=-</span><span class="dv">1</span>, alpha<span class="op">=</span><span class="fl">.5</span>)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>gdf_ca.plot(ax<span class="op">=</span>ax, markersize<span class="op">=</span><span class="fl">1.5</span>, alpha<span class="op">=</span><span class="fl">0.2</span>, edgecolor<span class="op">=</span><span class="st">"none"</span>, linewidth<span class="op">=</span><span class="fl">0.05</span>)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>ax.axis(<span class="st">"off"</span>)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>fig.tight_layout()</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-18-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Looks good, but how does it do for answering our motivating question?</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Motivating Question">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Motivating Question
</div>
</div>
<div class="callout-body-container callout-body">
<p>How does the distribution of public transit stops in California vary by geography?</p>
</div>
</div>
<p>One can pick out the basic pattern that urban California has a lot of transit stops and rural California doesn’t, but point plots like this can be difficult to use when you have very dense clusters of points on top of or else very close to each other. The more fine grained distribution of the points is completely obscured.</p>
<p>We typically solve this issue by <strong>aggregating</strong> the data into larger units then visualizing the aggregates of points rather than individual points. This sounds abstract, so consider a concrete example – Jon Snow’s famous 1854 map of cholera cases in London.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption>Zooming in on a section of <span class="citation" data-cites="john_snow_mode_1854">(<a href="#ref-john_snow_mode_1854" role="doc-biblioref">John Snow 1854</a>)</span>, we see the author used stacked rectangular bars to aggregate cholera cases to single addresses</figcaption>
<p><img src="snow_zoom.png" class="img-fluid figure-img" style="width:75.0%"></p>
</figure>
</div>
<p>I’d like to go deeper and explore how aggregating stops into larger geographies helps pick out different trends.</p>
</section>
<section id="exercise-2-county-choropleths" class="level2">
<h2 class="anchored" data-anchor-id="exercise-2-county-choropleths">Exercise 2: County Choropleths</h2>
<p>One very common geospatial data product is the choropleth map. Choropleth maps communicate how the density of some data or else another quantity that describes that data varies across administrative units, like countries, states, provinces, etc. The data are grouped into the administrative units, and the aggregate value for each unit is depicted in the map via color intensity/hue/saturation <span class="citation" data-cites="tennekes_tmap_2018">(<a href="#ref-tennekes_tmap_2018" role="doc-biblioref">Tennekes 2018</a>)</span>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption>Charles Dupin’s 1826 choropleth, <span class="citation" data-cites="charles_dupin_carte_1826">(<a href="#ref-charles_dupin_carte_1826" role="doc-biblioref">Charles Dupin 1826</a>)</span>, depicting the availability of basic education in France is believed to be the earliest known choropleth map <span class="citation" data-cites="friendly_milestones_2000">(<a href="#ref-friendly_milestones_2000" role="doc-biblioref">Friendly 2000</a>)</span></figcaption>
<p><img src="choropleth.jpg" class="img-fluid figure-img" style="width:50.0%"></p>
</figure>
</div>
<p>We are going to build a choropleth showing how many public transit stops there are in each county in California. In preparation, I’ll get some general plotting functions set up.</p>
<div id="d6e0068a" class="cell" data-execution_count="26">
<details class="code-fold">
<summary>Some custom plotting code/functions: <code>build_cmap</code>, <code>number_suffix_formatter</code></summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">"font.family"</span>] <span class="op">=</span> <span class="st">"Arial"</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_cmap(</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    mpl_name: <span class="bu">str</span> <span class="op">=</span> <span class="st">"coolwarm"</span>,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    start: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.0</span>,</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    end: <span class="bu">float</span> <span class="op">=</span> <span class="fl">1.0</span>,</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    int_gran: <span class="bu">int</span> <span class="op">=</span> <span class="dv">1000</span>,</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> LinearSegmentedColormap:</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Create a customized linear colormap by truncating an existing Matplotlib colormap.</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="co">    mpl_name : str, default="coolwarm"</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a><span class="co">        The name of a Matplotlib colormap. See the full list at:</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a><span class="co">        https://matplotlib.org/stable/gallery/color/colormap_reference.html</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a><span class="co">    start : float, default=0</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a><span class="co">        The starting position in the original colormap's range [0, 1].</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a><span class="co">    int_gran : int, default=1000</span></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a><span class="co">        The number of discrete color samples to generate from the truncated colormap.</span></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a><span class="co">        Higher values yield smoother gradients.</span></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a><span class="co">    LinearSegmentedColormap</span></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a><span class="co">        A new colormap instance truncated from the original, beginning at `start`.</span></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a><span class="co">    Raises</span></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a><span class="co">    ------</span></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a><span class="co">    AssertionError</span></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a><span class="co">        If `start` is not between 0 and 1 (inclusive).</span></span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a><span class="co">    Examples</span></span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; cmap = build_cmap("viridis", start=0.2)</span></span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; plt.imshow(data, cmap=cmap)</span></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> (start <span class="op">&lt;=</span> <span class="dv">1</span>) <span class="op">&amp;</span> (start <span class="op">&gt;=</span> <span class="dv">0</span>), <span class="st">"start must be real number in [0, 1]"</span></span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>    cmap <span class="op">=</span> mpl.colormaps.get_cmap(mpl_name)</span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>    new_cmap <span class="op">=</span> LinearSegmentedColormap.from_list(</span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>        <span class="st">"deep_reds"</span>, cmap(np.linspace(start, end, int_gran))</span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> new_cmap</span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> number_suffix_formatter(x, pos<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a><span class="co">    Formats numbers using k (thousand) and m (million) suffixes.</span></span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a><span class="co">        x (float or int): Number to format.</span></span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a><span class="co">        pos: Ignored, included for compatibility with matplotlib's FuncFormatter.</span></span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a><span class="co">        str: Formatted string.</span></span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a>    thresholds <span class="op">=</span> [</span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a>        (<span class="fl">1e9</span>, <span class="st">'b'</span>),</span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a>        (<span class="fl">1e6</span>, <span class="st">'m'</span>),</span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a>        (<span class="fl">1e3</span>, <span class="st">'k'</span>),</span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> threshold, suffix <span class="kw">in</span> thresholds:</span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> x <span class="op">&gt;=</span> threshold:</span>
<span id="cb21-65"><a href="#cb21-65" aria-hidden="true" tabindex="-1"></a>            value <span class="op">=</span> x <span class="op">/</span> threshold</span>
<span id="cb21-66"><a href="#cb21-66" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="ss">f"</span><span class="sc">{</span>value<span class="sc">:.1f}{</span>suffix<span class="sc">}</span><span class="ss">"</span> <span class="cf">if</span> x <span class="op">%</span> threshold <span class="cf">else</span> <span class="ss">f"</span><span class="sc">{</span><span class="bu">int</span>(value)<span class="sc">}{</span>suffix<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb21-67"><a href="#cb21-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">str</span>(<span class="bu">int</span>(x))</span></code></pre></div>
</details>
</div>
<p>The first step of making our choropleth is going to be aggregating the public transit stops (<code>Point</code> data) within counties (<code>Polygon</code> data). Here’s an abstract representation of the problem – we want to count the “Inside Points” for each county shape.</p>
<div id="b0a95efa" class="cell" data-execution_count="27">
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption>Points within a polygon (image by author)</figcaption>
<p><img src="index_files/figure-html/cell-20-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Here’s a custom <code>points_in_polygon()</code> function that will count up the number of points from one gdf, <code>point_gdf</code> that are within the shape from another gdf, <code>polygon_gdf</code>. There’s an optional weight variable that I won’t be using.</p>
<div id="da413080" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> points_in_polygon(</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    point_gdf: gpd.GeoDataFrame,</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    polygon_gdf: gpd.GeoDataFrame,</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    group_var: <span class="bu">str</span>,</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    weight_var: <span class="bu">str</span> <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> gpd.GeoDataFrame:</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> point_gdf.crs <span class="op">==</span> polygon_gdf.crs, <span class="ss">f"</span><span class="sc">{</span>point_gdf<span class="sc">.</span>crs<span class="sc">}</span><span class="ss"> != </span><span class="sc">{</span>polygon_gdf<span class="sc">.</span>crs<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    joined <span class="op">=</span> point_gdf.sjoin(polygon_gdf, how<span class="op">=</span><span class="st">"inner"</span>, predicate<span class="op">=</span><span class="st">"within"</span>)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> weight_var:</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>        agg <span class="op">=</span> joined.groupby(group_var)[weight_var].<span class="bu">sum</span>().to_frame(</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"</span><span class="sc">{</span>weight_var<span class="sc">}</span><span class="ss">_sum"</span>)</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> polygon_gdf.copy()</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> result.merge(agg, left_on<span class="op">=</span>group_var,</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>                              right_index<span class="op">=</span><span class="va">True</span>, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>        counts <span class="op">=</span> joined.groupby(group_var).size().to_frame(<span class="st">"count"</span>)</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> polygon_gdf.copy()</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> result.merge(counts, left_on<span class="op">=</span>group_var,</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>                              right_index<span class="op">=</span><span class="va">True</span>, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span></code></pre></div>
</div>
<p>You can see that the logic is based on spatially merging the points with the polygons based on whether points fall “within” polygons, then I group by the polygon identifier and count up how many points there are within each. When we run that with the transit stops and counties, we get the following, where NaN represents a county having no public transit stops.</p>
<div id="e48ed409" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>county_agg <span class="op">=</span> points_in_polygon(gdf_all, county_shapes, group_var<span class="op">=</span><span class="st">"NAME"</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>county_agg[[<span class="st">'NAME'</span>, <span class="st">'count'</span>]].head()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">NAME</th>
<th data-quarto-table-cell-role="th">count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>Sierra</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">324</td>
<td>Sacramento</td>
<td>3121.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">328</td>
<td>Santa Barbara</td>
<td>986.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">345</td>
<td>Calaveras</td>
<td>19.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">393</td>
<td>Ventura</td>
<td>1292.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>With that aggregated data, I can now make a choropleth of transit stops across counties. Before making the final plot, I’ll define various stylings for the map in the following folded code block. I often like to define parameters for <code>geopandas</code> plots in dictionaries so that I can reuse styles across different plots.</p>
<div id="318ac889" class="cell" data-execution_count="30">
<details class="code-fold">
<summary>Plot Styling: <code>new_cmap</code>, <code>missing_fill_kws</code>, <code>borders_kws</code>, <code>data_fill_kws</code></summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Legend</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>new_cmap <span class="op">=</span> build_cmap(<span class="st">"YlOrRd"</span>, start<span class="op">=</span><span class="dv">0</span>, end<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>legend_cbar_kws <span class="op">=</span> {</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"format"</span>: FuncFormatter(number_suffix_formatter),</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"shrink"</span>: <span class="fl">0.8</span>,</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"label"</span>: <span class="st">"Number of Public Transit Stops"</span>,</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"location"</span>: <span class="st">"top"</span>,</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pad"</span>: <span class="fl">0.01</span>,</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="co"># General County Style</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>borders_kws <span class="op">=</span> {<span class="st">"edgecolor"</span>: <span class="st">"grey"</span>, <span class="st">"linewidth"</span>: <span class="fl">0.3</span>}</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>data_fill_kws <span class="op">=</span> {<span class="st">"alpha"</span>: <span class="dv">1</span>, <span class="st">"cmap"</span>: new_cmap}</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Missing County Style</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>missing_fill_kws <span class="op">=</span> {<span class="st">"hatch"</span>: <span class="st">"////"</span>, <span class="st">"facecolor"</span>: <span class="st">"none"</span>}</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>missing_patch <span class="op">=</span> Patch(<span class="op">**</span>borders_kws, <span class="op">**</span>missing_fill_kws, label<span class="op">=</span><span class="st">"County w/ no stops"</span>)</span></code></pre></div>
</details>
</div>
<p>You can pass the style dictionaries directly into the plotting functions as keyword arguments, which you can see below with <code>**missing_fill_kws</code>, <code>**borders_kws</code>, and <code>**data_fill_kws</code>.</p>
<div id="62189676" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">4</span>, <span class="dv">6</span>))</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>county_agg <span class="op">=</span> points_in_polygon(gdf_all, county_shapes, group_var<span class="op">=</span><span class="st">"NAME"</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>county_agg.plot(</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    column<span class="op">=</span><span class="st">"count"</span>,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">**</span>borders_kws,</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">**</span>data_fill_kws,</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    legend<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    legend_kwds<span class="op">=</span>legend_cbar_kws,</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>county_agg[county_agg[<span class="st">"count"</span>].isna()].plot(<span class="op">**</span>missing_fill_kws, <span class="op">**</span>borders_kws, ax<span class="op">=</span>ax)</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>ax.legend(handles<span class="op">=</span>[missing_patch], fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>ax.axis(<span class="st">"off"</span>)</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>fig.tight_layout()</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-24-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Looks like Los Angeles has a lot of public transit stops.</p>
</section>
<section id="exercise-3-a-region-choropleth" class="level2">
<h2 class="anchored" data-anchor-id="exercise-3-a-region-choropleth">Exercise 3: A Region Choropleth</h2>
<p>To provide additional perspective, we’re going to make another choropleth using a different geographic unit. I’d like to get a look at how stop availability differs across larger regions, such as the San Francisco Bay Area, Los Angeles, the Central Valley, etc. I don’t have a regions dataset, but I do have a counties dataset and regions are typically made up of counties, so this will be an opportunity to try combining smaller geographies into larger, custom geographies.</p>
<p>In the following folded code chunk I’ll define a mapping of counties to regions based on <a href="https://census.ca.gov/regions/">regions defined for 2020 Census outreach in California</a>:</p>
<div id="6e85e041" class="cell" data-execution_count="32">
<details class="code-fold">
<summary>California County → Region Mappings, <code>county_to_region</code></summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># https://census.ca.gov/regions/</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>county_to_region <span class="op">=</span> {</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Butte"</span>: <span class="st">"Superior California"</span>,</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Colusa"</span>: <span class="st">"Superior California"</span>,</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"El Dorado"</span>: <span class="st">"Superior California"</span>,</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Glenn"</span>: <span class="st">"Superior California"</span>,</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Lassen"</span>: <span class="st">"Superior California"</span>,</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Modoc"</span>: <span class="st">"Superior California"</span>,</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Nevada"</span>: <span class="st">"Superior California"</span>,</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Placer"</span>: <span class="st">"Superior California"</span>,</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Plumas"</span>: <span class="st">"Superior California"</span>,</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Sacramento"</span>: <span class="st">"Superior California"</span>,</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Shasta"</span>: <span class="st">"Superior California"</span>,</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Sierra"</span>: <span class="st">"Superior California"</span>,</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Siskiyou"</span>: <span class="st">"Superior California"</span>,</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Sutter"</span>: <span class="st">"Superior California"</span>,</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Tehama"</span>: <span class="st">"Superior California"</span>,</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Yolo"</span>: <span class="st">"Superior California"</span>,</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Yuba"</span>: <span class="st">"Superior California"</span>,</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Del Norte"</span>: <span class="st">"North Coast"</span>,</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Humboldt"</span>: <span class="st">"North Coast"</span>,</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Lake"</span>: <span class="st">"North Coast"</span>,</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mendocino"</span>: <span class="st">"North Coast"</span>,</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Napa"</span>: <span class="st">"North Coast"</span>,</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Sonoma"</span>: <span class="st">"North Coast"</span>,</span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Trinity"</span>: <span class="st">"North Coast"</span>,</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Alameda"</span>: <span class="st">"San Francisco Bay Area"</span>,</span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Contra Costa"</span>: <span class="st">"San Francisco Bay Area"</span>,</span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Marin"</span>: <span class="st">"San Francisco Bay Area"</span>,</span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">"San Francisco"</span>: <span class="st">"San Francisco Bay Area"</span>,</span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">"San Mateo"</span>: <span class="st">"San Francisco Bay Area"</span>,</span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Santa Clara"</span>: <span class="st">"San Francisco Bay Area"</span>,</span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Solano"</span>: <span class="st">"San Francisco Bay Area"</span>,</span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Alpine"</span>: <span class="st">"Northern San Joaquin Valley"</span>,</span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Amador"</span>: <span class="st">"Northern San Joaquin Valley"</span>,</span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Calaveras"</span>: <span class="st">"Northern San Joaquin Valley"</span>,</span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Madera"</span>: <span class="st">"Northern San Joaquin Valley"</span>,</span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mariposa"</span>: <span class="st">"Northern San Joaquin Valley"</span>,</span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Merced"</span>: <span class="st">"Northern San Joaquin Valley"</span>,</span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mono"</span>: <span class="st">"Northern San Joaquin Valley"</span>,</span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a>    <span class="st">"San Joaquin"</span>: <span class="st">"Northern San Joaquin Valley"</span>,</span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Stanislaus"</span>: <span class="st">"Northern San Joaquin Valley"</span>,</span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Tuolumne"</span>: <span class="st">"Northern San Joaquin Valley"</span>,</span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Monterey"</span>: <span class="st">"Central Coast"</span>,</span>
<span id="cb26-45"><a href="#cb26-45" aria-hidden="true" tabindex="-1"></a>    <span class="st">"San Benito"</span>: <span class="st">"Central Coast"</span>,</span>
<span id="cb26-46"><a href="#cb26-46" aria-hidden="true" tabindex="-1"></a>    <span class="st">"San Luis Obispo"</span>: <span class="st">"Central Coast"</span>,</span>
<span id="cb26-47"><a href="#cb26-47" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Santa Barbara"</span>: <span class="st">"Central Coast"</span>,</span>
<span id="cb26-48"><a href="#cb26-48" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Santa Cruz"</span>: <span class="st">"Central Coast"</span>,</span>
<span id="cb26-49"><a href="#cb26-49" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Ventura"</span>: <span class="st">"Central Coast"</span>,</span>
<span id="cb26-50"><a href="#cb26-50" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Fresno"</span>: <span class="st">"Southern San Joaquin Valley"</span>,</span>
<span id="cb26-51"><a href="#cb26-51" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Inyo"</span>: <span class="st">"Southern San Joaquin Valley"</span>,</span>
<span id="cb26-52"><a href="#cb26-52" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Kern"</span>: <span class="st">"Southern San Joaquin Valley"</span>,</span>
<span id="cb26-53"><a href="#cb26-53" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Kings"</span>: <span class="st">"Southern San Joaquin Valley"</span>,</span>
<span id="cb26-54"><a href="#cb26-54" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Tulare"</span>: <span class="st">"Southern San Joaquin Valley"</span>,</span>
<span id="cb26-55"><a href="#cb26-55" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Riverside"</span>: <span class="st">"Inland Empire"</span>,</span>
<span id="cb26-56"><a href="#cb26-56" aria-hidden="true" tabindex="-1"></a>    <span class="st">"San Bernardino"</span>: <span class="st">"Inland Empire"</span>,</span>
<span id="cb26-57"><a href="#cb26-57" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Los Angeles"</span>: <span class="st">"Los Angeles"</span>,</span>
<span id="cb26-58"><a href="#cb26-58" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Orange"</span>: <span class="st">"Orange County"</span>,</span>
<span id="cb26-59"><a href="#cb26-59" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Imperial"</span>: <span class="st">"San Diego-Imperial"</span>,</span>
<span id="cb26-60"><a href="#cb26-60" aria-hidden="true" tabindex="-1"></a>    <span class="st">"San Diego"</span>: <span class="st">"San Diego-Imperial"</span>,</span>
<span id="cb26-61"><a href="#cb26-61" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</details>
</div>
<p>Now that I have the mappings dictionary, I can map those onto the county names in my dataset:</p>
<div id="cd98a093" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>county_shapes[<span class="st">"region"</span>] <span class="op">=</span> county_shapes[<span class="st">"NAME"</span>].<span class="bu">map</span>(county_to_region)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>county_shapes[[<span class="st">"NAME"</span>, <span class="st">"region"</span>]].head(<span class="dv">4</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">NAME</th>
<th data-quarto-table-cell-role="th">region</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>Sierra</td>
<td>Superior California</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">324</td>
<td>Sacramento</td>
<td>Superior California</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">328</td>
<td>Santa Barbara</td>
<td>Central Coast</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">345</td>
<td>Calaveras</td>
<td>Northern San Joaquin Valley</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>I want to combine the county shapes up into larger, parent region shapes. This spatial aggregation operation is called a <a href="https://geopandas.org/en/stable/docs/user_guide/aggregation_with_dissolve.html"><code>dissolve()</code> in geopandas</a>. Here’s an abstract representation of what <code>dissolve()</code> does:</p>
<div id="8408f772" class="cell" data-execution_count="34">
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption>The effect of <code>dissolve()</code> (image by author)</figcaption>
<p><img src="index_files/figure-html/cell-27-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Here we will create a new gdf, <code>regions</code>, with the results of dissolving the counties up into regions.</p>
<div id="beda6efb" class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>regions <span class="op">=</span> county_shapes.dissolve(by<span class="op">=</span><span class="st">"region"</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> county_shapes.crs <span class="op">==</span> regions.crs</span></code></pre></div>
</div>
<div id="e4b47b51" class="cell" data-execution_count="36">
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption>Dissolving the Bay Area counties (image by author)</figcaption>
<p><img src="index_files/figure-html/cell-29-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>One benefit of moving up to a larger geographic unit is that there will be more space on the map for labels. Labeling all 58 counties in California is generally not feasible without using creative acronyms or else altering the county shapes, but regions lend themselves to labeling, albeit with a few tweaks to the labels.</p>
<p>Long strings are generally difficult to fit on maps, so as a first step I will add newlines to every region label at the midpoint of the text:</p>
<div id="f7cdfa3f" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> split_name_middle(name: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    parts <span class="op">=</span> name.replace(<span class="st">"-"</span>, <span class="st">" "</span>).split()</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(parts) <span class="op">&lt;=</span> <span class="dv">1</span>:</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> name</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    mid <span class="op">=</span> <span class="bu">len</span>(parts) <span class="op">//</span> <span class="dv">2</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">" "</span>.join(parts[:mid]) <span class="op">+</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">" "</span>.join(parts[mid:])</span></code></pre></div>
</div>
<div id="619c2579" class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(split_name_middle(<span class="st">'San Francisco Bay Area'</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>San Francisco
Bay Area</code></pre>
</div>
</div>
<p>Next, I’ll create a function to label each region polygon. The labels will be placed at the centroids of each region by default, but the function also allows for the user to pass a list of labels that need to be “adjusted” – moved away from their region for spacing purposes. I utilize <a href="https://github.com/Phlya/adjustText">the <code>adjustText</code> python library</a>, a great tool for this purpose.</p>
<div id="fe392b09" class="cell" data-execution_count="103">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> label_polygon(</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    gdf: gpd.GeoDataFrame,</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    ax,</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    column: <span class="bu">str</span>,</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    adjust_list: <span class="bu">list</span> <span class="op">=</span> [],</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    adjust_kws<span class="op">=</span>{<span class="st">"avoid_self"</span>: <span class="va">True</span>},</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    text_kws<span class="op">=</span>{},</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> adjust_kws.get(<span class="st">'arrowprops'</span>):</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>        adjust_kws[<span class="st">'arrowprops'</span>] <span class="op">=</span> {</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>            <span class="st">"arrowstyle"</span>: <span class="st">"-"</span>,</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>            <span class="st">"color"</span>: <span class="st">"black"</span>,</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">"lw"</span>: <span class="dv">1</span>,</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>            <span class="st">"connectionstyle"</span>: <span class="st">"arc3,rad=0.1"</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>    texts <span class="op">=</span> []</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, row <span class="kw">in</span> gdf.iterrows():</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> row[<span class="st">"geometry"</span>].is_empty <span class="kw">or</span> row[<span class="st">"geometry"</span>].centroid.is_empty:</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>        point <span class="op">=</span> row[<span class="st">"geometry"</span>].centroid</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>        x, y <span class="op">=</span> point.x, point.y</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> row[column] <span class="kw">in</span> adjust_list:</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>            texts.append(</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>                ax.text(x, y, split_name_middle(row[column]), <span class="op">**</span>text_kws))</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>            ax.text(x, y, split_name_middle(row[column]), <span class="op">**</span>text_kws)</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>    adjust_text(texts, ax<span class="op">=</span>ax, <span class="op">**</span>adjust_kws)</span></code></pre></div>
</div>
<div id="43374ec8" class="cell" data-execution_count="106">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">4</span>, <span class="dv">4</span>))</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>subset <span class="op">=</span> regions.loc[[<span class="st">'North Coast'</span>], :]</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>subset.plot(ax<span class="op">=</span>ax)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>label_polygon(subset.reset_index(), ax, column<span class="op">=</span><span class="st">'region'</span>, adjust_list<span class="op">=</span>[<span class="st">'North Coast'</span>], adjust_kws<span class="op">=</span>{<span class="st">"expand"</span>: (<span class="dv">12</span>, <span class="dv">2</span>)})</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>ax.set_axis_off()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>d</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-33-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>With those helper-functions defined, I’ll proceed to define the styling for the plot, including styles for the adjusted text.</p>
<div id="78ae2010" class="cell" data-execution_count="42">
<details class="code-fold">
<summary>Plot Styling: <code>new_cmap</code>, <code>borders_kws</code>, <code>data_fill_kws</code>, <code>missing_fill_kws</code>, <code>legend_cbar_kws</code>,<code>adjust_kws</code>, <code>text_kws</code></summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>new_cmap <span class="op">=</span> build_cmap(<span class="st">"coolwarm_r"</span>, start<span class="op">=</span><span class="fl">0.1</span>, end<span class="op">=</span><span class="fl">0.9</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>borders_kws <span class="op">=</span> {<span class="st">"edgecolor"</span>: <span class="st">"grey"</span>, <span class="st">"linewidth"</span>: <span class="fl">0.3</span>}</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>data_fill_kws <span class="op">=</span> {<span class="st">"alpha"</span>: <span class="fl">0.7</span>, <span class="st">"cmap"</span>: new_cmap}</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>missing_fill_kws <span class="op">=</span> {<span class="st">"hatch"</span>: <span class="st">"////"</span>, <span class="st">"facecolor"</span>: <span class="st">"none"</span>}</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>legend_cbar_kws <span class="op">=</span> {</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"format"</span>: FuncFormatter(number_suffix_formatter),</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"shrink"</span>: <span class="fl">0.7</span>,</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"label"</span>: <span class="st">"Number of Public Transit Stops"</span>,</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"location"</span>: <span class="st">"top"</span>,</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pad"</span>: <span class="fl">0.001</span>,</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>adjust_kws <span class="op">=</span> {</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"avoid_self"</span>: <span class="va">True</span>,</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"expand"</span>: (<span class="dv">7</span>, <span class="dv">3</span>),</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"arrowprops"</span>: {</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"arrowstyle"</span>: <span class="st">"-"</span>,</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"color"</span>: <span class="st">"black"</span>,</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"lw"</span>: <span class="dv">1</span>,</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">"connectionstyle"</span>: <span class="st">"arc3,rad=0.1"</span>,</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>text_kws <span class="op">=</span> {</span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fontsize"</span>: <span class="dv">7</span>,</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ha"</span>: <span class="st">"center"</span>,</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"va"</span>: <span class="st">"center"</span>,</span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"color"</span>: <span class="st">"black"</span>,</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</details>
</div>
<p>And now the plot – straightforward code from here.</p>
<div id="df97f12a" class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">4</span>, <span class="dv">6</span>))</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>arrivals_in_regions <span class="op">=</span> points_in_polygon(</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    gdf_all,</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    regions.reset_index(),</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    group_var<span class="op">=</span><span class="st">"region"</span>,</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    weight_var<span class="op">=</span><span class="st">"n_arrivals"</span>,</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>arrivals_in_regions.plot(</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    column<span class="op">=</span><span class="st">"n_arrivals_sum"</span>,</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">**</span>data_fill_kws,</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">**</span>borders_kws,</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>    legend<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>    legend_kwds<span class="op">=</span>legend_cbar_kws</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>label_polygon(</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>    arrivals_in_regions,</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>    ax,</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"region"</span>,</span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>    adjust_list<span class="op">=</span>[<span class="st">"San Francisco Bay Area"</span>, <span class="st">"Orange County"</span>, <span class="st">"North Coast"</span>],</span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>    adjust_kws<span class="op">=</span>adjust_kws,</span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>    text_kws<span class="op">=</span>text_kws,</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>ax.axis(<span class="st">"off"</span>)</span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>fig.tight_layout()</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-35-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Interesting perspective from this one, where the takeaway seems to be that the Los Angeles and San Francisco Bay Area regions have many more transit stops than the rest of the state. Like the previous county map, this shows that L.A. is far above the rest of the state in terms of raw count of stops within its borders.</p>
</section>
<section id="exercise-4-heatmaps-and-projected-crs" class="level2">
<h2 class="anchored" data-anchor-id="exercise-4-heatmaps-and-projected-crs">Exercise 4: Heatmaps and Projected CRS</h2>
<blockquote class="blockquote">
<p>[…] heat maps may also visualize data over a geographic region. However, unlike choropleth maps, heat maps show the proportion of a variable over an arbitrary, but usually small grid size, independent of geographic boundaries.</p>
</blockquote>
<p>https://en.wikipedia.org/wiki/Ecological_fallacy</p>
<p>https://en.wikipedia.org/wiki/Heat_map#Choropleth_maps_versus_heat_maps</p>
<p>We are going to explicitly define the size of these cells that break space up into a grid – e.g.&nbsp;square 20 kilometer cells. That means that we are going to be calculating distances across space, and that means a refresher on the appropriate use of Coordinate Reference Systems! Our stops dataset and the county/state shape data we are using are currently in <strong>NAD83</strong>, which is a geodetic CRS that uses latitude and longitude coordinates to locate positions <span class="citation" data-cites="kennedy_understanding_2000">(<a href="#ref-kennedy_understanding_2000" role="doc-biblioref">Kennedy and Kopp 2000</a>)</span>.</p>
<div id="745d60f5" class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>gdf_ca.crs.coordinate_system</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="44">
<pre><code>CS[ellipsoidal,2],
    AXIS["geodetic latitude (Lat)",north,
        ORDER[1],
        ANGLEUNIT["degree",0.0174532925199433,
            ID["EPSG",9122]]],
    AXIS["geodetic longitude (Lon)",east,
        ORDER[2],
        ANGLEUNIT["degree",0.0174532925199433,
            ID["EPSG",9122]]]</code></pre>
</div>
</div>
<p>We typically should not use those degrees for distance calculation because the distance that a degree measures is not constant. Per <span class="citation" data-cites="kennedy_understanding_2000">(<a href="#ref-kennedy_understanding_2000" role="doc-biblioref">Kennedy and Kopp 2000</a>)</span>:</p>
<blockquote class="blockquote">
<p>Since degrees of latitude and longitude don’t have a standard length, you can’t measure distances or areas accurately or display the data easily on a flat map or computer screen.</p>
</blockquote>
<p>When we try any distance calculations on a gdf in a geodetic CRS, we get a warning in <code>geopandas</code>.</p>
<div id="1c3a0fab" class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> warnings.catch_warnings(record<span class="op">=</span><span class="va">True</span>) <span class="im">as</span> w:</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># try calculating length</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    california.length</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># clean up warning message</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="bu">str</span>(w[<span class="dv">0</span>].message).replace(<span class="st">". "</span>, <span class="st">".</span><span class="ch">\n</span><span class="st">"</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Geometry is in a geographic CRS.
Results from 'length' are likely incorrect.
Use 'GeoSeries.to_crs()' to re-project geometries to a projected CRS before this operation.
</code></pre>
</div>
</div>
<p>As the <code>geopandas</code> warning above suggests, we can address this warning by re-projecting the data into a <strong>projected CRS</strong> that explicitly measures location in meters.</p>
<div id="c60cd006" class="cell" data-execution_count="46">
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption>Comparison of geographic versus projected coordinate systems (image by author).</figcaption>
<p><img src="index_files/figure-html/cell-38-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The downside of this is that projections convert the 3D world to a 2D representation with <em>reasonable accuracy</em>. Consider the following example from <span class="citation" data-cites="kennedy_understanding_2000">(<a href="#ref-kennedy_understanding_2000" role="doc-biblioref">Kennedy and Kopp 2000</a>)</span>:</p>
<blockquote class="blockquote">
<p>A spheroid can’t be flattened to a plane any easier than a piece of orange peel can be flattened—it will rip. Representing the earth’s surface in two dimensions causes distortion in the shape, area, distance, or direction of the data.</p>
</blockquote>
<p>Cartographers have developed a whole world of different 3D to 2D <strong>map projections</strong> designed with specific uses and geographies in mind to minimize distortion <span class="citation" data-cites="kennedy_understanding_2000">(<a href="#ref-kennedy_understanding_2000" role="doc-biblioref">Kennedy and Kopp 2000</a>)</span>. Here we will use California Albers (also known as Teale Albers), a map projection optimal for distance calculations within California <span class="citation" data-cites="patterson_california_2022">(<a href="#ref-patterson_california_2022" role="doc-biblioref">Patterson 2022</a>)</span>.</p>
<div id="58db9cb0" class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>gdf_ca_proj <span class="op">=</span> gdf_ca.to_crs(CA_ALBERS_CRS)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>california_proj <span class="op">=</span> california.to_crs(CA_ALBERS_CRS)</span></code></pre></div>
</div>
<p>Now the length unit is meters.</p>
<div id="114df72d" class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>california_proj.crs.coordinate_system</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="48">
<pre><code>CS[Cartesian,2],
    AXIS["easting (X)",east,
        ORDER[1],
        LENGTHUNIT["metre",1,
            ID["EPSG",9001]]],
    AXIS["northing (Y)",north,
        ORDER[2],
        LENGTHUNIT["metre",1,
            ID["EPSG",9001]]]</code></pre>
</div>
</div>
<p>Now that we can measure distance accurately, lets make the heatmap. I have folded code below that I use to make my plots, but it has some complexities that are beyond the scope of the actual task so I’ll also walk through the basics of making a heatmap here.</p>
<p>I start with defining the corner coordinates of the point data that I want to make into a heatmap.</p>
<div id="fd084e15" class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>minx, miny, maxx, maxy <span class="op">=</span> gdf_ca_proj.total_bounds</span></code></pre></div>
</div>
<p>I use those coordinates to make a box that bounds the point data.</p>
<div id="00cebf69" class="cell" data-execution_count="50">
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption>Defining the point data’s bounding box</figcaption>
<p><img src="index_files/figure-html/cell-42-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Next I construct a grid within that box.</p>
<div id="1d99ff15" class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>cell_size <span class="op">=</span> <span class="dv">50_000</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>x_bins <span class="op">=</span> np.arange(minx, maxx <span class="op">+</span> cell_size, cell_size)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>y_bins <span class="op">=</span> np.arange(miny, maxy <span class="op">+</span> cell_size, cell_size)</span></code></pre></div>
</div>
<p>We’ll use the grid squares the same way that we used county and regional boundaries in the choropleth maps – we will aggregate the point data up into their parent polygons as show here (this only is a random sample of 500 stops):</p>
<div id="c4d189b7" class="cell" data-execution_count="52">
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption>Dividing space into a grid</figcaption>
<p><img src="index_files/figure-html/cell-44-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Unlike with the choropleth maps, I’ll accomplish this aggregation task using a canned function, <code>np.histogram2d</code>, that aggregates point data into a grid. Here’s a simple plot of the results using <code>plt.imshow()</code>.</p>
<div id="886a18fc" class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> gdf_ca_proj.geometry.x.values</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> gdf_ca_proj.geometry.y.values</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>hist, _, _ <span class="op">=</span> np.histogram2d(</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>        x, y, bins<span class="op">=</span>[x_bins, y_bins]</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">5</span>, <span class="dv">3</span>))</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>ax.<span class="bu">set</span>(xlabel<span class="op">=</span><span class="st">'? units'</span>, ylabel<span class="op">=</span><span class="st">'? units'</span>)</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>ax.imshow(hist.T, origin<span class="op">=</span><span class="st">'lower'</span>, cmap<span class="op">=</span><span class="st">'Reds'</span>)<span class="op">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption>A rough heatmap</figcaption>
<p><img src="index_files/figure-html/cell-45-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Note by the units of this plot that we’ve lost the context of the coordinate reference system for this data. In my folded code below, I show how to maintain the CRS and the meter units, but it’s a little more involved and I divide it into two functions for re-usability:</p>
<div id="6b14e4c0" class="cell" data-execution_count="54">
<details class="code-fold">
<summary>Geospatial Histogram Functions: <code>histogram_to_geodataframe</code> and <code>geospatial_histogram</code></summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> histogram_to_geodataframe(hist, x_edges, y_edges, crs<span class="op">=</span><span class="va">None</span>) <span class="op">-&gt;</span> gpd.GeoDataFrame:</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Convert a 2D histogram and bin edges into a GeoDataFrame of grid cells with counts.</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="co">    hist : 2D numpy array</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="co">        The histogram values (as returned by geospatial_histogram, already transposed).</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a><span class="co">    x_edges : 1D numpy array</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Bin edges along the x-axis.</span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a><span class="co">    y_edges : 1D numpy array</span></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Bin edges along the y-axis.</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a><span class="co">    crs : any (optional)</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a><span class="co">        Coordinate reference system for the GeoDataFrame.</span></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a><span class="co">    gdf : GeoDataFrame</span></span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a><span class="co">        A GeoDataFrame with one polygon per grid cell, with a 'count' column.</span></span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>    rows, cols <span class="op">=</span> hist.shape</span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>    polygons <span class="op">=</span> []</span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a>    counts <span class="op">=</span> []</span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(rows):</span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(cols):</span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a>            count <span class="op">=</span> hist[i, j]</span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> count <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb47-29"><a href="#cb47-29" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span>  <span class="co"># Skip empty cells for efficiency</span></span>
<span id="cb47-30"><a href="#cb47-30" aria-hidden="true" tabindex="-1"></a>            x0 <span class="op">=</span> x_edges[j]</span>
<span id="cb47-31"><a href="#cb47-31" aria-hidden="true" tabindex="-1"></a>            x1 <span class="op">=</span> x_edges[j <span class="op">+</span> <span class="dv">1</span>]</span>
<span id="cb47-32"><a href="#cb47-32" aria-hidden="true" tabindex="-1"></a>            y0 <span class="op">=</span> y_edges[i]</span>
<span id="cb47-33"><a href="#cb47-33" aria-hidden="true" tabindex="-1"></a>            y1 <span class="op">=</span> y_edges[i <span class="op">+</span> <span class="dv">1</span>]</span>
<span id="cb47-34"><a href="#cb47-34" aria-hidden="true" tabindex="-1"></a>            polygons.append(box(x0, y0, x1, y1))</span>
<span id="cb47-35"><a href="#cb47-35" aria-hidden="true" tabindex="-1"></a>            counts.append(count)</span>
<span id="cb47-36"><a href="#cb47-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-37"><a href="#cb47-37" aria-hidden="true" tabindex="-1"></a>    gdf <span class="op">=</span> gpd.GeoDataFrame({<span class="st">"count"</span>: counts, <span class="st">"geometry"</span>: polygons}, crs<span class="op">=</span>crs)</span>
<span id="cb47-38"><a href="#cb47-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> gdf</span>
<span id="cb47-39"><a href="#cb47-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-40"><a href="#cb47-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-41"><a href="#cb47-41" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> geospatial_histogram(gdf: gpd.GeoDataFrame, cell_size: <span class="bu">float</span>, bounds<span class="op">=</span><span class="va">None</span>, weights<span class="op">=</span><span class="va">None</span>) <span class="op">-&gt;</span> gpd.GeoDataFrame:</span>
<span id="cb47-42"><a href="#cb47-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb47-43"><a href="#cb47-43" aria-hidden="true" tabindex="-1"></a><span class="co">    Create a 2D geospatial histogram (raster grid of counts) from a GeoDataFrame of points.</span></span>
<span id="cb47-44"><a href="#cb47-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-45"><a href="#cb47-45" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb47-46"><a href="#cb47-46" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb47-47"><a href="#cb47-47" aria-hidden="true" tabindex="-1"></a><span class="co">    gdf : GeoDataFrame</span></span>
<span id="cb47-48"><a href="#cb47-48" aria-hidden="true" tabindex="-1"></a><span class="co">        Must contain Point geometries in a projected CRS (e.g. meters).</span></span>
<span id="cb47-49"><a href="#cb47-49" aria-hidden="true" tabindex="-1"></a><span class="co">    cell_size : float</span></span>
<span id="cb47-50"><a href="#cb47-50" aria-hidden="true" tabindex="-1"></a><span class="co">        Width and height of grid cells (in CRS units, e.g. meters).</span></span>
<span id="cb47-51"><a href="#cb47-51" aria-hidden="true" tabindex="-1"></a><span class="co">    bounds : tuple or None</span></span>
<span id="cb47-52"><a href="#cb47-52" aria-hidden="true" tabindex="-1"></a><span class="co">        Optional (minx, miny, maxx, maxy). If None, computed from gdf.bounds.</span></span>
<span id="cb47-53"><a href="#cb47-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-54"><a href="#cb47-54" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb47-55"><a href="#cb47-55" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb47-56"><a href="#cb47-56" aria-hidden="true" tabindex="-1"></a><span class="co">    hist : 2D numpy array</span></span>
<span id="cb47-57"><a href="#cb47-57" aria-hidden="true" tabindex="-1"></a><span class="co">        Histogram counts of points per grid cell.</span></span>
<span id="cb47-58"><a href="#cb47-58" aria-hidden="true" tabindex="-1"></a><span class="co">    (Optional) x_edges, y_edges : 1D numpy arrays</span></span>
<span id="cb47-59"><a href="#cb47-59" aria-hidden="true" tabindex="-1"></a><span class="co">        Bin edges in x and y directions.</span></span>
<span id="cb47-60"><a href="#cb47-60" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb47-61"><a href="#cb47-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> gdf.crs.is_projected, <span class="st">"CRS must be projected first, e.g. `gdf.set_crs()`"</span></span>
<span id="cb47-62"><a href="#cb47-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> gdf.empty:</span>
<span id="cb47-63"><a href="#cb47-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Input GeoDataFrame is empty."</span>)</span>
<span id="cb47-64"><a href="#cb47-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> gdf.geometry.geom_type.isin([<span class="st">"Point"</span>]).<span class="bu">all</span>():</span>
<span id="cb47-65"><a href="#cb47-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"All geometries must be Points."</span>)</span>
<span id="cb47-66"><a href="#cb47-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-67"><a href="#cb47-67" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> gdf.geometry.x.values</span>
<span id="cb47-68"><a href="#cb47-68" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> gdf.geometry.y.values</span>
<span id="cb47-69"><a href="#cb47-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-70"><a href="#cb47-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> weights <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb47-71"><a href="#cb47-71" aria-hidden="true" tabindex="-1"></a>        weights <span class="op">=</span> np.asarray(gdf[weights])</span>
<span id="cb47-72"><a href="#cb47-72" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(weights) <span class="op">!=</span> <span class="bu">len</span>(gdf):</span>
<span id="cb47-73"><a href="#cb47-73" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Length of weights must match number of points in gdf."</span>)</span>
<span id="cb47-74"><a href="#cb47-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-75"><a href="#cb47-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> bounds <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb47-76"><a href="#cb47-76" aria-hidden="true" tabindex="-1"></a>        minx, miny, maxx, maxy <span class="op">=</span> gdf.total_bounds</span>
<span id="cb47-77"><a href="#cb47-77" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb47-78"><a href="#cb47-78" aria-hidden="true" tabindex="-1"></a>        minx, miny, maxx, maxy <span class="op">=</span> bounds</span>
<span id="cb47-79"><a href="#cb47-79" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define bin edges</span></span>
<span id="cb47-80"><a href="#cb47-80" aria-hidden="true" tabindex="-1"></a>    x_bins <span class="op">=</span> np.arange(minx, maxx <span class="op">+</span> cell_size, cell_size)</span>
<span id="cb47-81"><a href="#cb47-81" aria-hidden="true" tabindex="-1"></a>    y_bins <span class="op">=</span> np.arange(miny, maxy <span class="op">+</span> cell_size, cell_size)</span>
<span id="cb47-82"><a href="#cb47-82" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute histogram</span></span>
<span id="cb47-83"><a href="#cb47-83" aria-hidden="true" tabindex="-1"></a>    hist, x_edges, y_edges <span class="op">=</span> np.histogram2d(</span>
<span id="cb47-84"><a href="#cb47-84" aria-hidden="true" tabindex="-1"></a>        x, y, bins<span class="op">=</span>[x_bins, y_bins], weights<span class="op">=</span>weights</span>
<span id="cb47-85"><a href="#cb47-85" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb47-86"><a href="#cb47-86" aria-hidden="true" tabindex="-1"></a>    <span class="co"># histogram2d returns shape (len(x_bins)-1, len(y_bins)-1) with axes (x, y)</span></span>
<span id="cb47-87"><a href="#cb47-87" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Transpose so that rows = y, columns = x (like image/raster orientation)</span></span>
<span id="cb47-88"><a href="#cb47-88" aria-hidden="true" tabindex="-1"></a>    hist <span class="op">=</span> hist.T</span>
<span id="cb47-89"><a href="#cb47-89" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> histogram_to_geodataframe(hist, x_edges, y_edges, crs<span class="op">=</span>gdf.crs)</span></code></pre></div>
</details>
</div>
<p>With those two functions written, I’ll build my production heatmap. Here are the stylings:</p>
<div id="fa4eac60" class="cell" data-execution_count="55">
<details class="code-fold">
<summary>Plot Styling: <code>legend_cbar_kws</code>, <code>square_patch</code>, <code>borders_kws</code></summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>new_cmap <span class="op">=</span> build_cmap(<span class="st">"YlOrRd"</span>, start<span class="op">=</span><span class="dv">0</span>, end<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>legend_cbar_kws <span class="op">=</span> {</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"format"</span>: FuncFormatter(number_suffix_formatter),</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"shrink"</span>: <span class="fl">0.8</span>,</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"label"</span>: <span class="st">"Number of Public Transit Stops"</span>,</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"location"</span>: <span class="st">"top"</span>,</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pad"</span>: <span class="fl">0.001</span>,</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>data_fill_kws <span class="op">=</span> {<span class="st">"alpha"</span>: <span class="dv">1</span>, <span class="st">"cmap"</span>: new_cmap}</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>square_patch <span class="op">=</span> mpatches.Rectangle(</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">0</span>, <span class="dv">0</span>), <span class="dv">10</span>, <span class="dv">10</span>, facecolor<span class="op">=</span>new_cmap.get_under(), edgecolor<span class="op">=</span><span class="st">"grey"</span>, linewidth<span class="op">=</span><span class="fl">0.8</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>borders_kws <span class="op">=</span> {<span class="st">"edgecolor"</span>: <span class="st">"grey"</span>, <span class="st">"linewidth"</span>: <span class="fl">0.1</span>}</span></code></pre></div>
</details>
</div>
<p>Here I’ll use my custom <code>geospatial_histogram</code> function to make the raser grid for the heatmap. I’ll double check that all the CRS are right.</p>
<div id="e694d818" class="cell" data-execution_count="56">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>cell_size <span class="op">=</span> <span class="dv">20_000</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>arrivals_hist <span class="op">=</span> geospatial_histogram(</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>    gdf_ca_proj, weights<span class="op">=</span><span class="va">None</span>, cell_size<span class="op">=</span>cell_size</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> gdf_ca_proj.crs <span class="op">==</span> california_proj.crs</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> arrivals_hist.crs <span class="op">==</span> california_proj.crs</span></code></pre></div>
</div>
<p>And finally I’ll plot my final product, a heatmap of public transit stops in the state.</p>
<div id="f12b1a7d" class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">4</span>, <span class="dv">6</span>))</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>california_proj.plot(</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax, edgecolor<span class="op">=</span><span class="st">"grey"</span>, facecolor<span class="op">=</span><span class="st">"none"</span>, linewidth<span class="op">=</span><span class="dv">1</span>, alpha<span class="op">=</span><span class="fl">0.5</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>arrivals_hist.plot(</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>    column<span class="op">=</span><span class="st">"count"</span>,</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">**</span>data_fill_kws,</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">**</span>borders_kws,</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>    zorder<span class="op">=-</span><span class="dv">1</span>,</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>    legend<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>    legend_kwds<span class="op">=</span>legend_cbar_kws,</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>ax.legend(</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>    handles<span class="op">=</span>[square_patch],</span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>    labels<span class="op">=</span>[<span class="vs">rf"</span><span class="sc">{</span><span class="bu">int</span>(cell_size<span class="op">/</span><span class="dv">1000</span>)<span class="sc">}</span><span class="vs">$\times$</span><span class="sc">{</span><span class="bu">int</span>(cell_size<span class="op">/</span><span class="dv">1000</span>)<span class="sc">}</span><span class="vs">km Grid Area"</span>],</span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>    loc<span class="op">=</span><span class="st">"upper right"</span>,</span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>    frameon<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>    fontsize<span class="op">=</span><span class="dv">9</span>,</span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a>    handlelength<span class="op">=</span><span class="fl">1.0</span>,</span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a>    handleheight<span class="op">=</span><span class="fl">1.25</span>,</span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a>ax.axis(<span class="st">"off"</span>)</span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a>fig.tight_layout()</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-49-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Like the two choropleths above, this map highlights that there are a lot of public transit stops in Los Angeles. However, by using smaller geographic units that aren’t tied to administrative boundaries, we can also see other public transit hot spots. For example, we can see that the core Bay Area, around downtown San Francisco and downtown Oakland, is a transit hot spot that is distinct from another hotspot in Downtown San Jose to the South.</p>
</section>
<section id="exercise-5-refining-land-and-sea" class="level2">
<h2 class="anchored" data-anchor-id="exercise-5-refining-land-and-sea">Exercise 5: Refining Land and Sea</h2>
<p>Now we will try an exercise where we zoom from the state level into a specific region. Since we are operating at a more fine-grained geographical level, I’ll also switch to CalTrans’ <a href="https://gis.data.ca.gov/datasets/f6c30480f0e84be699383192c099a6a4_0/about">“High Quality Transit Stops”</a> dataset, slightly more sparse point data that only include stops with headways of 20 minutes or less.</p>
<p>Here’s a new, region specific question:</p>
<div class="callout callout-style-default callout-tip callout-titled" title="New Motivating Question">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
New Motivating Question
</div>
</div>
<div class="callout-body-container callout-body">
<p>How does the distribution of <strong>high quality</strong> public transit stops in the <strong>San Francisco Bay Area</strong> vary by geography?</p>
</div>
</div>
<p>I’ll start with paginating the CalTrans’ API and retrieving the stop data.</p>
<div id="989cc612" class="cell" data-execution_count="58">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>hq_stops <span class="op">=</span> <span class="st">"services/CHrailroad/CA_HQ_Transit_Stops/FeatureServer/0/query"</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>gdf_hq <span class="op">=</span> paginate_api(rest_api <span class="op">+</span> hq_stops)</span></code></pre></div>
</div>
<p>With this dataset, I’ll need to make sure to filter out stops that are planned for the future. I also isolate the data down to unique, high quality, major stops.</p>
<div id="1d94aece" class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>gdf_hq <span class="op">=</span> gdf_hq[<span class="op">~</span>gdf_hq[<span class="st">'hqta_details'</span>].<span class="bu">str</span>.contains(<span class="st">'planned'</span>)]</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>gdf_hq <span class="op">=</span> gdf_hq[gdf_hq[<span class="st">'hqta_type'</span>].<span class="bu">str</span>.contains(<span class="st">'major_stop'</span>)]</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>gdf_hq <span class="op">=</span> gdf_hq.drop_duplicates(subset<span class="op">=</span><span class="st">'geometry'</span>)</span></code></pre></div>
</div>
<p>We can see that there are far fewer high quality stops than total stops.</p>
<div id="4a3c84e1" class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Total Public Transit Stops:"</span>, gdf_all.shape[<span class="dv">0</span>])</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"High Quality Public Transit Stops:"</span>, gdf_hq.shape[<span class="dv">0</span>])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Total Public Transit Stops: 88526
High Quality Public Transit Stops: 15416</code></pre>
</div>
</div>
<p>These data do look fairly similar to the total stops data, though.</p>
<div id="26bdec25" class="cell" data-execution_count="61">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>gdf_hq[[<span class="st">'hqta_type'</span>, <span class="st">'stop_id'</span>, <span class="st">'hqta_details'</span>,<span class="st">'avg_trips_per_peak_hr'</span>, <span class="st">'geometry'</span>]].head()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="61">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">hqta_type</th>
<th data-quarto-table-cell-role="th">stop_id</th>
<th data-quarto-table-cell-role="th">hqta_details</th>
<th data-quarto-table-cell-role="th">avg_trips_per_peak_hr</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">2805</td>
<td>major_stop_brt</td>
<td>52404</td>
<td>major_stop_brt_single_operator</td>
<td>6</td>
<td>POINT (-122.15757 37.72538)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2806</td>
<td>major_stop_brt</td>
<td>52405</td>
<td>major_stop_brt_single_operator</td>
<td>4</td>
<td>POINT (-122.15792 37.72544)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2807</td>
<td>major_stop_brt</td>
<td>52414</td>
<td>major_stop_brt_single_operator</td>
<td>6</td>
<td>POINT (-122.15834 37.72813)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2808</td>
<td>major_stop_brt</td>
<td>52415</td>
<td>major_stop_brt_single_operator</td>
<td>4</td>
<td>POINT (-122.1588 37.72844)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2809</td>
<td>major_stop_brt</td>
<td>52426</td>
<td>major_stop_brt_single_operator</td>
<td>6</td>
<td>POINT (-122.16086 37.73151)</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>I’ll proceed to set this point data’s CRS to match that of the regions data – the shapefile for California’s regions. This will facilitate doing a spatial merge where I isolate the high quality stops that are within the San Francisco Bay Area Region. I’ll do the same spatial merge to isolate the shapes of the Bay Area’s counties.</p>
<div id="dc39677b" class="cell" data-execution_count="62">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>gdf_hq.crs <span class="op">=</span> regions.crs</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> gdf_hq.crs <span class="op">==</span> regions.crs</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>gdf_bay_hq <span class="op">=</span> gdf_hq.copy()[gdf_hq.geometry.within(regions.loc[<span class="st">"San Francisco Bay Area"</span>].geometry)]</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>sf_bay_county_shapes <span class="op">=</span> county_shapes.copy()[county_shapes[<span class="st">"region"</span>] <span class="op">==</span> <span class="st">"San Francisco Bay Area"</span>]</span></code></pre></div>
</div>
<p>Now lets try to make a plot looking at the distribution of high quality stops in the Bay Area, with the stops plotted over the Bay Area counties.</p>
<p>One immediate issue that arises when making a plot of the San Francisco Bay Area using county shapefiles is that the <a href="https://en.wikipedia.org/wiki/Farallon_Islands#Geography">Farallon Islands</a> are technically part of the administrative boundaries of San Francisco county. You can see the islands on the far left in the following plot of the Bay Area counties.</p>
<div id="6fe903e3" class="cell" data-execution_count="63">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>sf_bay_county_shapes.plot(facecolor<span class="op">=</span><span class="st">"none"</span>)<span class="op">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-55-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Including the islands in an analysis focused on the human population of the Bay Area and the availability of public transit doesn’t seem appropriate, so we want to find a data-driven way to remove that land mass.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption>Here’s a picture of the Farallon Islands, <span class="citation" data-cites="roletto_english_2005">(<a href="#ref-roletto_english_2005" role="doc-biblioref"><strong>roletto_english_2005?</strong></a>)</span> – I don’t see public transit stops.</figcaption>
<p><img src="View_from_Mirounga_Bay.jpg" class="img-fluid figure-img" style="width:50.0%"></p>
</figure>
</div>
<p>The answer starts with an “explosion” – we can use the <a href="https://geopandas.org/en/stable/docs/reference/api/geopandas.GeoDataFrame.explode.html"><code>.explode()</code> method</a> from <code>geopandas</code> to break any multi-part geometries (in this case the multi-part polygon of San Francisco County with some pieces that are non-contiguous) into individual geometries.</p>
<div id="a6fd0290" class="cell" data-execution_count="64">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>exploded_shapes <span class="op">=</span> (</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>    sf_bay_county_shapes</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>    .explode(index_parts<span class="op">=</span><span class="va">True</span>, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>    .reset_index(names<span class="op">=</span><span class="st">'shape_index'</span>)</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Check retention of crs</span></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> sf_bay_county_shapes.crs <span class="op">==</span> exploded_shapes.crs</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Pre-explosion shape"</span>, sf_bay_county_shapes.shape)</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Post-explosion shape"</span>, exploded_shapes.shape)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Pre-explosion shape (7, 20)
Post-explosion shape (8, 21)</code></pre>
</div>
</div>
<p>We can see that, following the explosion, our dataframe has one new geometry – the Farallon Islands. Now we will bring back our <code>points_in_polygon</code> function so that we can count how many high quality public transit stops are in each of the geometries.</p>
<div id="13e5fbab" class="cell" data-execution_count="65">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>exploded_shapes <span class="op">=</span> points_in_polygon(gdf_bay_hq, exploded_shapes, <span class="st">"shape_index"</span>)</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> exploded_shapes.crs <span class="op">==</span> sf_bay_county_shapes.crs</span></code></pre></div>
</div>
<p>We can see that one of these doesn’t have any stops. It’s still called “San Francisco,” but this is the Farallon Islands geometry, which, since they are unpopulated islands, doesn’t contain any transit stops.</p>
<div id="d2f1f92a" class="cell" data-execution_count="66">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>exploded_shapes[[<span class="st">'NAME'</span>, <span class="st">'count'</span>]].head(<span class="dv">3</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="66">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">NAME</th>
<th data-quarto-table-cell-role="th">count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>San Francisco</td>
<td>2091.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>San Francisco</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Marin</td>
<td>76.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We’ll use that as a filtering condition to remove the islands from the dataset, and we arrive at a clean dataset of the populated geometries of the Bay Area counties.</p>
<div id="3bf2b026" class="cell" data-execution_count="67">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>sf_bay_county_shapes <span class="op">=</span> exploded_shapes[exploded_shapes[<span class="st">'count'</span>] <span class="op">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>sf_bay_county_shapes.plot(facecolor<span class="op">=</span><span class="st">"none"</span>)<span class="op">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-59-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Let’s continue refining this. The San Francisco Bay Area is known for being a bay, as in, there is a large body of water at the center of it. This map doesn’t reflect that yet and that’s problematic for plotting the distribution of transit stops in the area. We may see large swaths of map with no stops and assume that it’s a transit desert, when in fact it’s just a body of water.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption>This aerial photo of the Bay Area, <span class="citation" data-cites="tobin_english_2018">(<a href="#ref-tobin_english_2018" role="doc-biblioref"><strong>tobin_english_2018?</strong></a>)</span>, makes clear how much of the region is water</figcaption>
<p><img src="bay_panorama.jpg" class="img-fluid figure-img" style="width:50.0%"></p>
</figure>
</div>
<p>The bodies of water that make up the bay are all part of administrative boundaries of counties, so to include the bay, we will need to break out the geometries for water within each county. This sounds hard, and again, in the past I have <a href="https://github.com/peter-amerkhanian/sf-schools-simulation/blob/b8b956180289e079bef43d15808066eb01f2fa6c/build_city.py#L50C1-L59C29">written custom code to accomplish this</a>, but it’s now incredibly easy using the <code>tigris</code>/<code>pygris</code> package and its useful <code>erase_water()</code> function.</p>
<div id="59acbbaf" class="cell" data-execution_count="68">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>bay_area_no_water <span class="op">=</span> pygris.utils.erase_water(</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>    sf_bay_county_shapes,</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>    year<span class="op">=</span><span class="dv">2024</span>,</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>    cache<span class="op">=</span><span class="va">True</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> bay_area_no_water.crs <span class="op">==</span> sf_bay_county_shapes.crs</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>HTTP download failed, trying FTP as fallback...
Downloading cb_2024_us_county_500k.zip from Census FTP...</code></pre>
</div>
</div>
<p>After using the census’ 2024 water boundaries to remove water from the county shapes, we arrive at the following map.</p>
<div id="c020eb21" class="cell" data-execution_count="69">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>bay_area_no_water.plot(facecolor<span class="op">=</span><span class="st">"none"</span>)<span class="op">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-61-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Now that looks like the Bay Area!<br>
With that base map, I’ll now layer over a heatmap showing the distribution of high quality public transit stops in the Bay Area.</p>
<p>Here I’ll handle the necessary CRS manipulation for working with distances (I again use California Albers), then I aggregate the stop data into 5 kilometer square cells to create the raster grid for the heatmap.</p>
<div id="53674928" class="cell" data-execution_count="71">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Change all data to CA Albers CRS</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>gdf_bay_proj <span class="op">=</span> gdf_bay_hq.to_crs(CA_ALBERS_CRS)</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>bay_area_no_water_proj <span class="op">=</span> bay_area_no_water.to_crs(CA_ALBERS_CRS)</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>sf_bay_county_shapes_proj <span class="op">=</span> sf_bay_county_shapes.to_crs(CA_ALBERS_CRS)</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> gdf_bay_proj.crs <span class="op">==</span> bay_area_no_water_proj.crs</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the raster grid</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>cell_size <span class="op">=</span> <span class="dv">5_000</span></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>bay_arrivals_hist <span class="op">=</span> geospatial_histogram(</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>    gdf_bay_proj, weights<span class="op">=</span><span class="va">None</span>, cell_size<span class="op">=</span>cell_size</span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> bay_arrivals_hist.crs <span class="op">==</span> bay_area_no_water_proj.crs</span></code></pre></div>
</div>
<p>Next I’ll get all of the styling for the plot defined in dictionaries.</p>
<div id="fd0c5816" class="cell" data-execution_count="73">
<details class="code-fold">
<summary>Plot Styling: <code>legend_cbar_kws</code>, <code>data_fill_kws</code>, <code>adjust_kws</code>, <code>text_kws</code>, <code>square_patch</code>, <code>legend_kws</code></summary>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>legend_cbar_kws <span class="op">=</span> {</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"format"</span>: FuncFormatter(number_suffix_formatter),</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"shrink"</span>: <span class="fl">0.8</span>,</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"label"</span>: <span class="st">"Number of High Quality Public Transit Stops"</span>,</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"location"</span>: <span class="st">"top"</span>,</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pad"</span>: <span class="fl">0.001</span>,</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>adjust_kws <span class="op">=</span> {</span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"avoid_self"</span>: <span class="va">True</span>,</span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"expand"</span>: (<span class="dv">7</span>, <span class="dv">3</span>),</span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"arrowprops"</span>: {</span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"arrowstyle"</span>: <span class="st">"-&gt;"</span>,</span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"color"</span>: <span class="st">"black"</span>,</span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"lw"</span>: <span class="dv">1</span>,</span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"connectionstyle"</span>: <span class="st">"arc3,rad=0.01"</span>,</span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true" tabindex="-1"></a>data_fill_kws <span class="op">=</span> {<span class="st">"alpha"</span>: <span class="fl">.75</span>, <span class="st">"cmap"</span>: new_cmap}</span>
<span id="cb67-19"><a href="#cb67-19" aria-hidden="true" tabindex="-1"></a>text_kws <span class="op">=</span> {<span class="st">"fontsize"</span>: <span class="dv">8</span>, <span class="st">"ha"</span>: <span class="st">"center"</span>, <span class="st">"va"</span>: <span class="st">"center"</span>, <span class="st">"color"</span>: <span class="st">"black"</span>}</span>
<span id="cb67-20"><a href="#cb67-20" aria-hidden="true" tabindex="-1"></a>square_patch <span class="op">=</span> mpatches.Rectangle(</span>
<span id="cb67-21"><a href="#cb67-21" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">0</span>, <span class="dv">0</span>), <span class="dv">10</span>, <span class="dv">10</span>, facecolor<span class="op">=</span>new_cmap.get_under(), edgecolor<span class="op">=</span><span class="st">"grey"</span>, linewidth<span class="op">=</span><span class="fl">0.8</span></span>
<span id="cb67-22"><a href="#cb67-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb67-23"><a href="#cb67-23" aria-hidden="true" tabindex="-1"></a>legend_kws <span class="op">=</span> {</span>
<span id="cb67-24"><a href="#cb67-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">'handles'</span>: [square_patch],</span>
<span id="cb67-25"><a href="#cb67-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">'labels'</span>: [<span class="vs">rf"</span><span class="sc">{</span><span class="bu">int</span>(cell_size<span class="op">/</span><span class="dv">1000</span>)<span class="sc">}</span><span class="vs">$\times$</span><span class="sc">{</span><span class="bu">int</span>(cell_size<span class="op">/</span><span class="dv">1000</span>)<span class="sc">}</span><span class="vs">km Grid Area"</span>],</span>
<span id="cb67-26"><a href="#cb67-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">'loc'</span>: <span class="st">"upper left"</span>,</span>
<span id="cb67-27"><a href="#cb67-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">'frameon'</span>: <span class="va">False</span>,</span>
<span id="cb67-28"><a href="#cb67-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">'fontsize'</span>: <span class="dv">9</span>,</span>
<span id="cb67-29"><a href="#cb67-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">'handlelength'</span>: <span class="fl">1.5</span>,</span>
<span id="cb67-30"><a href="#cb67-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">'handleheight'</span>: <span class="dv">2</span>,</span>
<span id="cb67-31"><a href="#cb67-31" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</details>
</div>
<p>Last, I’ll plot the final product, a heatmap of high quality public transit stops in the Bay Area layered over a base map of all land in the region.</p>
<div id="4aadbe39" class="cell" data-execution_count="74">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">4</span>, <span class="dv">6</span>))</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>bay_arrivals_hist.plot(</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>    column<span class="op">=</span><span class="st">"count"</span>,</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">**</span>data_fill_kws,</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">**</span>borders_kws,</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>    vmax<span class="op">=</span><span class="dv">500</span>,</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>    legend<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>    legend_kwds<span class="op">=</span>legend_cbar_kws,</span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>sf_bay_county_shapes_proj.plot(</span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>    edgecolor<span class="op">=</span><span class="st">"black"</span>, facecolor<span class="op">=</span><span class="st">"none"</span>, linewidth<span class="op">=</span><span class="dv">1</span>, alpha<span class="op">=</span><span class="fl">.7</span>,</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax</span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>bay_area_no_water_proj.plot(</span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax, edgecolor<span class="op">=</span><span class="st">"black"</span>, facecolor<span class="op">=</span><span class="st">"grey"</span>, linewidth<span class="op">=</span><span class="dv">1</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, zorder<span class="op">=-</span><span class="dv">1</span></span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a>label_polygon(</span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a>    bay_area_no_water_proj,</span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a>    ax,</span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"NAME"</span>,</span>
<span id="cb68-22"><a href="#cb68-22" aria-hidden="true" tabindex="-1"></a>    adjust_list<span class="op">=</span>[<span class="st">"San Francisco"</span>],</span>
<span id="cb68-23"><a href="#cb68-23" aria-hidden="true" tabindex="-1"></a>    adjust_kws<span class="op">=</span>adjust_kws,</span>
<span id="cb68-24"><a href="#cb68-24" aria-hidden="true" tabindex="-1"></a>    text_kws<span class="op">=</span>text_kws,</span>
<span id="cb68-25"><a href="#cb68-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb68-26"><a href="#cb68-26" aria-hidden="true" tabindex="-1"></a>ax.legend(<span class="op">**</span>legend_kws)</span>
<span id="cb68-27"><a href="#cb68-27" aria-hidden="true" tabindex="-1"></a>ax.axis(<span class="st">"off"</span>)</span>
<span id="cb68-28"><a href="#cb68-28" aria-hidden="true" tabindex="-1"></a>fig.tight_layout()</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-66-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>



</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-barbeau_many_2015" class="csl-entry" role="listitem">
Barbeau, Sean J., and Aaron Antrim. 2015. <span>“The <span>Many</span> <span>Uses</span> of <span>GTFS</span> <span>Data</span> – <span>Opening</span> the <span>Door</span> to <span>Transit</span> and <span>Multimodal</span> <span>Applications</span>.”</span> In <em>2015 <span>Florida</span> <span>Public</span> <span>Transportation</span> <span>Association</span> <span>Annual</span> <span>Training</span> and <span>Conference</span></em>. Daytona Beach, Florida. <a href="https://www.locationaware.usf.edu/wp-content/uploads/2010/02/The-Many-Uses-of-GTFS-Data-%E2%80%93-ITS-America-submission-abbreviated.pdf">https://www.locationaware.usf.edu/wp-content/uploads/2010/02/The-Many-Uses-of-GTFS-Data-%E2%80%93-ITS-America-submission-abbreviated.pdf</a>.
</div>
<div id="ref-charles_dupin_carte_1826" class="csl-entry" role="listitem">
Charles Dupin. 1826. <span>“Carte Figurative de l’instruction Populaire de La <span>France</span>, Par <span>Charles</span> <span>Dupin</span>, 1826.”</span> <a href="https://commons.wikimedia.org/wiki/File:Carte_figurative_de_l%27instruction_populaire_de_la_France.jpg">https://commons.wikimedia.org/wiki/File:Carte_figurative_de_l%27instruction_populaire_de_la_France.jpg</a>.
</div>
<div id="ref-friendly_milestones_2000" class="csl-entry" role="listitem">
Friendly, Michael. 2000. <span>“Milestones in the History of Thematic Cartography, Statistical Graphics, and Data Visualization.”</span> <a href="https://www.usu.edu/math/symanzik/teaching/2009_stat6560/downloads/friendly_milestone.pdf">https://www.usu.edu/math/symanzik/teaching/2009_stat6560/downloads/friendly_milestone.pdf</a>.
</div>
<div id="ref-john_snow_mode_1854" class="csl-entry" role="listitem">
John Snow. 1854. <span>“On the <span>Mode</span> of <span>Communication</span> of <span>Cholera</span>.”</span> <a href="https://commons.wikimedia.org/wiki/File:Snow-cholera-map-1.jpg">https://commons.wikimedia.org/wiki/File:Snow-cholera-map-1.jpg</a>.
</div>
<div id="ref-kennedy_understanding_2000" class="csl-entry" role="listitem">
Kennedy, Melita, and Steve Kopp. 2000. <em>Understanding <span>Map</span> <span>Projections</span></em>. Redlands, CA: Esri Press. <a href="https://content.esri.com/support/documentation/ao_/710understanding_map_projections.pdf">https://content.esri.com/support/documentation/ao_/710understanding_map_projections.pdf</a>.
</div>
<div id="ref-patterson_california_2022" class="csl-entry" role="listitem">
Patterson, Will. 2022. <span>“California <span>Department</span> of <span>Fish</span> and <span>Wildlife</span> <span>Projection</span> and <span>Datum</span> <span>Guidelines</span>.”</span> California Department of Fish; Wildlife. <a href="https://nrm.dfg.ca.gov/FileHandler.ashx?DocumentID=109326">https://nrm.dfg.ca.gov/FileHandler.ashx?DocumentID=109326</a>.
</div>
<div id="ref-tennekes_tmap_2018" class="csl-entry" role="listitem">
Tennekes, Martijn. 2018. <span>“Tmap: <span>Thematic</span> <span>Maps</span> in <span>R</span>.”</span> <em>Journal of Statistical Software</em> 84 (April): 1–39. <a href="https://doi.org/10.18637/jss.v084.i06">https://doi.org/10.18637/jss.v084.i06</a>.
</div>
<div id="ref-walker_analyzing_2023" class="csl-entry" role="listitem">
Walker, Kyle. 2023. <em>Analyzing <span>US</span> <span>Census</span> <span>Data</span></em>. 1st edition. Boca Raton: Chapman; Hall/CRC. <a href="https://walker-data.com/census-r/">https://walker-data.com/census-r/</a>.
</div>
<div id="ref-walker_tigris_2025" class="csl-entry" role="listitem">
———. 2025. <span>“Tigris.”</span> <a href="https://github.com/walkerke/tigris">https://github.com/walkerke/tigris</a>.
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Note I set <code>cache=True</code> so that when I run the code <code>pygris</code> will automatically write out to a folder, <code>cache</code>, and I don’t need to repeat API calls.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{amerkhanian2025,
  author = {Amerkhanian, Peter},
  title = {Thematic Maps with {Python}},
  date = {2025-07-20},
  url = {https://peter-amerkhanian.com/posts/geopandas_maps/},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-amerkhanian2025" class="csl-entry quarto-appendix-citeas" role="listitem">
Amerkhanian, Peter. 2025. <span>“Thematic Maps with Python.”</span> July
20, 2025. <a href="https://peter-amerkhanian.com/posts/geopandas_maps/">https://peter-amerkhanian.com/posts/geopandas_maps/</a>.
</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/peter-amerkhanian\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
          // target, if specified
          link.setAttribute("target", "_blank");
          if (link.getAttribute("rel") === null) {
            link.setAttribute("rel", "noopener");
          }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>Copyright 2024, Peter Amerkhanian</p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>