<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Peter Amerkhanian">
<meta name="dcterms.date" content="2025-07-20">
<meta name="description" content="An overview of several geospatial techniques and some of my favorite GIS packages in python.">

<title>Making some maps with Python – Peter Amerkhanian</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../profile_backup.jpg" rel="icon" type="image/jpeg">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-V95HGLKTEB"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-V95HGLKTEB', { 'anonymize_ip': true});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<meta name="quarto:status" content="draft">


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner"><div id="quarto-draft-alert" class="alert alert-warning"><i class="bi bi-pencil-square"></i>Draft</div>
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../profile_backup.jpg" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Home</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../projects.html"> 
<span class="menu-text">Professional</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">Making some maps with Python</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li></ul></div></div>
                  <div>
        <div class="description">
          An overview of several geospatial techniques and some of my favorite GIS packages in python.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">Python</div>
                <div class="quarto-category">GIS</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Peter Amerkhanian </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">July 20, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
        <h2 id="toc-title"><a href="#" class="nav-link">Making some maps with Python</a></h2>
     
    <ul>
    <li><a href="#question" id="toc-question" class="nav-link active" data-scroll-target="#question">Question</a></li>
    <li><a href="#data" id="toc-data" class="nav-link" data-scroll-target="#data">Data</a>
    <ul class="collapse">
    <li><a href="#gtfs-data-from-cal-itp" id="toc-gtfs-data-from-cal-itp" class="nav-link" data-scroll-target="#gtfs-data-from-cal-itp">GTFS Data from Cal ITP</a></li>
    <li><a href="#census-shapes-with-tigrispygris" id="toc-census-shapes-with-tigrispygris" class="nav-link" data-scroll-target="#census-shapes-with-tigrispygris">Census shapes with <code>tigris</code>/<code>pygris</code></a></li>
    <li><a href="#dealing-with-coordinate-reference-systems" id="toc-dealing-with-coordinate-reference-systems" class="nav-link" data-scroll-target="#dealing-with-coordinate-reference-systems">Dealing with Coordinate Reference Systems</a></li>
    </ul></li>
    <li><a href="#exercise-1-county-choropleth" id="toc-exercise-1-county-choropleth" class="nav-link" data-scroll-target="#exercise-1-county-choropleth">Exercise 1: County Choropleth</a></li>
    <li><a href="#exercise-2-region-choropleth" id="toc-exercise-2-region-choropleth" class="nav-link" data-scroll-target="#exercise-2-region-choropleth">Exercise 2: Region Choropleth</a></li>
    <li><a href="#exercise-3-heatmaps" id="toc-exercise-3-heatmaps" class="nav-link" data-scroll-target="#exercise-3-heatmaps">Exercise 3: Heatmaps</a></li>
    <li><a href="#exercise-4-refining-land" id="toc-exercise-4-refining-land" class="nav-link" data-scroll-target="#exercise-4-refining-land">Exercise 4: Refining Land</a></li>
    <li><a href="#exercise-5-adding-context" id="toc-exercise-5-adding-context" class="nav-link" data-scroll-target="#exercise-5-adding-context">Exercise 5: Adding Context</a>
    <ul class="collapse">
    <li><a href="#physical-infrastructure-features-with-osmnx" id="toc-physical-infrastructure-features-with-osmnx" class="nav-link" data-scroll-target="#physical-infrastructure-features-with-osmnx">Physical Infrastructure Features with <code>osmnx</code></a></li>
    </ul></li>
    </ul>
    <div class="quarto-alternate-formats">
    <ul><li>
    <a id="github" href="#" target="_blank"><i class="bi bi-github"></i>Source Code</a>
  </li></ul>
</div>

  </nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">






<script>
  var githubLink = document.getElementById("github");
  var currentPath = window.location.pathname;
  githubLink.href = "https://github.com/peter-amerkhanian/peter-amerkhanian.github.io/blob/master" + currentPath;
  document.getElementById('toc-title').addEventListener('click', function(event) {
  event.preventDefault(); // Prevent default behavior of anchor tag
  const firstHeader = document.querySelector('body'); // Select the first h2 element
  if (firstHeader) {
    firstHeader.scrollIntoView({ behavior: 'smooth', block: "start", inline: "nearest"}); // Scroll to the first header smoothly
  }
});
</script>
<div id="826d8159" class="cell" data-execution_count="286">
<details class="code-fold">
<summary>Import Statements</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Dataviz</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib <span class="im">as</span> mpl</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.ticker <span class="im">import</span> FuncFormatter</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.patches <span class="im">as</span> mpatches</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.colors <span class="im">import</span> LinearSegmentedColormap</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.patches <span class="im">import</span> Patch</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> adjustText <span class="im">import</span> adjust_text</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Geopatial</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shapely.geometry <span class="im">import</span> box</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> contextily <span class="im">as</span> cx</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pygris.utils</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pygris</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> osmnx <span class="im">as</span> ox</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="co"># IO</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> concurrent.futures <span class="im">import</span> ThreadPoolExecutor, as_completed</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm <span class="im">import</span> tqdm</span></code></pre></div>
</details>
</div>
<p>One of my favorite applications of python is geospatial analysis. Something about making maps, doing spatial joins, calculating distance, etc. feels a little more satisfying than non-spatial analysis. Python happens to have an amazing collection of GIS libraries that seem capable of doing almost any geospatial task I can imagine, from basic plots to spatial statistics to remote sensing and more.</p>
<p>I’m writing this blog post to give myself a brief overview of how I currently use several of those libraries for basic plotting, and to share some spatial workflow functions that I find myself re-coding over and over across projects. My main goal here is that I will have somewhere to go for boilerplate code/tutorials for myself, but hopefully an external reader gets some value out of it too.</p>
<p>I’ll cover the following:</p>
<ul>
<li><strong>Some examples of Spatial Data</strong>: GTFS transit data, U.S. Census shape files, and dealing with Coordinate Reference Systems across different datasets.</li>
<li><strong>Plotting distributions across space</strong>: I’ll cover distributions across administrative boundaries and geospatial histograms.</li>
<li><strong>Zooming in</strong>, panning, and otherwise refining plots in <code>geopandas</code>.</li>
<li><strong>Incorporating Geographic Features</strong>: bringing in rail lines from <code>osmnx</code> and base maps from <code>contextily</code> to make web maps.</li>
</ul>
<section id="question" class="level2">
<h2 class="anchored" data-anchor-id="question">Question</h2>
<p>I’ll base this post around a series of five exercises that seek to answer one overarching question:</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Motivating Question">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Motivating Question
</div>
</div>
<div class="callout-body-container callout-body">
<p>How does the distribution of public transit stops in California vary by geography?</p>
</div>
</div>
<p>In the exercises, I’ll make plots that investigate this at various geographic levels and in subregions within California.</p>
</section>
<section id="data" class="level2">
<h2 class="anchored" data-anchor-id="data">Data</h2>
<section id="gtfs-data-from-cal-itp" class="level3">
<h3 class="anchored" data-anchor-id="gtfs-data-from-cal-itp">GTFS Data from Cal ITP</h3>
<p>I will be using open data from CalTrans’ <a href="https://github.com/cal-itp/data-analyses/blob/main/high_quality_transit_areas/README.md">High Quality Transit Areas Analysis</a>. While that analysis is focused on defining high quality transit areas, they make their intermediary transit-stop dataset and high quality transit-stop datasets available to the public. Thanks, CalTrans!</p>
<p>The data that CalTrans are using are derived from “General Transit Feed Specification,” or, GTFS data. GTFS is “a standardized data format that provides a structure for public transit agencies to describe the details of their services such as schedules, stops, fares, etc.” It was initially developed for Google Maps (<a href="https://en.wikipedia.org/wiki/GTFS#History">more on the history here</a>). The specific standards of GTFS are all documented at <a href="https://gtfs.org/getting-started/what-is-GTFS/">gtfs.org</a>.</p>
<p>Anyways, I’ll grab the CalTrans transit-stop data via parallel API requests (see the folded code for the details). This code should theoretically work with any ArcGIS API and can speed up the pagination through the chunks of data the API returns (they limit chunk size).</p>
<div id="ac231b05" class="cell" data-execution_count="287">
<details class="code-fold">
<summary>Code for parallel API calls: <code>paginate_api</code></summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fetch_gdf(url, offset, chunksize):</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    params <span class="op">=</span> {</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">"outFields"</span>: <span class="st">"*"</span>,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">"where"</span>: <span class="st">"1=1"</span>,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"f"</span>: <span class="st">"geojson"</span>,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"resultOffset"</span>: offset,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"resultRecordCount"</span>: chunksize,</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> requests.get(url, params<span class="op">=</span>params, timeout<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>        response.raise_for_status()</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> gpd.read_file(response.text)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Failed at offset </span><span class="sc">{</span>offset<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> gpd.GeoDataFrame()</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> paginate_api(url):</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    CHUNK_SIZE <span class="op">=</span> <span class="dv">2000</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    MAX_WORKERS <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get total record count</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    count_url <span class="op">=</span> url <span class="op">+</span> <span class="st">"?where=1=1&amp;returnCountOnly=true&amp;f=json"</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    max_records <span class="op">=</span> requests.get(count_url).json()[<span class="st">"count"</span>]</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Total records: </span><span class="sc">{</span>max_records<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Download in parallel with TQDM</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    offsets <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">0</span>, max_records, CHUNK_SIZE))</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    gdfs <span class="op">=</span> []</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> ThreadPoolExecutor(max_workers<span class="op">=</span>MAX_WORKERS) <span class="im">as</span> executor:</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>        futures <span class="op">=</span> {</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>            executor.submit(fetch_gdf, url, offset, CHUNK_SIZE): offset</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> offset <span class="kw">in</span> offsets</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> future <span class="kw">in</span> tqdm(</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>            as_completed(futures), total<span class="op">=</span><span class="bu">len</span>(futures), desc<span class="op">=</span><span class="st">"Downloading"</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>        ):</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>            gdf <span class="op">=</span> future.result()</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>            gdfs.append(gdf)</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Combine all chunks</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>    full_gdf <span class="op">=</span> gpd.GeoDataFrame(</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>        pd.concat(gdfs, ignore_index<span class="op">=</span><span class="va">True</span>), crs<span class="op">=</span>gdfs[<span class="dv">0</span>].crs <span class="cf">if</span> gdfs <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Final output</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Final GeoDataFrame shape: </span><span class="sc">{</span>full_gdf<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> full_gdf.shape[<span class="dv">0</span>] <span class="op">==</span> max_records</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> full_gdf</span></code></pre></div>
</details>
</div>
<div id="44decc28" class="cell" data-execution_count="288">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>rest_api <span class="op">=</span> <span class="st">"https://caltrans-gis.dot.ca.gov/arcgis/rest/"</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>all_stops <span class="op">=</span> <span class="st">"services/CHrailroad/CA_Transit_Stops/FeatureServer/0/query"</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>gdf_all <span class="op">=</span> paginate_api(rest_api <span class="op">+</span> all_stops)</span></code></pre></div>
</div>
<p>The resulting dataset contains each public transit stop in California, with various pieces of information about that stop.</p>
<div id="cbb716c9" class="cell" data-execution_count="289">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>gdf_all[[<span class="st">'district_name'</span>, <span class="st">'agency'</span>, <span class="st">'stop_id'</span>, <span class="st">'n_routes'</span>,</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>         <span class="st">'stop_name'</span>, <span class="st">'n_arrivals'</span>, <span class="st">'geometry'</span>]].head()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="289">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">district_name</th>
<th data-quarto-table-cell-role="th">agency</th>
<th data-quarto-table-cell-role="th">stop_id</th>
<th data-quarto-table-cell-role="th">n_routes</th>
<th data-quarto-table-cell-role="th">stop_name</th>
<th data-quarto-table-cell-role="th">n_arrivals</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>04 - Bay Area / Oakland</td>
<td>Alameda-Contra Costa Transit District</td>
<td>52546</td>
<td>1</td>
<td>5th Avenue SB</td>
<td>110</td>
<td>POINT (-122.25336 37.79369)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>04 - Bay Area / Oakland</td>
<td>Alameda-Contra Costa Transit District</td>
<td>52573</td>
<td>1</td>
<td>Madison SB</td>
<td>110</td>
<td>POINT (-122.26564 37.79951)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>04 - Bay Area / Oakland</td>
<td>Alameda-Contra Costa Transit District</td>
<td>52579</td>
<td>1</td>
<td>Uptown Oakland SB</td>
<td>110</td>
<td>POINT (-122.26868 37.80854)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>04 - Bay Area / Oakland</td>
<td>Alameda-Contra Costa Transit District</td>
<td>52596</td>
<td>1</td>
<td>31st Avenue</td>
<td>110</td>
<td>POINT (-122.22684 37.77807)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>04 - Bay Area / Oakland</td>
<td>Alameda-Contra Costa Transit District</td>
<td>52601</td>
<td>1</td>
<td>Fruitvale</td>
<td>110</td>
<td>POINT (-122.22344 37.77644)</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>I noticed that a lot of geographic points that have a public transit stop are counted several times, perhaps to reflect different routes, modes of transit, etc. I’m really just interested in analyzing the distribution of unique physical “stops” without consideration of stop characteristics, so I just drop duplicates based on geometry to get every unique geographic point with a transit stop.</p>
<div id="eea0e43b" class="cell" data-execution_count="290">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>gdf_all <span class="op">=</span> gdf_all.drop_duplicates(subset<span class="op">=</span><span class="st">'geometry'</span>)</span></code></pre></div>
</div>
<p>I always like to do quick checks on geospatial data via calls to <code>geopandas</code>’s <code>.explore()</code> method, which produces interactive plots in one line of code, no external library imports (e.g.&nbsp;<code>folium</code>) or javascript required.</p>
<p>I’ll look at the stops at San Pablo Ave. and Dwight Way in Berkeley, CA.</p>
<div id="5a5b27cf" class="cell" data-execution_count="291">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>gdf_all[gdf_all[<span class="st">'stop_name'</span>] <span class="op">==</span> <span class="st">'San Pablo Av &amp; Dwight Way'</span>].explore(</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    style_kwds<span class="op">=</span><span class="bu">dict</span>(fillOpacity<span class="op">=</span><span class="fl">0.7</span>, radius<span class="op">=</span><span class="dv">12</span>, color<span class="op">=</span><span class="st">'red'</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    )</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="291">
<div style="width:100%;"><div style="position:relative;width:100%;height:0;padding-bottom:60%;"><span style="color:#565656">Make this Notebook Trusted to load map: File -&gt; Trust Notebook</span><iframe srcdoc="<!DOCTYPE html>
<html>
<head>
    
    <meta http-equiv=&quot;content-type&quot; content=&quot;text/html; charset=UTF-8&quot; />
    <script src=&quot;https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js&quot;></script>
    <script src=&quot;https://code.jquery.com/jquery-3.7.1.min.js&quot;></script>
    <script src=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js&quot;></script>
    <script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js&quot;></script>
    <link rel=&quot;stylesheet&quot; href=&quot;https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css&quot;/>
    <link rel=&quot;stylesheet&quot; href=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css&quot;/>
    <link rel=&quot;stylesheet&quot; href=&quot;https://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css&quot;/>
    <link rel=&quot;stylesheet&quot; href=&quot;https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css&quot;/>
    <link rel=&quot;stylesheet&quot; href=&quot;https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css&quot;/>
    <link rel=&quot;stylesheet&quot; href=&quot;https://cdn.jsdelivr.net/gh/python-visualization/folium/folium/templates/leaflet.awesome.rotate.min.css&quot;/>
    
            <meta name=&quot;viewport&quot; content=&quot;width=device-width,
                initial-scale=1.0, maximum-scale=1.0, user-scalable=no&quot; />
            <style>
                #map_9162964ca8298dae5ba9a0f07f7753dc {
                    position: relative;
                    width: 100.0%;
                    height: 100.0%;
                    left: 0.0%;
                    top: 0.0%;
                }
                .leaflet-container { font-size: 1rem; }
            </style>

            <style>html, body {
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }
            </style>

            <style>#map {
                position:absolute;
                top:0;
                bottom:0;
                right:0;
                left:0;
                }
            </style>

            <script>
                L_NO_TOUCH = false;
                L_DISABLE_3D = false;
            </script>

        
    
                    <style>
                        .foliumtooltip {
                            
                        }
                       .foliumtooltip table{
                            margin: auto;
                        }
                        .foliumtooltip tr{
                            text-align: left;
                        }
                        .foliumtooltip th{
                            padding: 2px; padding-right: 8px;
                        }
                    </style>
            
</head>
<body>
    
    
            <div class=&quot;folium-map&quot; id=&quot;map_9162964ca8298dae5ba9a0f07f7753dc&quot; ></div>
        
</body>
<script>
    
    
            var map_9162964ca8298dae5ba9a0f07f7753dc = L.map(
                &quot;map_9162964ca8298dae5ba9a0f07f7753dc&quot;,
                {
                    center: [37.86113000021032, -122.28956450025885],
                    crs: L.CRS.EPSG3857,
                    ...{
  &quot;zoom&quot;: 10,
  &quot;zoomControl&quot;: true,
  &quot;preferCanvas&quot;: false,
}

                }
            );
            L.control.scale().addTo(map_9162964ca8298dae5ba9a0f07f7753dc);

            

        
    
            var tile_layer_05bcdc99c720bee75f5516330c58503c = L.tileLayer(
                &quot;https://tile.openstreetmap.org/{z}/{x}/{y}.png&quot;,
                {
  &quot;minZoom&quot;: 0,
  &quot;maxZoom&quot;: 19,
  &quot;maxNativeZoom&quot;: 19,
  &quot;noWrap&quot;: false,
  &quot;attribution&quot;: &quot;\u0026copy; \u003ca href=\&quot;https://www.openstreetmap.org/copyright\&quot;\u003eOpenStreetMap\u003c/a\u003e contributors&quot;,
  &quot;subdomains&quot;: &quot;abc&quot;,
  &quot;detectRetina&quot;: false,
  &quot;tms&quot;: false,
  &quot;opacity&quot;: 1,
}

            );
        
    
            tile_layer_05bcdc99c720bee75f5516330c58503c.addTo(map_9162964ca8298dae5ba9a0f07f7753dc);
        
    
            map_9162964ca8298dae5ba9a0f07f7753dc.fitBounds(
                [[37.86079400026471, -122.28958300016382], [37.861466000155936, -122.2895460003539]],
                {}
            );
        
    
        function geo_json_338666be5e18b015a6aeb2047951227d_styler(feature) {
            switch(feature.id) {
                default:
                    return {&quot;color&quot;: &quot;red&quot;, &quot;fillOpacity&quot;: 0.7, &quot;radius&quot;: 12, &quot;weight&quot;: 2};
            }
        }
        function geo_json_338666be5e18b015a6aeb2047951227d_highlighter(feature) {
            switch(feature.id) {
                default:
                    return {&quot;fillOpacity&quot;: 0.75};
            }
        }
        function geo_json_338666be5e18b015a6aeb2047951227d_pointToLayer(feature, latlng) {
            var opts = {
  &quot;stroke&quot;: true,
  &quot;color&quot;: &quot;#3388ff&quot;,
  &quot;weight&quot;: 3,
  &quot;opacity&quot;: 1.0,
  &quot;lineCap&quot;: &quot;round&quot;,
  &quot;lineJoin&quot;: &quot;round&quot;,
  &quot;dashArray&quot;: null,
  &quot;dashOffset&quot;: null,
  &quot;fill&quot;: true,
  &quot;fillColor&quot;: &quot;#3388ff&quot;,
  &quot;fillOpacity&quot;: 0.2,
  &quot;fillRule&quot;: &quot;evenodd&quot;,
  &quot;bubblingMouseEvents&quot;: true,
  &quot;radius&quot;: 2,
};
            
            let style = geo_json_338666be5e18b015a6aeb2047951227d_styler(feature)
            Object.assign(opts, style)
            
            return new L.CircleMarker(latlng, opts)
        }

        function geo_json_338666be5e18b015a6aeb2047951227d_onEachFeature(feature, layer) {

            layer.on({
                mouseout: function(e) {
                    if(typeof e.target.setStyle === &quot;function&quot;){
                            geo_json_338666be5e18b015a6aeb2047951227d.resetStyle(e.target);
                    }
                },
                mouseover: function(e) {
                    if(typeof e.target.setStyle === &quot;function&quot;){
                        const highlightStyle = geo_json_338666be5e18b015a6aeb2047951227d_highlighter(e.target.feature)
                        e.target.setStyle(highlightStyle);
                    }
                },
            });
        };
        var geo_json_338666be5e18b015a6aeb2047951227d = L.geoJson(null, {
                onEachFeature: geo_json_338666be5e18b015a6aeb2047951227d_onEachFeature,
            
                style: geo_json_338666be5e18b015a6aeb2047951227d_styler,
                pointToLayer: geo_json_338666be5e18b015a6aeb2047951227d_pointToLayer,
            ...{
}
        });

        function geo_json_338666be5e18b015a6aeb2047951227d_add (data) {
            geo_json_338666be5e18b015a6aeb2047951227d
                .addData(data);
        }
            geo_json_338666be5e18b015a6aeb2047951227d_add({&quot;bbox&quot;: [-122.28958300016382, 37.86079400026471, -122.2895460003539, 37.861466000155936], &quot;features&quot;: [{&quot;bbox&quot;: [-122.2895460003539, 37.861466000155936, -122.2895460003539, 37.861466000155936], &quot;geometry&quot;: {&quot;coordinates&quot;: [-122.2895460003539, 37.861466000155936], &quot;type&quot;: &quot;Point&quot;}, &quot;id&quot;: &quot;73&quot;, &quot;properties&quot;: {&quot;OBJECTID&quot;: 6074, &quot;agency&quot;: &quot;Alameda-Contra Costa Transit District&quot;, &quot;base64_url&quot;: &quot;aHR0cHM6Ly9hcGkuNTExLm9yZy90cmFuc2l0L2RhdGFmZWVkcz9vcGVyYXRvcl9pZD1BQw==&quot;, &quot;district_name&quot;: &quot;04 - Bay Area / Oakland&quot;, &quot;meters_to_ca_state_highway&quot;: 7.7, &quot;n_arrivals&quot;: 143, &quot;n_hours_in_service&quot;: 24, &quot;n_routes&quot;: 4, &quot;org_id&quot;: &quot;recOZgevYf7Jimm9L&quot;, &quot;route_ids_served&quot;: &quot;72, 72M, 72R, 802&quot;, &quot;routetypes&quot;: &quot;3&quot;, &quot;stop_id&quot;: &quot;55880&quot;, &quot;stop_name&quot;: &quot;San Pablo Av \u0026 Dwight Way&quot;}, &quot;type&quot;: &quot;Feature&quot;}, {&quot;bbox&quot;: [-122.28958300016382, 37.86079400026471, -122.28958300016382, 37.86079400026471], &quot;geometry&quot;: {&quot;coordinates&quot;: [-122.28958300016382, 37.86079400026471], &quot;type&quot;: &quot;Point&quot;}, &quot;id&quot;: &quot;77&quot;, &quot;properties&quot;: {&quot;OBJECTID&quot;: 6078, &quot;agency&quot;: &quot;Alameda-Contra Costa Transit District&quot;, &quot;base64_url&quot;: &quot;aHR0cHM6Ly9hcGkuNTExLm9yZy90cmFuc2l0L2RhdGFmZWVkcz9vcGVyYXRvcl9pZD1BQw==&quot;, &quot;district_name&quot;: &quot;04 - Bay Area / Oakland&quot;, &quot;meters_to_ca_state_highway&quot;: 1.5, &quot;n_arrivals&quot;: 145, &quot;n_hours_in_service&quot;: 24, &quot;n_routes&quot;: 4, &quot;org_id&quot;: &quot;recOZgevYf7Jimm9L&quot;, &quot;route_ids_served&quot;: &quot;72, 72M, 72R, 802&quot;, &quot;routetypes&quot;: &quot;3&quot;, &quot;stop_id&quot;: &quot;57755&quot;, &quot;stop_name&quot;: &quot;San Pablo Av \u0026 Dwight Way&quot;}, &quot;type&quot;: &quot;Feature&quot;}], &quot;type&quot;: &quot;FeatureCollection&quot;});

        
    
    geo_json_338666be5e18b015a6aeb2047951227d.bindTooltip(
    function(layer){
    let div = L.DomUtil.create('div');
    
    let handleObject = feature => {
        if (feature === null) {
            return '';
        } else if (typeof(feature)=='object') {
            return JSON.stringify(feature);
        } else {
            return feature;
        }
    }
    let fields = [&quot;OBJECTID&quot;, &quot;org_id&quot;, &quot;agency&quot;, &quot;stop_id&quot;, &quot;stop_name&quot;, &quot;n_routes&quot;, &quot;route_ids_served&quot;, &quot;routetypes&quot;, &quot;n_arrivals&quot;, &quot;n_hours_in_service&quot;, &quot;meters_to_ca_state_highway&quot;, &quot;base64_url&quot;, &quot;district_name&quot;];
    let aliases = [&quot;OBJECTID&quot;, &quot;org_id&quot;, &quot;agency&quot;, &quot;stop_id&quot;, &quot;stop_name&quot;, &quot;n_routes&quot;, &quot;route_ids_served&quot;, &quot;routetypes&quot;, &quot;n_arrivals&quot;, &quot;n_hours_in_service&quot;, &quot;meters_to_ca_state_highway&quot;, &quot;base64_url&quot;, &quot;district_name&quot;];
    let table = '<table>' +
        String(
        fields.map(
        (v,i)=>
        `<tr>
            <th>${aliases[i]}</th>
            
            <td>${handleObject(layer.feature.properties[v])}</td>
        </tr>`).join(''))
    +'</table>';
    div.innerHTML=table;
    
    return div
    }
    ,{
  &quot;sticky&quot;: true,
  &quot;className&quot;: &quot;foliumtooltip&quot;,
});
                     
    
            geo_json_338666be5e18b015a6aeb2047951227d.addTo(map_9162964ca8298dae5ba9a0f07f7753dc);
        
</script>
</html>" style="position:absolute;width:100%;height:100%;left:0;top:0;border:none !important;" allowfullscreen="" webkitallowfullscreen="" mozallowfullscreen=""></iframe></div></div>
</div>
</div>
<p>Looks about how I’d expect! Now, returning to the motivating question:</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Motivating Question">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Motivating Question
</div>
</div>
<div class="callout-body-container callout-body">
<p>How does the distribution of public transit stops in California vary by geography?</p>
</div>
</div>
<p>We now have public transit stop data, but to answer this question we also need to be able to place those stops within “areas,” defined broadly. For that, I’ll go to the census’ shapefile database.</p>
</section>
<section id="census-shapes-with-tigrispygris" class="level3">
<h3 class="anchored" data-anchor-id="census-shapes-with-tigrispygris">Census shapes with <code>tigris</code>/<code>pygris</code></h3>
<p>In my experience it’s rare that Census data are <strong>not</strong> essential to doing geospatial analysis within the U.S. I’m making some plots of transit stops within California, and so off the bat I know that I will want the administrative boundaries of California and its counties to contextualize those stops. That means I need <a href="https://en.wikipedia.org/wiki/Shapefile">shapefiles</a>, which the Census maintains.</p>
<div class="callout callout-style-default callout-note callout-titled" title="Census data and Kyle Walker">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Census data and Kyle Walker
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The universe of Census data – shapefiles and survey data – is large and confusing. Thankfully, a few extremely generous organizations and individuals have undertaken the herculean task of developing open source tools and documentation to make census data easy. I’ve blogged elsewhere about IPUMS and Geocorr, but here I’m going to highlight some of the work of <a href="https://walker-data.com/">Kyle Walker</a>.</p>
<p>Whenever I need a reference on aggregate Census data or mapping, I turn to <a href="https://walker-data.com/census-r/">“Analyzing U.S. Census Data” by Kyle Walker</a>. The book and accompanying geospatial libraries are written for R users, but almost all of it applies directly in python, and the author has created python ports or else blog posts with python code that cover much of the material. In practice his libraries are so good that when there isn’t a direct python port for one of his R packages (e.g.&nbsp;tidycensus), I take the trouble of using R just for that package.</p>
</div>
</div>
</div>
<p>Census shapefiles are maintained in the Census’ <a href="https://www.census.gov/geographies/mapping-files/time-series/geo/tiger-geodatabase-file.html">TIGER/Line geodatabase</a>, which contains the shapes of basically any administrative or political boundary you could think of within the U.S. One can download files via the census’ <a href="https://www2.census.gov/geo/tiger/">FTP archive</a> (I’ve unfortunately <a href="https://github.com/peter-amerkhanian/sf-schools-simulation/blob/main/build_city.py">written a fair amount of code</a> to do this in the past), but it’s so much easier to just use the excellent <a href="https://github.com/walkerke/tigris"><code>tigris</code></a>/<a href="https://walker-data.com/pygris/"><code>pygris</code></a> package that Kyle Walker developed for simplifying access to TIGER/Line shapefiles. Check out the Walker text’s <a href="https://walker-data.com/census-r/census-geographic-data-and-applications-in-r.html">chapter on TIGER/Line data here</a>.</p>
<p>Using <code>tigris</code>/<code>pygris</code> is very simple – I just call the <code>states()</code> function for a given year, and it will return the outlines of every state in the U.S. as set in 2024 (note that the boundaries typically do not change for states, but they do change for some smaller geographies). I set <code>cache=True</code> and when I run the code <code>pygris</code> will automatically write out to a folder, <code>cache</code>, so that I don’t need to repeat API calls.</p>
<div id="1f31a346" class="cell" data-execution_count="292">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>state_shapes <span class="op">=</span> pygris.states(cache<span class="op">=</span><span class="va">True</span>, year<span class="op">=</span><span class="dv">2024</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>state_shapes.head(<span class="dv">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="292">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">STATEFP</th>
<th data-quarto-table-cell-role="th">STATENS</th>
<th data-quarto-table-cell-role="th">GEOIDFQ</th>
<th data-quarto-table-cell-role="th">GEOID</th>
<th data-quarto-table-cell-role="th">STUSPS</th>
<th data-quarto-table-cell-role="th">NAME</th>
<th data-quarto-table-cell-role="th">LSAD</th>
<th data-quarto-table-cell-role="th">ALAND</th>
<th data-quarto-table-cell-role="th">AWATER</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>35</td>
<td>00897535</td>
<td>0400000US35</td>
<td>35</td>
<td>NM</td>
<td>New Mexico</td>
<td>00</td>
<td>314198519809</td>
<td>726531289</td>
<td>POLYGON ((-109.05017 31.48, -109.04984 31.4995...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>46</td>
<td>01785534</td>
<td>0400000US46</td>
<td>46</td>
<td>SD</td>
<td>South Dakota</td>
<td>00</td>
<td>196341670967</td>
<td>3387563375</td>
<td>POLYGON ((-104.05788 44.9976, -104.05078 44.99...</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Here’s just California:</p>
<div id="50695242" class="cell" data-execution_count="293">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>california <span class="op">=</span> state_shapes[state_shapes[<span class="st">"GEOID"</span>] <span class="op">==</span> <span class="st">"06"</span>]</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>california <span class="op">=</span> california.set_index(<span class="st">"NAME"</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>california</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="293">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">STATEFP</th>
<th data-quarto-table-cell-role="th">STATENS</th>
<th data-quarto-table-cell-role="th">GEOIDFQ</th>
<th data-quarto-table-cell-role="th">GEOID</th>
<th data-quarto-table-cell-role="th">STUSPS</th>
<th data-quarto-table-cell-role="th">LSAD</th>
<th data-quarto-table-cell-role="th">ALAND</th>
<th data-quarto-table-cell-role="th">AWATER</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">NAME</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">California</td>
<td>06</td>
<td>01779778</td>
<td>0400000US06</td>
<td>06</td>
<td>CA</td>
<td>00</td>
<td>403673433805</td>
<td>20291632828</td>
<td>MULTIPOLYGON (((-118.60442 33.47855, -118.5987...</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Here I’ll do the same with <code>counties()</code>, retrieving the boundaries for all of the counties within California (<code>state="06"</code>) in 2024.</p>
<div id="40d5470c" class="cell" data-execution_count="294">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>county_shapes <span class="op">=</span> pygris.counties(state<span class="op">=</span><span class="st">"06"</span>, year<span class="op">=</span><span class="st">'2024'</span>, cache<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>county_shapes[[<span class="st">'NAMELSAD'</span>, <span class="st">'geometry'</span>]].head()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="294">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">NAMELSAD</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>Sierra County</td>
<td>POLYGON ((-120.55587 39.50874, -120.55614 39.5...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">324</td>
<td>Sacramento County</td>
<td>POLYGON ((-121.43991 38.25553, -121.44002 38.2...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">328</td>
<td>Santa Barbara County</td>
<td>MULTIPOLYGON (((-120.58226 34.10752, -120.5790...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">345</td>
<td>Calaveras County</td>
<td>POLYGON ((-120.6318 38.34603, -120.63066 38.34...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">393</td>
<td>Ventura County</td>
<td>MULTIPOLYGON (((-119.63607 33.28071, -119.6348...</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>When we plot them together, it looks like we have the administrative boundaries we wanted.</p>
<div id="615e6768" class="cell" data-execution_count="295">
<details class="code-fold">
<summary>Plot Code: Counties and States from <code>pygris</code></summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">5</span>, <span class="dv">3</span>))</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].<span class="bu">set</span>(title<span class="op">=</span><span class="st">"Counties"</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">0</span>].set_axis_off()</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].<span class="bu">set</span>(title<span class="op">=</span><span class="st">"State"</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>ax[<span class="dv">1</span>].set_axis_off()</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>county_shapes.plot(facecolor<span class="op">=</span><span class="st">"none"</span>, ax<span class="op">=</span>ax[<span class="dv">0</span>])</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>california.plot(facecolor<span class="op">=</span><span class="st">"none"</span>, ax<span class="op">=</span>ax[<span class="dv">1</span>])<span class="op">;</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-11-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="dealing-with-coordinate-reference-systems" class="level3">
<h3 class="anchored" data-anchor-id="dealing-with-coordinate-reference-systems">Dealing with Coordinate Reference Systems</h3>
<p>When thinking about spatial data, it may occur to you that we face a bit of a Fundamental Problem. The world is 3 dimensional and relatively spherical, whereas maps are 2 dimensional and flat. Thus, maps are abstract representations of reality. They project the 3 dimensional world into 2 dimensions with <em>reasonable accuracy</em>, but they inevitably lose some degree of accuracy in the process (see <a href="https://docs.qgis.org/3.40/en/docs/gentle_gis_introduction/coordinate_reference_systems.html#accuracy-of-map-projections">accuracy of map projections</a>). Cartographers have developed a whole world of different 3D -&gt; 2D <strong>map projections</strong>, typically designed with specific uses and geographies (e.g.&nbsp;distance calculation in north america) in mind, which makes choosing the right projection important…</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption>Examples of a Geographic Coordinate System (GCS) and a Projected Coordinate System (PCS) <a href="https://www.esri.com/arcgis-blog/products/arcgis-pro/mapping/gcs_vs_pcs">from ESRI.</a></figcaption>
<p><img src="grid2.png" class="img-fluid figure-img" style="width:80.0%"></p>
</figure>
</div>
<p>When we talk about different map projections, we describe them in terms of their coordinate reference system (CRS), which defines, with the help of coordinates, how the two-dimensional, projected map is related to real locations on the earth. For reference, here are all of the CRS that I will use in this post:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Purpose</th>
<th>CRS Name</th>
<th>EPSG</th>
<th>Type</th>
<th>Units</th>
<th>Region</th>
<th>Organizations / Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Plotting</td>
<td><a href="https://en.wikipedia.org/wiki/World_Geodetic_System#WGS84">WGS 84</a></td>
<td>4326</td>
<td>Geographic</td>
<td>Degrees</td>
<td>Global</td>
<td>Used globally for web and GPS data, published and maintained by the U.S. Department of Defense.</td>
</tr>
<tr class="even">
<td>Plotting</td>
<td><a href="https://en.wikipedia.org/wiki/North_American_Datum#">NAD83</a></td>
<td>4269</td>
<td>Geographic</td>
<td>Degrees</td>
<td>North America</td>
<td>US Census Bureau, USGS; preferred for U.S. datasets</td>
</tr>
<tr class="odd">
<td>Web Mapping</td>
<td><a href="https://en.wikipedia.org/wiki/Web_Mercator_projection#">WGS 84 / Pseudo-Mercator</a></td>
<td>3857</td>
<td>Projected</td>
<td>Meters</td>
<td>Global</td>
<td>Default for web maps (Leaflet, Mapbox); <strong>distorts area and distance – exercise caution!</strong></td>
</tr>
<tr class="even">
<td>Spatial Analysis</td>
<td>NAD83 / California Albers</td>
<td>3310</td>
<td>Projected</td>
<td>Meters</td>
<td>California</td>
<td>CA state agencies, minimizes distortion across the state</td>
</tr>
</tbody>
</table>
<div id="463437c0" class="cell" data-execution_count="382">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>NAD_CRS <span class="op">=</span> <span class="st">"EPSG:4269"</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>CA_ALBERS_CRS <span class="op">=</span> <span class="st">"EPSG:3310"</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>PSEUDO_MERCATOR_CRS <span class="op">=</span> <span class="st">"EPSG:3857"</span></span></code></pre></div>
</div>
<p>The public transit stop data from the CalTrans come in a common and versatile CRS, <a href="https://en.wikipedia.org/wiki/World_Geodetic_System#WGS84">World Geodetic System (WGS) 84</a>, also known as <a href="https://epsg.io/4326?utm_source=chatgpt.com"><code>EPSG:4326</code></a>. Many global or multi-national datasets use <strong>WGS 84</strong>, including the Google Earth service. WGS84 is “geodetic,” meaning that distance is measured in longitudinal/latitudinal degrees.</p>
<div id="f852f5e9" class="cell" data-execution_count="296">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>gdf_all.crs</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="296">
<pre><code>&lt;Geographic 2D CRS: EPSG:4326&gt;
Name: WGS 84
Axis Info [ellipsoidal]:
- Lat[north]: Geodetic latitude (degree)
- Lon[east]: Geodetic longitude (degree)
Area of Use:
- name: World.
- bounds: (-180.0, -90.0, 180.0, 90.0)
Datum: World Geodetic System 1984 ensemble
- Ellipsoid: WGS 84
- Prime Meridian: Greenwich</code></pre>
</div>
</div>
<p>U.S. Census TIGER/Line data typically use <a href="https://en.wikipedia.org/wiki/North_American_Datum">North American Datum (NAD) 83</a>, EPSG code <a href="https://epsg.io/4269"><code>4269</code></a>. <strong>NAD83</strong> is commonly used by U.S. Federal Agencies and, like WGS84, it is “geodetic” and measures distance in degrees. Unlike WGS84, NAD83 is optimized for geographic accuracy within the United States.</p>
<div id="aacda072" class="cell" data-execution_count="297">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> california.crs <span class="op">==</span> county_shapes.crs</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>california.crs</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="297">
<pre><code>&lt;Geographic 2D CRS: EPSG:4269&gt;
Name: NAD83
Axis Info [ellipsoidal]:
- Lat[north]: Geodetic latitude (degree)
- Lon[east]: Geodetic longitude (degree)
Area of Use:
- name: North America - onshore and offshore: Canada - Alberta; British Columbia; Manitoba; New Brunswick; Newfoundland and Labrador; Northwest Territories; Nova Scotia; Nunavut; Ontario; Prince Edward Island; Quebec; Saskatchewan; Yukon. Puerto Rico. United States (USA) - Alabama; Alaska; Arizona; Arkansas; California; Colorado; Connecticut; Delaware; Florida; Georgia; Hawaii; Idaho; Illinois; Indiana; Iowa; Kansas; Kentucky; Louisiana; Maine; Maryland; Massachusetts; Michigan; Minnesota; Mississippi; Missouri; Montana; Nebraska; Nevada; New Hampshire; New Jersey; New Mexico; New York; North Carolina; North Dakota; Ohio; Oklahoma; Oregon; Pennsylvania; Rhode Island; South Carolina; South Dakota; Tennessee; Texas; Utah; Vermont; Virginia; Washington; West Virginia; Wisconsin; Wyoming. US Virgin Islands. British Virgin Islands.
- bounds: (167.65, 14.92, -40.73, 86.45)
Datum: North American Datum 1983
- Ellipsoid: GRS 1980
- Prime Meridian: Greenwich</code></pre>
</div>
</div>
<p>When working with multiple datasets, it’s important to ensure that they share the same CRS. In GeoPandas, CRS alignment and conversion are straightforward. I’d like to work in the CRS provided by the U.S. Census – NAD83. I use simple variable assignment in python to bring the stops dataset (currently in WGS84) into NAD83.</p>
<div id="b1b52167" class="cell" data-execution_count="298">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>target_crs <span class="op">=</span> california.crs</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>gdf_all.crs <span class="op">=</span> target_crs</span></code></pre></div>
</div>
<div id="328773ff" class="cell" data-execution_count="299">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> gdf_all.crs <span class="op">==</span> california.crs</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(gdf_all.crs, <span class="st">"=="</span>, california.crs)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>EPSG:4269 == EPSG:4269</code></pre>
</div>
</div>
<p>Now that I have both the California shapefile and the public transit stops in the same CRS, I can start to use them together. First, I’ll do a spatial join – I’ll filter the public transit stops down to only those that are within the California shapefile.</p>
<div id="9d723bbc" class="cell" data-execution_count="300">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>gdf_ca <span class="op">=</span> gdf_all.copy().sjoin(california, how<span class="op">=</span><span class="st">"inner"</span>, predicate<span class="op">=</span><span class="st">"within"</span>)</span></code></pre></div>
</div>
<p>I’ll plot the resulting raw stop data over the California shapefile.</p>
<div id="5d8db0cf" class="cell" data-execution_count="301">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">4</span>, <span class="dv">5</span>))</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> california.crs <span class="op">==</span> gdf_ca.crs</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>california.plot(ax<span class="op">=</span>ax, edgecolor<span class="op">=</span><span class="st">"grey"</span>, facecolor<span class="op">=</span><span class="st">"none"</span>,</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>                linewidth<span class="op">=</span><span class="dv">1</span>, zorder<span class="op">=-</span><span class="dv">1</span>, alpha<span class="op">=</span><span class="fl">.5</span>)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>gdf_ca.plot(ax<span class="op">=</span>ax, markersize<span class="op">=</span><span class="fl">1.5</span>, alpha<span class="op">=</span><span class="fl">0.4</span>, edgecolor<span class="op">=</span><span class="st">"none"</span>, linewidth<span class="op">=</span><span class="fl">0.05</span>)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>ax.axis(<span class="st">"off"</span>)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>fig.tight_layout()</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-18-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Looks good, but how does it do for answering our motivating question?</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Motivating Question">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Motivating Question
</div>
</div>
<div class="callout-body-container callout-body">
<p>How does the distribution of public transit stops in California vary by geography?</p>
</div>
</div>
<p>One can pick out the basic pattern that urban California has a lot of transit stops and rural California doesn’t, but I’d like to go deeper and explore how aggregating stops into larger geographies helps pick out different trends.</p>
</section>
</section>
<section id="exercise-1-county-choropleth" class="level2">
<h2 class="anchored" data-anchor-id="exercise-1-county-choropleth">Exercise 1: County Choropleth</h2>
<p>One very common geospatial data product is the <a href="https://en.wikipedia.org/wiki/Choropleth_map">choropleth</a> map. Choropleth maps communicate how the density of some data or else another quantity that describes that data varies across administrative units, like countries, states, provinces, etc. The data are grouped into the administrative units, and the aggregate value for each unit is depicted in the map via color intensity/hue/saturation.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption><a href="https://en.wikipedia.org/wiki/Choropleth_map#History">Wikipedia says</a> this 1826 choropleth depicting the availability of basic education in France is the earliest known choropleth map</figcaption>
<p><img src="choropleth.jpg" class="img-fluid figure-img" style="width:50.0%"></p>
</figure>
</div>
<div id="d6e0068a" class="cell" data-execution_count="302">
<details class="code-fold">
<summary>Some custom plotting code/functions: <code>build_cmap</code>, <code>number_suffix_formatter</code></summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">"font.family"</span>] <span class="op">=</span> <span class="st">"Arial"</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_cmap(</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    mpl_name: <span class="bu">str</span> <span class="op">=</span> <span class="st">"coolwarm"</span>,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    start: <span class="bu">float</span> <span class="op">=</span> <span class="fl">0.0</span>,</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    end: <span class="bu">float</span> <span class="op">=</span> <span class="fl">1.0</span>,</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    int_gran: <span class="bu">int</span> <span class="op">=</span> <span class="dv">1000</span>,</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> LinearSegmentedColormap:</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Create a customized linear colormap by truncating an existing Matplotlib colormap.</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="co">    mpl_name : str, default="coolwarm"</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a><span class="co">        The name of a Matplotlib colormap. See the full list at:</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a><span class="co">        https://matplotlib.org/stable/gallery/color/colormap_reference.html</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a><span class="co">    start : float, default=0</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a><span class="co">        The starting position in the original colormap's range [0, 1].</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a><span class="co">    int_gran : int, default=1000</span></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a><span class="co">        The number of discrete color samples to generate from the truncated colormap.</span></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a><span class="co">        Higher values yield smoother gradients.</span></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a><span class="co">    LinearSegmentedColormap</span></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a><span class="co">        A new colormap instance truncated from the original, beginning at `start`.</span></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a><span class="co">    Raises</span></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a><span class="co">    ------</span></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a><span class="co">    AssertionError</span></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a><span class="co">        If `start` is not between 0 and 1 (inclusive).</span></span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a><span class="co">    Examples</span></span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; cmap = build_cmap("viridis", start=0.2)</span></span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; plt.imshow(data, cmap=cmap)</span></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> (start <span class="op">&lt;=</span> <span class="dv">1</span>) <span class="op">&amp;</span> (start <span class="op">&gt;=</span> <span class="dv">0</span>), <span class="st">"start must be real number in [0, 1]"</span></span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>    cmap <span class="op">=</span> mpl.colormaps.get_cmap(mpl_name)</span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>    new_cmap <span class="op">=</span> LinearSegmentedColormap.from_list(</span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>        <span class="st">"deep_reds"</span>, cmap(np.linspace(start, end, int_gran))</span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> new_cmap</span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> number_suffix_formatter(x, pos<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a><span class="co">    Formats numbers using k (thousand) and m (million) suffixes.</span></span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a><span class="co">        x (float or int): Number to format.</span></span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a><span class="co">        pos: Ignored, included for compatibility with matplotlib's FuncFormatter.</span></span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a><span class="co">        str: Formatted string.</span></span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a>    thresholds <span class="op">=</span> [</span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a>        (<span class="fl">1e9</span>, <span class="st">'b'</span>),</span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a>        (<span class="fl">1e6</span>, <span class="st">'m'</span>),</span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a>        (<span class="fl">1e3</span>, <span class="st">'k'</span>),</span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> threshold, suffix <span class="kw">in</span> thresholds:</span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> x <span class="op">&gt;=</span> threshold:</span>
<span id="cb21-65"><a href="#cb21-65" aria-hidden="true" tabindex="-1"></a>            value <span class="op">=</span> x <span class="op">/</span> threshold</span>
<span id="cb21-66"><a href="#cb21-66" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="ss">f"</span><span class="sc">{</span>value<span class="sc">:.1f}{</span>suffix<span class="sc">}</span><span class="ss">"</span> <span class="cf">if</span> x <span class="op">%</span> threshold <span class="cf">else</span> <span class="ss">f"</span><span class="sc">{</span><span class="bu">int</span>(value)<span class="sc">}{</span>suffix<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb21-67"><a href="#cb21-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">str</span>(<span class="bu">int</span>(x))</span></code></pre></div>
</details>
</div>
<p>We want to make a choropleth of our transit stops dataset across counties, and the first step is going to be aggregating those stops (<code>Point</code> data) within counties (<code>Polygon</code> data). Here’s an abstract representation of the problem – we want to count the “Inside Points”:</p>
<div id="b0a95efa" class="cell" data-execution_count="359">
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption>Points within a Polygon</figcaption>
<p><img src="index_files/figure-html/cell-20-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Here’s my custom <code>points_in_polygon()</code> function that will count up the number of points from one gdf, <code>point_gdf</code> that are within the shape from another gdf, <code>polygon_gdf</code>. There’s an optional weight variable that I won’t be using.</p>
<div id="da413080" class="cell" data-execution_count="304">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> points_in_polygon(</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    point_gdf: gpd.GeoDataFrame,</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    polygon_gdf: gpd.GeoDataFrame,</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    group_var: <span class="bu">str</span>,</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    weight_var: <span class="bu">str</span> <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> gpd.GeoDataFrame:</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> point_gdf.crs <span class="op">==</span> polygon_gdf.crs, <span class="ss">f"</span><span class="sc">{</span>point_gdf<span class="sc">.</span>crs<span class="sc">}</span><span class="ss"> != </span><span class="sc">{</span>polygon_gdf<span class="sc">.</span>crs<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    joined <span class="op">=</span> point_gdf.sjoin(polygon_gdf, how<span class="op">=</span><span class="st">"inner"</span>, predicate<span class="op">=</span><span class="st">"within"</span>)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> weight_var:</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>        agg <span class="op">=</span> joined.groupby(group_var)[weight_var].<span class="bu">sum</span>().to_frame(<span class="ss">f"</span><span class="sc">{</span>weight_var<span class="sc">}</span><span class="ss">_sum"</span>)</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> polygon_gdf.copy()</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> result.merge(agg, left_on<span class="op">=</span>group_var, right_index<span class="op">=</span><span class="va">True</span>, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>        counts <span class="op">=</span> joined.groupby(group_var).size().to_frame(<span class="st">"count"</span>)</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> polygon_gdf.copy()</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> result.merge(counts, left_on<span class="op">=</span>group_var, right_index<span class="op">=</span><span class="va">True</span>, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span></code></pre></div>
</div>
<p>You can see that the logic is based on spatially merging the points with the polygons based on whether points fall “within” polygons, then I group by the polygon identifier and count up how many points there are within each. When we run that with the transit stops and counties, we get the following.</p>
<div id="e48ed409" class="cell" data-execution_count="305">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>county_agg <span class="op">=</span> points_in_polygon(gdf_all, county_shapes, group_var<span class="op">=</span><span class="st">"NAME"</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>county_agg[[<span class="st">'NAME'</span>, <span class="st">'count'</span>]].head()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="305">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">NAME</th>
<th data-quarto-table-cell-role="th">count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>Sierra</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">324</td>
<td>Sacramento</td>
<td>3367.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">328</td>
<td>Santa Barbara</td>
<td>1069.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">345</td>
<td>Calaveras</td>
<td>19.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">393</td>
<td>Ventura</td>
<td>1295.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>With that aggregated data, I can now make a choropleth of transit stops across counties. I’ll start with defining various stylings for the map (code is folded as it’s less relevant). I often like to define parameters for <code>geopandas</code> plots in dictionaries so that I can reuse styles across different plots.</p>
<div id="318ac889" class="cell" data-execution_count="306">
<details class="code-fold">
<summary>Plot Styling: <code>new_cmap</code>, <code>missing_fill_kws</code>, <code>borders_kws</code>, <code>data_fill_kws</code></summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Legend</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>new_cmap <span class="op">=</span> build_cmap(<span class="st">"YlOrRd"</span>, start<span class="op">=</span><span class="dv">0</span>, end<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>legend_cbar_kws <span class="op">=</span> {</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"format"</span>: FuncFormatter(number_suffix_formatter),</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"shrink"</span>: <span class="fl">0.8</span>,</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"label"</span>: <span class="st">"Number of Public Transit Stops"</span>,</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"location"</span>: <span class="st">"top"</span>,</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pad"</span>: <span class="fl">0.01</span>,</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="co"># General County Style</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>borders_kws <span class="op">=</span> {<span class="st">"edgecolor"</span>: <span class="st">"grey"</span>, <span class="st">"linewidth"</span>: <span class="fl">0.3</span>}</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>data_fill_kws <span class="op">=</span> {<span class="st">"alpha"</span>: <span class="dv">1</span>, <span class="st">"cmap"</span>: new_cmap}</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Missing County Style</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>missing_fill_kws <span class="op">=</span> {<span class="st">"hatch"</span>: <span class="st">"////"</span>, <span class="st">"facecolor"</span>: <span class="st">"none"</span>}</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>missing_patch <span class="op">=</span> Patch(<span class="op">**</span>borders_kws, <span class="op">**</span>missing_fill_kws, label<span class="op">=</span><span class="st">"County w/ no stops"</span>)</span></code></pre></div>
</details>
</div>
<p>You can pass the dictionaries directly into the plotting functions as unpacked variables, which you can see below with <code>**missing_fill_kws</code>, <code>**borders_kws</code>, and <code>**data_fill_kws</code>.</p>
<div id="62189676" class="cell" data-execution_count="307">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">4</span>, <span class="dv">6</span>))</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>county_agg <span class="op">=</span> points_in_polygon(gdf_all, county_shapes, group_var<span class="op">=</span><span class="st">"NAME"</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>county_agg.plot(</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    column<span class="op">=</span><span class="st">"count"</span>,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">**</span>borders_kws,</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">**</span>data_fill_kws,</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    legend<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    legend_kwds<span class="op">=</span>legend_cbar_kws,</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>county_agg[county_agg[<span class="st">"count"</span>].isna()].plot(<span class="op">**</span>missing_fill_kws, <span class="op">**</span>borders_kws, ax<span class="op">=</span>ax)</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>ax.legend(handles<span class="op">=</span>[missing_patch], fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>ax.axis(<span class="st">"off"</span>)</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>fig.tight_layout()</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-24-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="exercise-2-region-choropleth" class="level2">
<h2 class="anchored" data-anchor-id="exercise-2-region-choropleth">Exercise 2: Region Choropleth</h2>
<p>To provide additional perspective, we’re going to make another choropleth using a different geographic unit. I’d like to get a look at how stop availability differs across larger regions, such as the San Francisco Bay Area, Los Angeles, the Central Valley, etc. I don’t have a regions dataset, but I do have a counties dataset and regions are typically made up of counties, so this will be an opportunity to try combining smaller geographies into larger, custom geographies.</p>
<p>In the following folded code chunk I’ll define a mapping of counties to regions based on <a href="https://census.ca.gov/regions/">a mapping the state adopted during the 2020 Census</a>:</p>
<div id="6e85e041" class="cell" data-execution_count="308">
<details class="code-fold">
<summary>California County → Region Mappings, <code>county_to_region</code></summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># https://census.ca.gov/regions/</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>county_to_region <span class="op">=</span> {</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Butte"</span>: <span class="st">"Superior California"</span>,</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Colusa"</span>: <span class="st">"Superior California"</span>,</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"El Dorado"</span>: <span class="st">"Superior California"</span>,</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Glenn"</span>: <span class="st">"Superior California"</span>,</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Lassen"</span>: <span class="st">"Superior California"</span>,</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Modoc"</span>: <span class="st">"Superior California"</span>,</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Nevada"</span>: <span class="st">"Superior California"</span>,</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Placer"</span>: <span class="st">"Superior California"</span>,</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Plumas"</span>: <span class="st">"Superior California"</span>,</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Sacramento"</span>: <span class="st">"Superior California"</span>,</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Shasta"</span>: <span class="st">"Superior California"</span>,</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Sierra"</span>: <span class="st">"Superior California"</span>,</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Siskiyou"</span>: <span class="st">"Superior California"</span>,</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Sutter"</span>: <span class="st">"Superior California"</span>,</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Tehama"</span>: <span class="st">"Superior California"</span>,</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Yolo"</span>: <span class="st">"Superior California"</span>,</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Yuba"</span>: <span class="st">"Superior California"</span>,</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Del Norte"</span>: <span class="st">"North Coast"</span>,</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Humboldt"</span>: <span class="st">"North Coast"</span>,</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Lake"</span>: <span class="st">"North Coast"</span>,</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mendocino"</span>: <span class="st">"North Coast"</span>,</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Napa"</span>: <span class="st">"North Coast"</span>,</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Sonoma"</span>: <span class="st">"North Coast"</span>,</span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Trinity"</span>: <span class="st">"North Coast"</span>,</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Alameda"</span>: <span class="st">"San Francisco Bay Area"</span>,</span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Contra Costa"</span>: <span class="st">"San Francisco Bay Area"</span>,</span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Marin"</span>: <span class="st">"San Francisco Bay Area"</span>,</span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">"San Francisco"</span>: <span class="st">"San Francisco Bay Area"</span>,</span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">"San Mateo"</span>: <span class="st">"San Francisco Bay Area"</span>,</span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Santa Clara"</span>: <span class="st">"San Francisco Bay Area"</span>,</span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Solano"</span>: <span class="st">"San Francisco Bay Area"</span>,</span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Alpine"</span>: <span class="st">"Northern San Joaquin Valley"</span>,</span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Amador"</span>: <span class="st">"Northern San Joaquin Valley"</span>,</span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Calaveras"</span>: <span class="st">"Northern San Joaquin Valley"</span>,</span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Madera"</span>: <span class="st">"Northern San Joaquin Valley"</span>,</span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mariposa"</span>: <span class="st">"Northern San Joaquin Valley"</span>,</span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Merced"</span>: <span class="st">"Northern San Joaquin Valley"</span>,</span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mono"</span>: <span class="st">"Northern San Joaquin Valley"</span>,</span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a>    <span class="st">"San Joaquin"</span>: <span class="st">"Northern San Joaquin Valley"</span>,</span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Stanislaus"</span>: <span class="st">"Northern San Joaquin Valley"</span>,</span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Tuolumne"</span>: <span class="st">"Northern San Joaquin Valley"</span>,</span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Monterey"</span>: <span class="st">"Central Coast"</span>,</span>
<span id="cb26-45"><a href="#cb26-45" aria-hidden="true" tabindex="-1"></a>    <span class="st">"San Benito"</span>: <span class="st">"Central Coast"</span>,</span>
<span id="cb26-46"><a href="#cb26-46" aria-hidden="true" tabindex="-1"></a>    <span class="st">"San Luis Obispo"</span>: <span class="st">"Central Coast"</span>,</span>
<span id="cb26-47"><a href="#cb26-47" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Santa Barbara"</span>: <span class="st">"Central Coast"</span>,</span>
<span id="cb26-48"><a href="#cb26-48" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Santa Cruz"</span>: <span class="st">"Central Coast"</span>,</span>
<span id="cb26-49"><a href="#cb26-49" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Ventura"</span>: <span class="st">"Central Coast"</span>,</span>
<span id="cb26-50"><a href="#cb26-50" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Fresno"</span>: <span class="st">"Southern San Joaquin Valley"</span>,</span>
<span id="cb26-51"><a href="#cb26-51" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Inyo"</span>: <span class="st">"Southern San Joaquin Valley"</span>,</span>
<span id="cb26-52"><a href="#cb26-52" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Kern"</span>: <span class="st">"Southern San Joaquin Valley"</span>,</span>
<span id="cb26-53"><a href="#cb26-53" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Kings"</span>: <span class="st">"Southern San Joaquin Valley"</span>,</span>
<span id="cb26-54"><a href="#cb26-54" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Tulare"</span>: <span class="st">"Southern San Joaquin Valley"</span>,</span>
<span id="cb26-55"><a href="#cb26-55" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Riverside"</span>: <span class="st">"Inland Empire"</span>,</span>
<span id="cb26-56"><a href="#cb26-56" aria-hidden="true" tabindex="-1"></a>    <span class="st">"San Bernardino"</span>: <span class="st">"Inland Empire"</span>,</span>
<span id="cb26-57"><a href="#cb26-57" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Los Angeles"</span>: <span class="st">"Los Angeles"</span>,</span>
<span id="cb26-58"><a href="#cb26-58" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Orange"</span>: <span class="st">"Orange County"</span>,</span>
<span id="cb26-59"><a href="#cb26-59" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Imperial"</span>: <span class="st">"San Diego-Imperial"</span>,</span>
<span id="cb26-60"><a href="#cb26-60" aria-hidden="true" tabindex="-1"></a>    <span class="st">"San Diego"</span>: <span class="st">"San Diego-Imperial"</span>,</span>
<span id="cb26-61"><a href="#cb26-61" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</details>
</div>
<p>Now that I have the mappings dictionary, I can map those onto the county names in my dataset:</p>
<div id="cd98a093" class="cell" data-execution_count="365">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>county_shapes[<span class="st">"region"</span>] <span class="op">=</span> county_shapes[<span class="st">"NAME"</span>].<span class="bu">map</span>(county_to_region)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>county_shapes[[<span class="st">"NAME"</span>, <span class="st">"region"</span>]].head(<span class="dv">4</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="365">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">NAME</th>
<th data-quarto-table-cell-role="th">region</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>Sierra</td>
<td>Superior California</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">324</td>
<td>Sacramento</td>
<td>Superior California</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">328</td>
<td>Santa Barbara</td>
<td>Central Coast</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">345</td>
<td>Calaveras</td>
<td>Northern San Joaquin Valley</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Now that the mapping is established, I need to combine the county shapes up into parent region shapes. This spatial operation is called a <code>dissolve()</code> in geopandas. Here’s an abstract representation of what <code>dissolve()</code> does:</p>
<div id="8408f772" class="cell" data-execution_count="371">
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption>The effect of <code>dissolve()</code></figcaption>
<p><img src="index_files/figure-html/cell-27-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Here we will create a new gdf, <code>regions</code>, with the results of dissolving the counties up into regions.</p>
<div id="beda6efb" class="cell" data-execution_count="310">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>regions <span class="op">=</span> county_shapes.dissolve(by<span class="op">=</span><span class="st">"region"</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> county_shapes.crs <span class="op">==</span> regions.crs</span></code></pre></div>
</div>
<div id="e4b47b51" class="cell" data-execution_count="358">
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption>Dissolving the Bay Area counties</figcaption>
<p><img src="index_files/figure-html/cell-29-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="fe392b09" class="cell" data-execution_count="313">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> split_name_middle(name):</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    parts <span class="op">=</span> name.replace(<span class="st">"-"</span>, <span class="st">" "</span>).split()</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(parts) <span class="op">&lt;=</span> <span class="dv">1</span>:</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> name  <span class="co"># nothing to split</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    mid <span class="op">=</span> <span class="bu">len</span>(parts) <span class="op">//</span> <span class="dv">2</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Insert newline at the midpoint between words</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">" "</span>.join(parts[:mid]) <span class="op">+</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">" "</span>.join(parts[mid:])</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> label_polygon(</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    gdf: gpd.GeoDataFrame,</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    ax,</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>    column: <span class="bu">str</span>,</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>    adjust_list: <span class="bu">list</span> <span class="op">=</span> [],</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>    adjust_kws<span class="op">=</span>{},</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>    text_kws<span class="op">=</span>{},</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>    texts <span class="op">=</span> []</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, row <span class="kw">in</span> gdf.iterrows():</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> row[<span class="st">"geometry"</span>].is_empty <span class="kw">or</span> row[<span class="st">"geometry"</span>].centroid.is_empty:</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>        point <span class="op">=</span> row[<span class="st">"geometry"</span>].centroid</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>        x, y <span class="op">=</span> point.x, point.y</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> row[column] <span class="kw">in</span> adjust_list:</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>            texts.append(ax.text(x, y, split_name_middle(row[column]), <span class="op">**</span>text_kws))</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>            ax.text(x, y, split_name_middle(row[column]), <span class="op">**</span>text_kws)</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>    adjust_text(texts, ax<span class="op">=</span>ax, <span class="op">**</span>adjust_kws)</span></code></pre></div>
</div>
<div id="78ae2010" class="cell" data-execution_count="314">
<details class="code-fold">
<summary>Plot Styling</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>new_cmap <span class="op">=</span> build_cmap(<span class="st">"coolwarm_r"</span>, start<span class="op">=</span><span class="fl">0.1</span>, end<span class="op">=</span><span class="fl">0.9</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>borders_kws <span class="op">=</span> {<span class="st">"edgecolor"</span>: <span class="st">"grey"</span>, <span class="st">"linewidth"</span>: <span class="fl">0.3</span>}</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>data_fill_kws <span class="op">=</span> {<span class="st">"alpha"</span>: <span class="fl">0.7</span>, <span class="st">"cmap"</span>: new_cmap}</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>missing_fill_kws <span class="op">=</span> {<span class="st">"hatch"</span>: <span class="st">"////"</span>, <span class="st">"facecolor"</span>: <span class="st">"none"</span>}</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>legend_cbar_kws <span class="op">=</span> {</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"format"</span>: FuncFormatter(number_suffix_formatter),</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"shrink"</span>: <span class="fl">0.7</span>,</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"label"</span>: <span class="st">"Number of Public Transit Stops"</span>,</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"location"</span>: <span class="st">"top"</span>,</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pad"</span>: <span class="fl">0.001</span>,</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>adjust_kws <span class="op">=</span> {</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"avoid_self"</span>: <span class="va">True</span>,</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"expand"</span>: (<span class="dv">7</span>, <span class="dv">3</span>),</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"arrowprops"</span>: {</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"arrowstyle"</span>: <span class="st">"-"</span>,</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"color"</span>: <span class="st">"black"</span>,</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"lw"</span>: <span class="dv">1</span>,</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">"connectionstyle"</span>: <span class="st">"arc3,rad=0.1"</span>,</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>text_kws <span class="op">=</span> {</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fontsize"</span>: <span class="dv">8</span>,</span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ha"</span>: <span class="st">"center"</span>,</span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"va"</span>: <span class="st">"center"</span>,</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"color"</span>: <span class="st">"black"</span>,</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</details>
</div>
<div id="df97f12a" class="cell" data-execution_count="315">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">7</span>, <span class="dv">7</span>))</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>arrivals_in_regions <span class="op">=</span> points_in_polygon(</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    gdf_all,</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    regions.reset_index(),</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    group_var<span class="op">=</span><span class="st">"region"</span>,</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    weight_var<span class="op">=</span><span class="st">"n_arrivals"</span>,</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>arrivals_in_regions.plot(</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    column<span class="op">=</span><span class="st">"n_arrivals_sum"</span>,</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">**</span>data_fill_kws,</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">**</span>borders_kws,</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>    legend<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>    legend_kwds<span class="op">=</span>legend_cbar_kws</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>label_polygon(</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>    arrivals_in_regions,</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>    ax,</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"region"</span>,</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>    adjust_list<span class="op">=</span>[<span class="st">"San Francisco Bay Area"</span>, <span class="st">"Orange County"</span>, <span class="st">"North Coast"</span>],</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>    adjust_kws<span class="op">=</span>adjust_kws,</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>    text_kws<span class="op">=</span>text_kws,</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>ax.axis(<span class="st">"off"</span>)</span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>fig.tight_layout()</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-32-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="exercise-3-heatmaps" class="level2">
<h2 class="anchored" data-anchor-id="exercise-3-heatmaps">Exercise 3: Heatmaps</h2>
<blockquote class="blockquote">
<p>[…] heat maps may also visualize data over a geographic region. However, unlike choropleth maps, heat maps show the proportion of a variable over an arbitrary, but usually small grid size, independent of geographic boundaries.</p>
</blockquote>
<p>https://en.wikipedia.org/wiki/Heat_map#Choropleth_maps_versus_heat_maps</p>
<p>https://en.wikipedia.org/wiki/Ecological_fallacy</p>
<p>This code is complex, but it’s based around one function, <code>np.histogram2d</code>, which takes in point data and aggregates it into bins.</p>
<div id="6b14e4c0" class="cell" data-execution_count="316">
<details class="code-fold">
<summary>Geospatial Histogram Functions: <code>histogram_to_geodataframe</code> and <code>geospatial_histogram</code></summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> histogram_to_geodataframe(hist, x_edges, y_edges, crs<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Convert a 2D histogram and bin edges into a GeoDataFrame of grid cells with counts.</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="co">    hist : 2D numpy array</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="co">        The histogram values (as returned by geospatial_histogram, already transposed).</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="co">    x_edges : 1D numpy array</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Bin edges along the x-axis.</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="co">    y_edges : 1D numpy array</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Bin edges along the y-axis.</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="co">    crs : any (optional)</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="co">        Coordinate reference system for the GeoDataFrame.</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a><span class="co">    gdf : GeoDataFrame</span></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a><span class="co">        A GeoDataFrame with one polygon per grid cell, with a 'count' column.</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>    rows, cols <span class="op">=</span> hist.shape</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>    polygons <span class="op">=</span> []</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>    counts <span class="op">=</span> []</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(rows):</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(cols):</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>            count <span class="op">=</span> hist[i, j]</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> count <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span>  <span class="co"># Skip empty cells for efficiency</span></span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>            x0 <span class="op">=</span> x_edges[j]</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>            x1 <span class="op">=</span> x_edges[j <span class="op">+</span> <span class="dv">1</span>]</span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>            y0 <span class="op">=</span> y_edges[i]</span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>            y1 <span class="op">=</span> y_edges[i <span class="op">+</span> <span class="dv">1</span>]</span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>            polygons.append(box(x0, y0, x1, y1))</span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>            counts.append(count)</span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>    gdf <span class="op">=</span> gpd.GeoDataFrame({<span class="st">"count"</span>: counts, <span class="st">"geometry"</span>: polygons}, crs<span class="op">=</span>crs)</span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> gdf</span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> geospatial_histogram(gdf, cell_size, bounds<span class="op">=</span><span class="va">None</span>, weights<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a><span class="co">    Create a 2D geospatial histogram (raster grid of counts) from a GeoDataFrame of points.</span></span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a><span class="co">    gdf : GeoDataFrame</span></span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a><span class="co">        Must contain Point geometries in a projected CRS (e.g. meters).</span></span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a><span class="co">    cell_size : float</span></span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a><span class="co">        Width and height of grid cells (in CRS units, e.g. meters).</span></span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a><span class="co">    bounds : tuple or None</span></span>
<span id="cb32-52"><a href="#cb32-52" aria-hidden="true" tabindex="-1"></a><span class="co">        Optional (minx, miny, maxx, maxy). If None, computed from gdf.bounds.</span></span>
<span id="cb32-53"><a href="#cb32-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-54"><a href="#cb32-54" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb32-55"><a href="#cb32-55" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb32-56"><a href="#cb32-56" aria-hidden="true" tabindex="-1"></a><span class="co">    hist : 2D numpy array</span></span>
<span id="cb32-57"><a href="#cb32-57" aria-hidden="true" tabindex="-1"></a><span class="co">        Histogram counts of points per grid cell.</span></span>
<span id="cb32-58"><a href="#cb32-58" aria-hidden="true" tabindex="-1"></a><span class="co">    (Optional) x_edges, y_edges : 1D numpy arrays</span></span>
<span id="cb32-59"><a href="#cb32-59" aria-hidden="true" tabindex="-1"></a><span class="co">        Bin edges in x and y directions.</span></span>
<span id="cb32-60"><a href="#cb32-60" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb32-61"><a href="#cb32-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> gdf.crs.is_projected, <span class="st">"CRS must be projected first, e.g. `gdf.set_crs()`"</span></span>
<span id="cb32-62"><a href="#cb32-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> gdf.empty:</span>
<span id="cb32-63"><a href="#cb32-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Input GeoDataFrame is empty."</span>)</span>
<span id="cb32-64"><a href="#cb32-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> gdf.geometry.geom_type.isin([<span class="st">"Point"</span>]).<span class="bu">all</span>():</span>
<span id="cb32-65"><a href="#cb32-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"All geometries must be Points."</span>)</span>
<span id="cb32-66"><a href="#cb32-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-67"><a href="#cb32-67" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> gdf.geometry.x.values</span>
<span id="cb32-68"><a href="#cb32-68" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> gdf.geometry.y.values</span>
<span id="cb32-69"><a href="#cb32-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-70"><a href="#cb32-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> weights <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb32-71"><a href="#cb32-71" aria-hidden="true" tabindex="-1"></a>        weights <span class="op">=</span> np.asarray(gdf[weights])</span>
<span id="cb32-72"><a href="#cb32-72" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(weights) <span class="op">!=</span> <span class="bu">len</span>(gdf):</span>
<span id="cb32-73"><a href="#cb32-73" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Length of weights must match number of points in gdf."</span>)</span>
<span id="cb32-74"><a href="#cb32-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-75"><a href="#cb32-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> bounds <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb32-76"><a href="#cb32-76" aria-hidden="true" tabindex="-1"></a>        minx, miny, maxx, maxy <span class="op">=</span> gdf.total_bounds</span>
<span id="cb32-77"><a href="#cb32-77" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb32-78"><a href="#cb32-78" aria-hidden="true" tabindex="-1"></a>        minx, miny, maxx, maxy <span class="op">=</span> bounds</span>
<span id="cb32-79"><a href="#cb32-79" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define bin edges</span></span>
<span id="cb32-80"><a href="#cb32-80" aria-hidden="true" tabindex="-1"></a>    x_bins <span class="op">=</span> np.arange(minx, maxx <span class="op">+</span> cell_size, cell_size)</span>
<span id="cb32-81"><a href="#cb32-81" aria-hidden="true" tabindex="-1"></a>    y_bins <span class="op">=</span> np.arange(miny, maxy <span class="op">+</span> cell_size, cell_size)</span>
<span id="cb32-82"><a href="#cb32-82" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute histogram</span></span>
<span id="cb32-83"><a href="#cb32-83" aria-hidden="true" tabindex="-1"></a>    hist, x_edges, y_edges <span class="op">=</span> np.histogram2d(</span>
<span id="cb32-84"><a href="#cb32-84" aria-hidden="true" tabindex="-1"></a>        x, y, bins<span class="op">=</span>[x_bins, y_bins], weights<span class="op">=</span>weights</span>
<span id="cb32-85"><a href="#cb32-85" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb32-86"><a href="#cb32-86" aria-hidden="true" tabindex="-1"></a>    <span class="co"># histogram2d returns shape (len(x_bins)-1, len(y_bins)-1) with axes (x, y)</span></span>
<span id="cb32-87"><a href="#cb32-87" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Transpose so that rows = y, columns = x (like image/raster orientation)</span></span>
<span id="cb32-88"><a href="#cb32-88" aria-hidden="true" tabindex="-1"></a>    hist <span class="op">=</span> hist.T</span>
<span id="cb32-89"><a href="#cb32-89" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> histogram_to_geodataframe(hist, x_edges, y_edges, crs<span class="op">=</span>gdf.crs)</span></code></pre></div>
</details>
</div>
<div id="fa4eac60" class="cell" data-execution_count="317">
<details class="code-fold">
<summary>Plot Styling: <code>legend_cbar_kws</code>, <code>square_patch</code>, <code>borders_kws</code></summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>new_cmap <span class="op">=</span> build_cmap(<span class="st">"YlOrRd"</span>, start<span class="op">=</span><span class="dv">0</span>, end<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>legend_cbar_kws <span class="op">=</span> {</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"format"</span>: FuncFormatter(number_suffix_formatter),</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"shrink"</span>: <span class="fl">0.8</span>,</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"label"</span>: <span class="st">"Number of Public Transit Stops"</span>,</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"location"</span>: <span class="st">"top"</span>,</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pad"</span>: <span class="fl">0.001</span>,</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>data_fill_kws <span class="op">=</span> {<span class="st">"alpha"</span>: <span class="dv">1</span>, <span class="st">"cmap"</span>: new_cmap}</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>square_patch <span class="op">=</span> mpatches.Rectangle(</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">0</span>, <span class="dv">0</span>), <span class="dv">10</span>, <span class="dv">10</span>, facecolor<span class="op">=</span>new_cmap.get_under(), edgecolor<span class="op">=</span><span class="st">"grey"</span>, linewidth<span class="op">=</span><span class="fl">0.8</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>borders_kws <span class="op">=</span> {<span class="st">"edgecolor"</span>: <span class="st">"grey"</span>, <span class="st">"linewidth"</span>: <span class="fl">0.1</span>}</span></code></pre></div>
</details>
</div>
<div id="e694d818" class="cell" data-execution_count="318">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>cell_size <span class="op">=</span> <span class="dv">20_000</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>gdf_ca_proj <span class="op">=</span> gdf_ca.to_crs(CA_ALBERS_CRS)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>california_proj <span class="op">=</span> california.to_crs(CA_ALBERS_CRS)</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> gdf_ca_proj.crs <span class="op">==</span> california_proj.crs</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>arrivals_hist <span class="op">=</span> geospatial_histogram(</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    gdf_ca_proj, weights<span class="op">=</span><span class="va">None</span>, cell_size<span class="op">=</span>cell_size</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> arrivals_hist.crs <span class="op">==</span> california_proj.crs</span></code></pre></div>
</div>
<div id="f12b1a7d" class="cell" data-execution_count="319">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">4</span>, <span class="dv">6</span>))</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>california_proj.plot(</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax, edgecolor<span class="op">=</span><span class="st">"grey"</span>, facecolor<span class="op">=</span><span class="st">"none"</span>, linewidth<span class="op">=</span><span class="dv">1</span>, alpha<span class="op">=</span><span class="fl">0.5</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>arrivals_hist.plot(</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    column<span class="op">=</span><span class="st">"count"</span>,</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">**</span>data_fill_kws,</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">**</span>borders_kws,</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    zorder<span class="op">=-</span><span class="dv">1</span>,</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>    legend<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>    legend_kwds<span class="op">=</span>legend_cbar_kws,</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>ax.legend(</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>    handles<span class="op">=</span>[square_patch],</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>    labels<span class="op">=</span>[<span class="vs">rf"</span><span class="sc">{</span><span class="bu">int</span>(cell_size<span class="op">/</span><span class="dv">1000</span>)<span class="sc">}</span><span class="vs">$\times$</span><span class="sc">{</span><span class="bu">int</span>(cell_size<span class="op">/</span><span class="dv">1000</span>)<span class="sc">}</span><span class="vs">km Grid Area"</span>],</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>    loc<span class="op">=</span><span class="st">"upper right"</span>,</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>    frameon<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>    fontsize<span class="op">=</span><span class="dv">9</span>,</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>    handlelength<span class="op">=</span><span class="fl">1.0</span>,</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>    handleheight<span class="op">=</span><span class="fl">1.25</span>,</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>ax.axis(<span class="st">"off"</span>)</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>fig.tight_layout()</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-36-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="exercise-4-refining-land" class="level2">
<h2 class="anchored" data-anchor-id="exercise-4-refining-land">Exercise 4: Refining Land</h2>
<div id="989cc612" class="cell" data-execution_count="320">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>hq_stops <span class="op">=</span> <span class="st">"services/CHrailroad/CA_HQ_Transit_Stops/FeatureServer/0/query"</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>gdf_hq <span class="op">=</span> paginate_api(rest_api <span class="op">+</span> hq_stops)</span></code></pre></div>
</div>
<div id="1d94aece" class="cell" data-execution_count="321">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>gdf_hq <span class="op">=</span> gdf_hq[<span class="op">~</span>gdf_hq[<span class="st">'hqta_details'</span>].<span class="bu">str</span>.contains(<span class="st">'planned'</span>)]</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>gdf_hq <span class="op">=</span> gdf_hq[gdf_hq[<span class="st">'hqta_type'</span>].<span class="bu">str</span>.contains(<span class="st">'major_stop'</span>)]</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>gdf_hq <span class="op">=</span> gdf_hq.drop_duplicates(subset<span class="op">=</span><span class="st">'geometry'</span>)</span></code></pre></div>
</div>
<div id="26bdec25" class="cell" data-execution_count="322">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>gdf_hq[[<span class="st">'hqta_type'</span>, <span class="st">'stop_id'</span>, <span class="st">'hqta_details'</span>,<span class="st">'avg_trips_per_peak_hr'</span>, <span class="st">'geometry'</span>]].head()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="322">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">hqta_type</th>
<th data-quarto-table-cell-role="th">stop_id</th>
<th data-quarto-table-cell-role="th">hqta_details</th>
<th data-quarto-table-cell-role="th">avg_trips_per_peak_hr</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">3444</td>
<td>major_stop_brt</td>
<td>13124</td>
<td>major_stop_brt_single_operator</td>
<td>5</td>
<td>POINT (-122.39933 37.7842)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3451</td>
<td>major_stop_brt</td>
<td>13136</td>
<td>major_stop_brt_single_operator</td>
<td>5</td>
<td>POINT (-122.40211 37.78637)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3458</td>
<td>major_stop_brt</td>
<td>13144</td>
<td>major_stop_brt_single_operator</td>
<td>5</td>
<td>POINT (-122.3962 37.78165)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3464</td>
<td>major_stop_brt</td>
<td>13191</td>
<td>major_stop_brt_single_operator</td>
<td>4</td>
<td>POINT (-122.40337 37.77327)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3465</td>
<td>major_stop_brt</td>
<td>13192</td>
<td>major_stop_brt_single_operator</td>
<td>3</td>
<td>POINT (-122.4079 37.77686)</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="50cd0119" class="cell" data-execution_count="323">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>gdf_hq.crs <span class="op">=</span> regions.crs</span></code></pre></div>
</div>
<div id="c1232e4b" class="cell" data-execution_count="324">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Total Public Transit Stops:"</span>, gdf_all.shape[<span class="dv">0</span>])</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"High Quality Public Transit Stops:"</span>, gdf_hq.shape[<span class="dv">0</span>])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Total Public Transit Stops: 89239
High Quality Public Transit Stops: 10396</code></pre>
</div>
</div>
<div id="dc39677b" class="cell" data-execution_count="325">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> gdf_hq.crs <span class="op">==</span> regions.crs</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>gdf_bay_hq <span class="op">=</span> gdf_hq.copy()[gdf_hq.geometry.within(regions.loc[<span class="st">"San Francisco Bay Area"</span>].geometry)]</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>sf_bay_county_shapes <span class="op">=</span> county_shapes.copy()[county_shapes[<span class="st">"region"</span>] <span class="op">==</span> <span class="st">"San Francisco Bay Area"</span>]</span></code></pre></div>
</div>
<p>One issue with making a plot of the San Francisco Bay Area is that the <a href="https://en.wikipedia.org/wiki/Farallon_Islands#Geography">Farallon Islands</a> are technically part of the administrative boundaries of San Francisco county (indeed, they, along with The Sunset Neighborhood, are a part of the political boundaries of Supervisorial District 4!). You can see the islands on the far left in the following plot of the Bay Area counties.</p>
<div id="6fe903e3" class="cell" data-execution_count="326">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>sf_bay_county_shapes.plot(facecolor<span class="op">=</span><span class="st">"none"</span>)<span class="op">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-43-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Including the islands in an analysis focused on the human population of the Bay Area and the availability of public transit doesn’t seem appropriate, so we want to find a data-driven way to remove that land mass.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption>Here’s a picture of the <a href="https://commons.wikimedia.org/wiki/File:SE_Farallon_Island.jpg">Farallon Islands</a> – I don’t see public transit stops.</figcaption>
<p><img src="View_from_Mirounga_Bay.jpg" class="img-fluid figure-img" style="width:50.0%"></p>
</figure>
</div>
<p>The answer starts with an “explosion” – we can use the <a href="https://geopandas.org/en/stable/docs/reference/api/geopandas.GeoDataFrame.explode.html"><code>.explode()</code> method</a> from <code>geopandas</code> to break any multi-part geometries (in this case the multi-part polygon of San Francisco County with some pieces that are non-contiguous) into individual geometries.</p>
<div id="a6fd0290" class="cell" data-execution_count="327">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>exploded_shapes <span class="op">=</span> (</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    sf_bay_county_shapes</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    .explode(index_parts<span class="op">=</span><span class="va">True</span>, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    .reset_index(names<span class="op">=</span><span class="st">'shape_index'</span>)</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Check retention of crs</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> sf_bay_county_shapes.crs <span class="op">==</span> exploded_shapes.crs</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Pre-explosion shape"</span>, sf_bay_county_shapes.shape)</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Post-explosion shape"</span>, exploded_shapes.shape)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Pre-explosion shape (7, 20)
Post-explosion shape (8, 21)</code></pre>
</div>
</div>
<p>We can see that, following the explosion, our dataframe has one new geometry – the Farallon Islands. Now we will bring back our <code>points_in_polygon</code> function so that we can count how many high quality public transit stops are in each of the geometries.</p>
<div id="13e5fbab" class="cell" data-execution_count="328">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>exploded_shapes <span class="op">=</span> points_in_polygon(gdf_bay_hq, exploded_shapes, <span class="st">"shape_index"</span>)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> exploded_shapes.crs <span class="op">==</span> sf_bay_county_shapes.crs</span></code></pre></div>
</div>
<p>We can see that one of these doesn’t have any stops. It’s still called “San Francisco,” but this is the Farallon Islands geometry, which, since they are unpopulated islands, doesn’t contain any transit stops.</p>
<div id="d2f1f92a" class="cell" data-execution_count="329">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>exploded_shapes[[<span class="st">'NAME'</span>, <span class="st">'count'</span>]].head(<span class="dv">3</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="329">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">NAME</th>
<th data-quarto-table-cell-role="th">count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>San Francisco</td>
<td>1600.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>San Francisco</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Marin</td>
<td>44.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We’ll use that as a filtering condition to remove the islands from the dataset, and we arrive at a clean dataset of the populated geometries of the Bay Area counties.</p>
<div id="3bf2b026" class="cell" data-execution_count="330">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>sf_bay_county_shapes <span class="op">=</span> exploded_shapes[exploded_shapes[<span class="st">'count'</span>] <span class="op">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>sf_bay_county_shapes.plot(facecolor<span class="op">=</span><span class="st">"none"</span>)<span class="op">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-47-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Let’s continue refining this. The San Francisco Bay Area is known for being a bay, as in, there is a large body of water at the center of it. This map doesn’t reflect that yet and that’s problematic for plotting the distribution of transit stops in the area. We may see large swaths of map with no stops and assume that it’s a transit desert, when in fact it’s just a body of water.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption>It would be useful to convey how much water there is in <a href="https://commons.wikimedia.org/wiki/File:San_Francisco_and_SFO_Aerial_2018.jpg">the Bay Area</a></figcaption>
<p><img src="bay_panorama.jpg" class="img-fluid figure-img" style="width:50.0%"></p>
</figure>
</div>
<p>The bodies of water that make up the bay are all part of administrative boundaries of counties, so to include the bay, we will need to break out the geometries for water within each county. This sounds hard, and again, in the past I have <a href="https://github.com/peter-amerkhanian/sf-schools-simulation/blob/b8b956180289e079bef43d15808066eb01f2fa6c/build_city.py#L50C1-L59C29">written custom code to accomplish this</a>, but it’s now incredibly easy using the <code>tigris</code>/<code>pygris</code> package and its useful <code>erase_water()</code> function.</p>
<div id="59acbbaf" class="cell" data-execution_count="331">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>bay_area_no_water <span class="op">=</span> pygris.utils.erase_water(</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>    sf_bay_county_shapes,</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>    year<span class="op">=</span><span class="dv">2024</span>,</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    cache<span class="op">=</span><span class="va">True</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> bay_area_no_water.crs <span class="op">==</span> sf_bay_county_shapes.crs</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>HTTP download failed, trying FTP as fallback...
Downloading cb_2024_us_county_500k.zip from Census FTP...</code></pre>
</div>
</div>
<p>After using the census’ 2024 water boundaries to remove water from the county shapes, we arrive at the following map.</p>
<div id="c020eb21" class="cell" data-execution_count="332">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>bay_area_no_water.plot(facecolor<span class="op">=</span><span class="st">"none"</span>)<span class="op">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-49-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Now that looks like the Bay Area!</p>
<div id="53674928" class="cell" data-execution_count="334">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Dataset</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>cell_size <span class="op">=</span> <span class="dv">5_000</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>gdf_bay_proj<span class="op">=</span> gdf_bay_hq.to_crs(CA_ALBERS_CRS)</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>bay_area_no_water_proj<span class="op">=</span> bay_area_no_water.to_crs(CA_ALBERS_CRS)</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>sf_bay_county_shapes_proj <span class="op">=</span> sf_bay_county_shapes.to_crs(CA_ALBERS_CRS)</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> gdf_bay_proj.crs <span class="op">==</span> bay_area_no_water_proj.crs</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>bay_arrivals_hist <span class="op">=</span> geospatial_histogram(</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>    gdf_bay_proj, weights<span class="op">=</span><span class="va">None</span>, cell_size<span class="op">=</span>cell_size</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> bay_arrivals_hist.crs <span class="op">==</span> bay_area_no_water_proj.crs</span></code></pre></div>
</div>
<div id="fd0c5816" class="cell" data-execution_count="379">
<details class="code-fold">
<summary>Plot Styling: <code>legend_cbar_kws</code>, <code>data_fill_kws</code>, <code>adjust_kws</code>, <code>text_kws</code>, <code>square_patch</code></summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>legend_cbar_kws <span class="op">=</span> {</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"format"</span>: FuncFormatter(number_suffix_formatter),</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"shrink"</span>: <span class="fl">0.8</span>,</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"label"</span>: <span class="st">"Number of High Quality Public Transit Stops"</span>,</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"location"</span>: <span class="st">"top"</span>,</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pad"</span>: <span class="fl">0.001</span>,</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>adjust_kws <span class="op">=</span> {</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"avoid_self"</span>: <span class="va">True</span>,</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"expand"</span>: (<span class="dv">7</span>, <span class="dv">3</span>),</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"arrowprops"</span>: {</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"arrowstyle"</span>: <span class="st">"-&gt;"</span>,</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"color"</span>: <span class="st">"black"</span>,</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"lw"</span>: <span class="dv">1</span>,</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"connectionstyle"</span>: <span class="st">"arc3,rad=0.01"</span>,</span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>data_fill_kws <span class="op">=</span> {<span class="st">"alpha"</span>: <span class="fl">.75</span>, <span class="st">"cmap"</span>: new_cmap}</span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>text_kws <span class="op">=</span> {<span class="st">"fontsize"</span>: <span class="dv">9</span>, <span class="st">"ha"</span>: <span class="st">"center"</span>, <span class="st">"va"</span>: <span class="st">"center"</span>, <span class="st">"color"</span>: <span class="st">"black"</span>}</span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a>square_patch <span class="op">=</span> mpatches.Rectangle(</span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">0</span>, <span class="dv">0</span>), <span class="dv">10</span>, <span class="dv">10</span>, facecolor<span class="op">=</span>new_cmap.get_under(), edgecolor<span class="op">=</span><span class="st">"grey"</span>, linewidth<span class="op">=</span><span class="fl">0.8</span></span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
</details>
</div>
<div id="4aadbe39" class="cell" data-execution_count="380">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">7</span>, <span class="dv">7</span>))</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>bay_arrivals_hist.plot(</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    column<span class="op">=</span><span class="st">"count"</span>,</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">**</span>data_fill_kws,</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">**</span>borders_kws,</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>    vmax<span class="op">=</span><span class="dv">500</span>,</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>    legend<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>    legend_kwds<span class="op">=</span>legend_cbar_kws,</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>sf_bay_county_shapes_proj.plot(</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>    edgecolor<span class="op">=</span><span class="st">"black"</span>, facecolor<span class="op">=</span><span class="st">"none"</span>, linewidth<span class="op">=</span><span class="dv">1</span>, alpha<span class="op">=</span><span class="fl">.7</span>,</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax</span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>bay_area_no_water_proj.plot(</span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>    ax<span class="op">=</span>ax, edgecolor<span class="op">=</span><span class="st">"black"</span>, facecolor<span class="op">=</span><span class="st">"grey"</span>, linewidth<span class="op">=</span><span class="dv">1</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, zorder<span class="op">=-</span><span class="dv">1</span></span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>label_polygon(</span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>    bay_area_no_water_proj,</span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a>    ax,</span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"NAME"</span>,</span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a>    adjust_list<span class="op">=</span>[</span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">"San Francisco"</span></span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a>    adjust_kws<span class="op">=</span>adjust_kws,</span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a>    text_kws<span class="op">=</span>text_kws,</span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-30"><a href="#cb54-30" aria-hidden="true" tabindex="-1"></a>ax.legend(</span>
<span id="cb54-31"><a href="#cb54-31" aria-hidden="true" tabindex="-1"></a>    handles<span class="op">=</span>[square_patch],</span>
<span id="cb54-32"><a href="#cb54-32" aria-hidden="true" tabindex="-1"></a>    labels<span class="op">=</span>[<span class="vs">rf"</span><span class="sc">{</span><span class="bu">int</span>(cell_size<span class="op">/</span><span class="dv">1000</span>)<span class="sc">}</span><span class="vs">$\times$</span><span class="sc">{</span><span class="bu">int</span>(cell_size<span class="op">/</span><span class="dv">1000</span>)<span class="sc">}</span><span class="vs">km Grid Area"</span>],</span>
<span id="cb54-33"><a href="#cb54-33" aria-hidden="true" tabindex="-1"></a>    loc<span class="op">=</span><span class="st">"upper left"</span>,</span>
<span id="cb54-34"><a href="#cb54-34" aria-hidden="true" tabindex="-1"></a>    frameon<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb54-35"><a href="#cb54-35" aria-hidden="true" tabindex="-1"></a>    fontsize<span class="op">=</span><span class="dv">9</span>,</span>
<span id="cb54-36"><a href="#cb54-36" aria-hidden="true" tabindex="-1"></a>    handlelength<span class="op">=</span><span class="fl">1.5</span>,</span>
<span id="cb54-37"><a href="#cb54-37" aria-hidden="true" tabindex="-1"></a>    handleheight<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb54-38"><a href="#cb54-38" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb54-39"><a href="#cb54-39" aria-hidden="true" tabindex="-1"></a>ax.axis(<span class="st">"off"</span>)</span>
<span id="cb54-40"><a href="#cb54-40" aria-hidden="true" tabindex="-1"></a>fig.tight_layout()</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-54-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="exercise-5-adding-context" class="level2">
<h2 class="anchored" data-anchor-id="exercise-5-adding-context">Exercise 5: Adding Context</h2>
<div id="8a2e6ec6" class="cell" data-execution_count="338">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>gdf_sf <span class="op">=</span> gdf_hq.copy()[gdf_hq.geometry.within(county_shapes[county_shapes[<span class="st">'NAME'</span>] <span class="op">==</span> <span class="st">'San Francisco'</span>].iloc[<span class="dv">0</span>].geometry)]</span></code></pre></div>
</div>
<p>Web maps need a special crs</p>
<div id="e41432f8" class="cell" data-execution_count="339">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>sf_no_water_web_map <span class="op">=</span> bay_area_no_water[bay_area_no_water[<span class="st">'NAME'</span>] <span class="op">==</span> <span class="st">'San Francisco'</span>].to_crs(PSEUDO_MERCATOR_CRS)</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>gdf_sf_web_map <span class="op">=</span> gdf_sf.to_crs(PSEUDO_MERCATOR_CRS)</span></code></pre></div>
</div>
<p>Lets look at BART</p>
<div id="d2b05e7c" class="cell" data-execution_count="340">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>bart_stops <span class="op">=</span> gdf_sf_web_map[</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>    (gdf_sf_web_map[<span class="st">'agency_primary'</span>] <span class="op">==</span> <span class="st">'San Francisco Bay Area Rapid Transit District'</span>)</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>       ]</span></code></pre></div>
</div>
<p>https://contextily.readthedocs.io/en/latest/intro_guide.html#Providers</p>
<div id="7defd431" class="cell" data-execution_count="341">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">5</span>, <span class="dv">5</span>))</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>bart_stops.plot(ax<span class="op">=</span>ax, markersize<span class="op">=</span><span class="dv">9</span>, marker<span class="op">=</span><span class="st">"D"</span>)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>cx.add_basemap(ax, source<span class="op">=</span>cx.providers.CartoDB.VoyagerNoLabels, crs<span class="op">=</span>bart_stops.crs)</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>ax.axis(<span class="st">"off"</span>)</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>fig.tight_layout()<span class="op">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-59-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>https://stackoverflow.com/questions/68175234/change-contextily-basemap-size/79653580#79653580</p>
<div id="e829ea7e" class="cell" data-execution_count="342">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">5</span>, <span class="dv">5</span>))</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>sf_no_water_web_map.plot(ax<span class="op">=</span>ax, facecolor<span class="op">=</span><span class="st">"none"</span>)</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>bart_stops.plot(ax<span class="op">=</span>ax)<span class="op">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-60-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="3e6c8734" class="cell" data-execution_count="343">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>sf_bounds <span class="op">=</span> sf_no_water_web_map.bounds.iloc[<span class="dv">0</span>]</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>sf_bounds</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="343">
<pre><code>minx   -1.363863e+07
miny    4.538246e+06
maxx   -1.361748e+07
maxy    4.560119e+06
Name: 0, dtype: float64</code></pre>
</div>
</div>
<div id="74e00d54" class="cell" data-execution_count="344">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">5</span>, <span class="dv">5</span>))</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>bart_stops.plot(ax<span class="op">=</span>ax, markersize<span class="op">=</span><span class="dv">9</span>, marker<span class="op">=</span><span class="st">"D"</span>)</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Use another shape to determine the zoom/map size</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> sf_no_water_web_map.crs <span class="op">==</span> bart_stops.crs</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>ax.<span class="bu">set</span>(xlim <span class="op">=</span> (sf_bounds[<span class="st">'minx'</span>], sf_bounds[<span class="st">'maxx'</span>]),</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>       ylim <span class="op">=</span> (sf_bounds[<span class="st">'miny'</span>], sf_bounds[<span class="st">'maxy'</span>])</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>       )</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>ax.axis(<span class="st">"off"</span>)</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>ax.<span class="bu">set</span>(title<span class="op">=</span><span class="st">"BART Stops in San Francisco"</span>)</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>fig.tight_layout()</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>cx.add_basemap(ax, source<span class="op">=</span>cx.providers.CartoDB.VoyagerNoLabels, crs<span class="op">=</span>bart_stops.crs)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-62-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<section id="physical-infrastructure-features-with-osmnx" class="level3">
<h3 class="anchored" data-anchor-id="physical-infrastructure-features-with-osmnx">Physical Infrastructure Features with <code>osmnx</code></h3>
<p>Open Street Maps’ features API requires us to pass in a bounding box in the WGS84 projects along with tags that select features and it returns all of the requested features within that bounding box. Here, I pass in the bay area’s total bounds in the WGS84 projects, and specify subway rail (this is how Open Street Maps classifies BART).</p>
<p>The code returns a geodataframe of all of the subway rail in the bay area, stored as line segments with various interesting characteristics (e.g.&nbsp;max speed, whether it’s an underground or above ground segment, etc).</p>
<div id="418885c2" class="cell" data-execution_count="345">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>sf_bart_web <span class="op">=</span> (</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>    ox.features</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>    .features_from_bbox(</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>        bbox<span class="op">=</span>sf_no_water_web_map.to_crs(<span class="st">"EPSG:4326"</span>).total_bounds,</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>        tags<span class="op">=</span>{<span class="st">"railway"</span>: <span class="st">"subway"</span>})</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>    .to_crs(PSEUDO_MERCATOR_CRS))</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>sf_bart_web.head(<span class="dv">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="345">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">geometry</th>
<th data-quarto-table-cell-role="th">name</th>
<th data-quarto-table-cell-role="th">network</th>
<th data-quarto-table-cell-role="th">operator</th>
<th data-quarto-table-cell-role="th">railway</th>
<th data-quarto-table-cell-role="th">electrified</th>
<th data-quarto-table-cell-role="th">frequency</th>
<th data-quarto-table-cell-role="th">gauge</th>
<th data-quarto-table-cell-role="th">layer</th>
<th data-quarto-table-cell-role="th">maxspeed</th>
<th data-quarto-table-cell-role="th">owner</th>
<th data-quarto-table-cell-role="th">railway:preferred_direction</th>
<th data-quarto-table-cell-role="th">tunnel</th>
<th data-quarto-table-cell-role="th">voltage</th>
<th data-quarto-table-cell-role="th">cutting</th>
<th data-quarto-table-cell-role="th">level</th>
<th data-quarto-table-cell-role="th">note</th>
<th data-quarto-table-cell-role="th">wikipedia</th>
<th data-quarto-table-cell-role="th">bridge</th>
<th data-quarto-table-cell-role="th">service</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">element</th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td rowspan="2" data-quarto-table-cell-role="th" data-valign="top">way</td>
<td data-quarto-table-cell-role="th">24141635</td>
<td>LINESTRING (-13630727.47 4540516.258, -1363074...</td>
<td>M-Line</td>
<td>BART</td>
<td>NaN</td>
<td>subway</td>
<td>rail</td>
<td>0</td>
<td>1676</td>
<td>-1</td>
<td>36 mph</td>
<td>San Francisco Bay Area Rapid Transit District</td>
<td>forward</td>
<td>yes</td>
<td>1000</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">24141683</td>
<td>LINESTRING (-13630771.441 4540324.869, -136307...</td>
<td>M-Line</td>
<td>BART</td>
<td>NaN</td>
<td>subway</td>
<td>rail</td>
<td>0</td>
<td>1676</td>
<td>NaN</td>
<td>36 mph</td>
<td>San Francisco Bay Area Rapid Transit District</td>
<td>forward</td>
<td>NaN</td>
<td>1000</td>
<td>yes</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="edad9ea7" class="cell" data-execution_count="346">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">5</span>, <span class="dv">5</span>))</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> sf_no_water_web_map.crs <span class="op">==</span> bart_stops.crs</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>sf_bounds <span class="op">=</span> sf_no_water_web_map.bounds.iloc[<span class="dv">0</span>]</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>ax.<span class="bu">set</span>(xlim <span class="op">=</span> (sf_bounds[<span class="st">'minx'</span>], sf_bounds[<span class="st">'maxx'</span>]),</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>       ylim <span class="op">=</span> (sf_bounds[<span class="st">'miny'</span>], sf_bounds[<span class="st">'maxy'</span>])</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>       )</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>ax.axis(<span class="st">"off"</span>)</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>ax.<span class="bu">set</span>(title<span class="op">=</span><span class="st">"BART Stops in San Francisco"</span>)</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>cx.add_basemap(ax, source<span class="op">=</span>cx.providers.CartoDB.VoyagerNoLabels, crs<span class="op">=</span>bart_stops.crs)</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>sf_bart_web.plot(ax<span class="op">=</span>ax, linestyle<span class="op">=</span><span class="st">":"</span>, color<span class="op">=</span><span class="st">"grey"</span>, label<span class="op">=</span><span class="st">"BART Tracks"</span>)</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>bart_stops.plot(ax<span class="op">=</span>ax, markersize<span class="op">=</span><span class="dv">9</span>, marker<span class="op">=</span><span class="st">"D"</span>, label<span class="op">=</span><span class="st">"BART Stop"</span>)</span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>ax.legend()</span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>fig.tight_layout()</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-64-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>


</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{amerkhanian2025,
  author = {Amerkhanian, Peter},
  title = {Making Some Maps with {Python}},
  date = {2025-07-20},
  url = {https://peter-amerkhanian.com/posts/geopandas_maps/},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-amerkhanian2025" class="csl-entry quarto-appendix-citeas" role="listitem">
Amerkhanian, Peter. 2025. <span>“Making Some Maps with Python.”</span>
July 20, 2025. <a href="https://peter-amerkhanian.com/posts/geopandas_maps/">https://peter-amerkhanian.com/posts/geopandas_maps/</a>.
</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/peter-amerkhanian\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
          // target, if specified
          link.setAttribute("target", "_blank");
          if (link.getAttribute("rel") === null) {
            link.setAttribute("rel", "noopener");
          }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>Copyright 2024, Peter Amerkhanian</p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>