<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.551">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Peter Amerkhanian">
<meta name="dcterms.date" content="2024-05-31">

<title>The Covariance Matrix from Scratch</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../profile.jpg" rel="icon" type="image/jpeg">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-V95HGLKTEB"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-V95HGLKTEB', { 'anonymize_ip': true});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../profile.jpg" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Home</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../memos.html"> 
<span class="menu-text">Memos</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../projects.html"> 
<span class="menu-text">Projects</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">The Covariance Matrix from Scratch</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li></ul></div></div>
                                <div class="quarto-categories">
                <div class="quarto-category">Python</div>
                <div class="quarto-category">Linear Algebra</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Peter Amerkhanian </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">May 31, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
        <h2 id="toc-title"><a href="#" class="nav-link">The Covariance Matrix from Scratch</a></h2>
     
    <ul>
    <li><a href="#question-and-data" id="toc-question-and-data" class="nav-link active" data-scroll-target="#question-and-data">Question and Data</a>
    <ul class="collapse">
    <li><a href="#the-summation-formulation" id="toc-the-summation-formulation" class="nav-link" data-scroll-target="#the-summation-formulation">The summation formulation</a></li>
    <li><a href="#the-vector-formulation" id="toc-the-vector-formulation" class="nav-link" data-scroll-target="#the-vector-formulation">The vector formulation</a></li>
    <li><a href="#deriving-the-matrix-formulation" id="toc-deriving-the-matrix-formulation" class="nav-link" data-scroll-target="#deriving-the-matrix-formulation">Deriving the matrix formulation</a>
    <ul class="collapse">
    <li><a href="#building-the-centering-matrix" id="toc-building-the-centering-matrix" class="nav-link" data-scroll-target="#building-the-centering-matrix">Building the centering matrix</a></li>
    <li><a href="#a-note-on-broadcasting-and-numerical-methods" id="toc-a-note-on-broadcasting-and-numerical-methods" class="nav-link" data-scroll-target="#a-note-on-broadcasting-and-numerical-methods">A note on broadcasting and numerical methods</a></li>
    </ul></li>
    <li><a href="#the-matrix-formulation" id="toc-the-matrix-formulation" class="nav-link" data-scroll-target="#the-matrix-formulation">The matrix formulation</a>
    <ul class="collapse">
    <li><a href="#applying-it-to-data" id="toc-applying-it-to-data" class="nav-link" data-scroll-target="#applying-it-to-data">Applying it to data</a></li>
    </ul></li>
    </ul></li>
    </ul>
  </nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">






<script>
  document.getElementById('toc-title').addEventListener('click', function(event) {
  event.preventDefault(); // Prevent default behavior of anchor tag
  const firstHeader = document.querySelector('body'); // Select the first h2 element
  if (firstHeader) {
    firstHeader.scrollIntoView({ behavior: 'smooth', block: "start", inline: "nearest"}); // Scroll to the first header smoothly
  }
});
</script>
<div id="cell-1" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ucimlrepo</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sympy <span class="im">as</span> sp</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span></code></pre></div>
</details>
</div>
<p>The following is an overview of how to construct a covariance matrix. The post is largely based on exercises in <span class="citation" data-cites="cohen_practical_2022">(<a href="#ref-cohen_practical_2022" role="doc-biblioref">Cohen 2022</a>)</span>, an excellent overview of applied, numerical linear algebra in python. I overview how to construct a covariance matrix, but in the process I try to touch on a lot of important concepts in fundamental linear algebra: matrix multiplication, matrix transformations, the centering matrix, and getting from the idea of a matrix operation to the formal notation.</p>
<p>I want to stress that the methods and procedures that I overview here are examples of <em>analytical</em> linear algebra. I’m looking at a lot of pen and paper methods for defining operations. In <em>numerical</em> linear algebra, where we actually compute this stuff on data, methodology is different. If you look into how <code>numpy</code> computes covariance, it’s not going to look anything like this. However, learning these analytical fundamentals has value – both in making it easier to read linear algebra heavy textbooks, and in being able to write out operations and ideas in parsimonious mathematical statements.</p>
<section id="question-and-data" class="level1">
<h1>Question and Data</h1>
<p>In <span class="citation" data-cites="cohen_practical_2022">(<a href="#ref-cohen_practical_2022" role="doc-biblioref">Cohen 2022</a>)</span>, the covariance exercises are based on the <a href="https://archive.ics.uci.edu/dataset/183/communities+and+crime">“Communities and Crime,” dataset from the UC Irvine Machine Learning Repository</a>, which includes data on:</p>
<blockquote class="blockquote">
<p>Communities within the United States. The data combines socio-economic data from the 1990 US Census, law enforcement data from the 1990 US LEMAS survey, and crime data from the 1995 FBI UCR.</p>
</blockquote>
<p>I’ll use the same data.</p>
<div id="cell-3" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fetch the dataset </span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>communities_and_crime: ucimlrepo.dotdict <span class="op">=</span> ucimlrepo.fetch_ucirepo(<span class="bu">id</span><span class="op">=</span><span class="dv">183</span>) </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>df: pd.DataFrame <span class="op">=</span> pd.concat([communities_and_crime.data.features,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>                              communities_and_crime.data.features], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Isolate numerical features and clear duplicate columns</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>df_num: pd.DataFrame <span class="op">=</span> df.copy().select_dtypes(include<span class="op">=</span><span class="st">'number'</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>df_num <span class="op">=</span> df_num.loc[:,<span class="op">~</span>df_num.columns.duplicated()]</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>df_num <span class="op">=</span> df_num.iloc[:, <span class="dv">2</span>:]</span></code></pre></div>
</details>
</div>
<p>To make the operations as clear as possible, I’m going to focus on the first five rows and first two columns for the majority of this post.</p>
<div id="cell-5" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>example <span class="op">=</span> df_num.head()[[<span class="st">'population'</span>, <span class="st">'householdsize'</span>]]</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>example</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">population</th>
<th data-quarto-table-cell-role="th">householdsize</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0.19</td>
<td>0.33</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0.00</td>
<td>0.16</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0.00</td>
<td>0.42</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0.04</td>
<td>0.77</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0.01</td>
<td>0.55</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<section id="the-summation-formulation" class="level2">
<h2 class="anchored" data-anchor-id="the-summation-formulation">The summation formulation</h2>
<p>Say we have two columns, <code>population</code> and <code>householdsize</code>, and we’d like to know to what degree they are associated. I’ll refer to these as <code>x</code> and <code>y</code>, respectively.</p>
<div id="cell-7" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> example[<span class="st">'population'</span>]</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> example[<span class="st">'householdsize'</span>]</span></code></pre></div>
</div>
<p>I can compute their covariance statistic via the following equation, where <span class="math inline">\(x\)</span> is <code>population</code>, and <span class="math inline">\(y\)</span> is <code>householdsize</code></p>
<p><span id="eq-one"><span class="math display">\[
c_{x, y} = (n-1)^{-1} \sum_{i=1} ^n (x_i - \bar{x})(y_i - \bar{y})
\tag{1}\]</span></span> <span class="citation" data-cites="cohen_practical_2022">(<a href="#ref-cohen_practical_2022" role="doc-biblioref">Cohen 2022, chap. 7</a>)</span></p>
<p>I’ll create a function that makes the equation operational for any two arrays, <code>x</code> and <code>y</code>:</p>
<div id="cell-11" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> bivariate_cov(x: np.array, y: np.array) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    x_bar: <span class="bu">float</span> <span class="op">=</span> x.mean()</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    y_bar: <span class="bu">float</span> <span class="op">=</span> y.mean()</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(x)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    summation <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>        summation <span class="op">+=</span> (x.loc[i] <span class="op">-</span> x_bar) <span class="op">*</span> (y.loc[i] <span class="op">-</span> y_bar)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> summation <span class="op">/</span> (n<span class="op">-</span><span class="dv">1</span>)</span></code></pre></div>
</div>
<p>For <code>population</code> and <code>householdsize</code> the covariance statistic is:</p>
<div id="cell-13" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"cov(x, y):"</span>, bivariate_cov(x, y))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>cov(x, y): -0.0020099999999999996</code></pre>
</div>
</div>
<p>I’ll check my answer with a built in function, <code>numpy.cov()</code>:</p>
<div id="cell-15" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>np.cov(x, y)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>array([[ 0.00657, -0.00201],
       [-0.00201,  0.05293]])</code></pre>
</div>
</div>
<p>This is clearly different! Rather than a scalar, this function returned a matrix. However, the upper and lower triangles of the matrix are the same as the covariance value we computed. Indeed, what numpy returned for covariance is the following matrix: <span id="eq-cov-matrix"><span class="math display">\[
C =
\left[
\begin{matrix}
    var(x) &amp; cov(x, y) \\
    cov(y, x) &amp; var(y) \\
\end{matrix}
\right]
\tag{2}\]</span></span></p>
<p>We can compute the variances of <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> to confirm this (note that variance is a special case of covariance where the <code>x</code> and <code>y</code> input are equal)</p>
<div id="cell-17" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"var(x):"</span>, bivariate_cov(x, x))</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"var(y):"</span>, bivariate_cov(y, y))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>var(x): 0.006570000000000002
var(y): 0.05293000000000001</code></pre>
</div>
</div>
<p>But how do we get the linear algebra formula that <code>numpy</code> used to produce that matrix, <span class="math inline">\(C\)</span>?</p>
</section>
<section id="the-vector-formulation" class="level2">
<h2 class="anchored" data-anchor-id="the-vector-formulation">The vector formulation</h2>
<p>To get our output to match numpy’s we’ll start by generalizing the covariance equation to input vectors. Recall the summation equation:</p>
<p><span class="math display">\[
\begin{align*}
c_{x, y} &amp;= (n-1)^{-1} \sum_{i=1} ^n (x_i - \bar{x})(y_i - \bar{y}) \\
\end{align*}  
\]</span></p>
<p>To convert this into an equation that uses vectors, we’ll note that the <span class="math inline">\(\sum_{i=1}^n(\cdots)_i(\cdots)_i\)</span> term above corresponds to a “dot product” in linear algebra. We write this out as follows: <span class="math display">\[
\begin{align*}
c_{x, y} &amp;= (n-1)^{-1}(\mathbf {x}_{n \times 1} - \bar{\mathbf {x}})^\intercal (\mathbf {y}_{n \times 1} - \bar{\mathbf {y}}) \\
\end{align*}  
\]</span></p>
<p><span class="citation" data-cites="cohen_practical_2022">(<a href="#ref-cohen_practical_2022" role="doc-biblioref">Cohen 2022, chap. 7</a>)</span></p>
<p>Note the following notational conventions:</p>
<ul>
<li>the boldface x, <span class="math inline">\(\mathbf {x}_{n \times 1}\)</span> refers to a vector with dimensions <span class="math inline">\(n \times 1\)</span> and all the elements <span class="math inline">\(x_i\)</span>, <span class="math inline">\(i \in [1,2, \cdots, n]\)</span></li>
<li><span class="math inline">\(\bar{\mathbf {x}}\)</span> and <span class="math inline">\(\bar{x}\)</span> are equivalent – both represent the mean of the vector.</li>
<li><span class="math inline">\(^\intercal\)</span> represents the transpose. The short of this is that <span class="math inline">\((\mathbf {x}_{n \times 1} - \bar{\mathbf {x}})\)</span> is an <span class="math inline">\(n \times 1\)</span> vector. When we transpose it, it becomes a <span class="math inline">\(1 \times n\)</span> vector, which is necessary for this multiplication to work. I’m going to go into detail on this a little later, but for now just know that transposing a vector switches its row and column dimensions. For example, here we convert a column, <span class="math inline">\(n \times 1\)</span> vector into a row, <span class="math inline">\(1 \times n\)</span> vector:</li>
</ul>
<p><span class="math display">\[
\left[\begin{matrix}x_1\\x_2\\x_3\\x_4\\x_5\end{matrix}\right]_{n \times 1}^\intercal = \left[\begin{matrix}x_1&amp;x_2&amp;x_3&amp;x_4&amp;x_5\end{matrix}\right]_{1 \times n}
\]</span></p>
<p>Rather than overview every rule of linear algebra operations now, I’ll compute the covariance of the two variables in our dataset and we can directly examine how basic vector-scalar and vector-vector operations come out.<br>
I’ll denote the vectors and their means below:</p>
<div id="cell-21" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"x:"</span>, x.values, <span class="st">"</span><span class="ch">\n</span><span class="st">mean(x)="</span>, x.mean())</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"y:"</span>, y.values,  <span class="st">"</span><span class="ch">\n</span><span class="st">mean(y)="</span>, y.mean())</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"n = "</span>, <span class="bu">len</span>(x))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>x: [0.19 0.   0.   0.04 0.01] 
mean(x)= 0.048
y: [0.33 0.16 0.42 0.77 0.55] 
mean(y)= 0.446
n =  5</code></pre>
</div>
</div>
<p>And we can now plug everything into that vector formula for covariance:</p>
<p><span class="math display">\[
\begin{align*}
c_{x, y} &amp;= (n-1)^{-1}(\mathbf {x}_{n \times 1} - \bar{\mathbf {x}})^\intercal (\mathbf {y}_{n \times 1} - \bar{\mathbf {y}}) \\
&amp;= \frac{1}{4} (\left[\begin{matrix}0.19\\0\\0\\0.04\\0.01\end{matrix}\right] - 0.048)^\intercal (\left[\begin{matrix}0.33\\0.16\\0.42\\0.77\\0.55\end{matrix}\right] - 0.446) \\
&amp;= \frac{1}{4} (\left[\begin{matrix}0.142\\-0.048\\-0.048\\-0.008\\-0.038\end{matrix}\right]^\intercal \left[\begin{matrix}-0.116\\-0.286\\-0.026\\0.324\\0.104\end{matrix}\right]) \\
&amp;= \frac{1}{4} ((0.142) (-0.116) + (-0.048) (-0.286) \\
&amp;\quad \quad + (-0.048) (-0.026) + (-0.008) (0.324) \\
&amp;\quad \quad + (-0.038) (0.104) )  \\
&amp;\approx \frac{1}{4} (-0.00804) \\
&amp;\approx -0.00201
\end{align*}
\]</span></p>
<p>In python we can confirm our result, where <code>@</code> computes the dot product in python’s <code>numpy</code> library:</p>
<div id="cell-25" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>x_bar: <span class="bu">float</span> <span class="op">=</span> x.mean()</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>y_bar: <span class="bu">float</span> <span class="op">=</span> y.mean()</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="bu">len</span>(x)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>((x <span class="op">-</span> x_bar).T <span class="op">@</span> (y <span class="op">-</span> y_bar)) <span class="op">/</span> (n <span class="op">-</span> <span class="dv">1</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>-0.0020099999999999996</code></pre>
</div>
</div>
</section>
<section id="deriving-the-matrix-formulation" class="level2">
<h2 class="anchored" data-anchor-id="deriving-the-matrix-formulation">Deriving the matrix formulation</h2>
<p>The vector formulation is not particularly useful, so we will quickly move on to the matrix formulation, which will produce output equivalent to <code>np.cov()</code>.</p>
<p>Before we get to the equation, we’ll start by defining a matrix, <span class="math inline">\(X\)</span>, made up of the vectors <span class="math inline">\(\mathbf{x}\)</span> and <span class="math inline">\(\mathbf{y}\)</span>:<br>
<span class="math display">\[
X_{n \times 2} =
\left[
\begin{matrix}
\vert &amp; \vert \\
    \mathbf{x}   &amp; \mathbf{y}   \\
    \vert &amp; \vert
\end{matrix}
\right]_{n \times 2} = \left[
\begin{matrix}
    x_1   &amp; y_1   \\
    x_2   &amp; y_2   \\
    \vdots   &amp; \vdots   \\
    x_n   &amp; y_n   \\
\end{matrix}
\right]_{n \times 2}
\]</span></p>
<p>This is really just our full dataset:</p>
<div id="cell-27" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> example[[<span class="st">'population'</span>, <span class="st">'householdsize'</span>]]</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>X</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">population</th>
<th data-quarto-table-cell-role="th">householdsize</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0.19</td>
<td>0.33</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0.00</td>
<td>0.16</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0.00</td>
<td>0.42</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0.04</td>
<td>0.77</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0.01</td>
<td>0.55</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>Now we want to create a currently unknown operation that will take in this matrix, <span class="math inline">\(X\)</span>, and output the covariance matrix, (<a href="#eq-cov-matrix" class="quarto-xref">Equation&nbsp;2</a>). In thinking about this, lets decompose what exactly that covariance matrix is, incorporating the simple summation formula, then the vector formula we just learned:</p>
<p><span class="math display">\[
\begin{align*}
???(X) &amp;=
\left[
\begin{matrix}
    var(x) &amp; cov(x, y) \\
    cov(y, x) &amp; var(y) \\
\end{matrix}
\right] \\
&amp;=\left[
\begin{matrix}
\sum_{i=1}^{n} (x_i - \bar{\mathbf{x}})(x_i - \bar{\mathbf{x}}) &amp; \sum_{i=1}^{n} (x_i - \bar{\mathbf{x}})(y_i - \bar{\mathbf{y}}) \\
\sum_{i=1}^{n} (y_i - \bar{\mathbf{y}})(x_i - \bar{\mathbf{x}}) &amp; \sum_{i=1}^{n} (y_i - \bar{\mathbf{y}})(y_i - \bar{\mathbf{y}}) \\
\end{matrix}
\right] (n-1)^{-1}\\
&amp;= \left[
\begin{matrix}
(\mathbf {x} - \bar{\mathbf {x}})^\intercal (\mathbf {x} - \bar{\mathbf {x}}) &amp; (\mathbf {x} - \bar{\mathbf {x}})^\intercal (\mathbf {y} - \bar{\mathbf {y}}) \\
(\mathbf {y} - \bar{\mathbf {y}})^\intercal (\mathbf {x} - \bar{\mathbf {x}}) &amp; (\mathbf {y} - \bar{\mathbf {y}})^\intercal (\mathbf {y} - \bar{\mathbf {y}}) \\
\end{matrix}
\right] (n-1)^{-1}
\end{align*}
\]</span> Set aside the value, <span class="math inline">\((n-1)^{-1}\)</span> for now, and just consider what this matrix of dot products is made of.</p>
<p>I defer to the <a href="https://en.wikipedia.org/wiki/Matrix_multiplication#Vector_times_matrix">wikipedia entry on matrix-matrix multiplication</a> to define the exact process, but consider that when you multiply two matrices, each entry in the output matrix is the dot product of the <span class="math inline">\(i\)</span> th row of the left matrix and the <span class="math inline">\(j\)</span> th column of the right matrix. Given that definition and the fact that our output above is a matrix of dot products, lets define it as the output of a multiplication operation between some currently unknown left and right matrix. Specifically:</p>
<p><span class="math display">\[
\begin{align*}
\left[
\begin{matrix}
(\mathbf {x} - \bar{\mathbf {x}})^\intercal (\mathbf {x} - \bar{\mathbf {x}}) &amp; (\mathbf {x} - \bar{\mathbf {x}})^\intercal (\mathbf {y} - \bar{\mathbf {y}}) \\
(\mathbf {y} - \bar{\mathbf {y}})^\intercal (\mathbf {x} - \bar{\mathbf {x}}) &amp; (\mathbf {y} - \bar{\mathbf {y}})^\intercal (\mathbf {y} - \bar{\mathbf {y}}) \\
\end{matrix}
\right] &amp;= \\
\left[
\begin{matrix}
(\text{Row 1, Left Matrix}) \cdot (\text{Col 1, Right Matrix}) &amp; (\text{Row 1, Left Matrix}) \cdot (\text{Col 2, Right Matrix})  \\
(\text{Row 2, Left Matrix}) \cdot (\text{Col 1, Right Matrix}) &amp; (\text{Row 2, Left Matrix}) \cdot (\text{Col 2, Right Matrix})\\
\end{matrix}
\right]
\end{align*}
\]</span></p>
<p>We can use the equivalence of these two statements to define what the rows and columns are for the left and right matrix:</p>
<p><span class="math display">\[
\begin{align*}
C &amp;= \left[
\begin{matrix}
    —&amp;(\text{Row 1})  &amp;—   \\
    —&amp; (\text{Row 2}) &amp;—
\end{matrix}
\right]
\left[
\begin{matrix}
\vert &amp; \vert \\
    (\text{Col 1})   &amp; (\text{Col 2})   \\
    \vert &amp; \vert
\end{matrix}
\right] (n-1)^{-1}\\
&amp;=
\left[
\begin{matrix}
    —&amp;(\mathbf{x}-\bar{\mathbf{x}})  &amp;—   \\
    —&amp; (\mathbf{y}-\bar{\mathbf{y}}) &amp;—
\end{matrix}
\right]
\left[
\begin{matrix}
\vert &amp; \vert \\
    (\mathbf{x}-\bar{\mathbf{x}})   &amp; (\mathbf{y}-\bar{\mathbf{y}})   \\
    \vert &amp; \vert
\end{matrix}
\right] (n-1)^{-1}
\end{align*}
\]</span> This is a good time to explain how a matrix transpose works. We can see that the rows 1 and 2 of the left matrix are the same as the columns 1 and 2 of the right matrix. This means that the left matrix is a transpose of the right matrix (or vice versa).</p>
<blockquote class="blockquote">
<p>I think it’s […] easy to remember that <strong>transposing swaps rows and columns</strong><br>
– <span class="citation" data-cites="cohen_practical_2022">(<a href="#ref-cohen_practical_2022" role="doc-biblioref">Cohen 2022, chap. 5</a>)</span></p>
</blockquote>
<p><span class="math display">\[
\left[
\begin{matrix}
\vert &amp; \vert \\
    (\mathbf{x}-\bar{\mathbf{x}})   &amp; (\mathbf{y}-\bar{\mathbf{y}})   \\
    \vert &amp; \vert
\end{matrix}
\right]^\intercal =
\left[
\begin{matrix}
    —&amp;(\mathbf{x}-\bar{\mathbf{x}})  &amp;—   \\
    —&amp; (\mathbf{y}-\bar{\mathbf{y}}) &amp;—
\end{matrix}
\right]
\]</span></p>
<p>When we plug that in, we get the typical formula for covariance.</p>
<p><span id="eq-cov-mat"><span class="math display">\[
\begin{align*}
C &amp;=
\left[
\begin{matrix}
x_1 - \bar{\mathbf{x}}   &amp; y_1 - \bar{\mathbf{y}}   \\
    x_2 - \bar{\mathbf{x}}   &amp; y_2 - \bar{\mathbf{y}}   \\
    \vdots   &amp; \vdots   \\
    x_n - \bar{\mathbf{x}}   &amp; y_n - \bar{\mathbf{y}}   \\
\end{matrix}
\right]_{n \times 2}^\intercal
\left[
\begin{matrix}
x_1 - \bar{\mathbf{x}}   &amp; y_1 - \bar{\mathbf{y}}   \\
    x_2 - \bar{\mathbf{x}}   &amp; y_2 - \bar{\mathbf{y}}   \\
    \vdots   &amp; \vdots   \\
    x_n - \bar{\mathbf{x}}   &amp; y_n - \bar{\mathbf{y}}   \\
\end{matrix}
\right]_{n \times 2} (n-1)^{-1}
\end{align*}
\tag{3}\]</span></span></p>
<p>So now we know the matrix operation that will yield the covariance matrix, <span class="math inline">\(C\)</span>, from the matrix, <span class="math inline">\(X\)</span> – we find the mean-centered representation of <span class="math inline">\(X\)</span>, multiply that with itself, and then multiply the result by the scalar, <span class="math inline">\((n-1)^{-1}\)</span>. This is a fairly straightforward operation, but <strong>it’s not really an equation yet.</strong> We will now formalize it into one.</p>
<section id="building-the-centering-matrix" class="level3">
<h3 class="anchored" data-anchor-id="building-the-centering-matrix">Building the centering matrix</h3>
<p>We want to subtract the mean of x from the x elements, and the mean of y from the y elements, all in one matrix. In the vector setting above, we set this up as the difference between a vector and its scalar mean. Vector-scalar operations are intuitive in linear algebra:</p>
<p><span class="math display">\[
\left[
\begin{matrix}
    x_1  \\
    x_2   \\
    \vdots   \\
    x_n
\end{matrix}
\right]_{n \times 1} - \bar{\mathbf{x}} = \left[
\begin{matrix}
x_1 - \bar{\mathbf{x}}   \\
    x_2 - \bar{\mathbf{x}}    \\
    \vdots   \\
    x_n - \bar{\mathbf{x}}     \\
\end{matrix}
\right]_{n \times 1}
\, \text{ and } \,
\left[
\begin{matrix}
    y_1  \\
    y_2   \\
    \vdots   \\
    y_n
\end{matrix}
\right]_{n \times 1} - \bar{\mathbf{y}} = \left[
\begin{matrix}
y_1 - \bar{\mathbf{y}}   \\
    y_2 - \bar{\mathbf{y}}    \\
    \vdots   \\
    y_n - \bar{\mathbf{y}}     \\
\end{matrix}
\right]_{n \times 1}
\]</span></p>
<p>In a matrix formulation, this is slightly different.</p>
<blockquote class="blockquote">
<p>You add [or subtract] two matrices by adding their corresponding elements. […]<br>
Matrix addition [and subtraction] is <strong>defined only between two matrices of the same size.</strong></p>
<p>– <span class="citation" data-cites="cohen_practical_2022">(<a href="#ref-cohen_practical_2022" role="doc-biblioref">Cohen 2022, chap. 5</a>)</span></p>
</blockquote>
<p>Therefore, we would set <span class="math inline">\(x_i - \bar{x}\)</span> and <span class="math inline">\(y_i - \bar{y}\)</span> up in a matrix formulation as follows:</p>
<p><span class="math display">\[  
\left[
\begin{matrix}
    x_1   &amp; y_1   \\
    x_2   &amp; y_2   \\
    \vdots   &amp; \vdots   \\
    x_n   &amp; y_n   \\
\end{matrix}
\right]_{n \times 2} -
\left[
\begin{matrix}
    \bar{\mathbf{x}}   &amp; \bar{\mathbf{y}}   \\
    \bar{\mathbf{x}}   &amp; \bar{\mathbf{y}}   \\
    \vdots   &amp; \vdots   \\
    \bar{\mathbf{x}}   &amp; \bar{\mathbf{y}}   \\
\end{matrix}
\right]_{n \times 2} =
\left[
\begin{matrix}
x_1 - \bar{\mathbf{x}}   &amp; y_1 - \bar{\mathbf{y}}   \\
    x_2 - \bar{\mathbf{x}}   &amp; y_2 - \bar{\mathbf{y}}   \\
    \vdots   &amp; \vdots   \\
    x_n - \bar{\mathbf{x}}   &amp; y_n - \bar{\mathbf{y}}   \\
\end{matrix}
\right]_{n \times 2}
\]</span></p>
<p>But how do we produce the <span class="math inline">\(n \times 2\)</span> matrix of column means that this equation requires?<br>
<span id="eq-mat-means"><span class="math display">\[
??? = \left[
\begin{matrix}
    \bar{\mathbf{x}}   &amp; \bar{\mathbf{y}}   \\
    \bar{\mathbf{x}}   &amp; \bar{\mathbf{y}}   \\
    \vdots   &amp; \vdots   \\
    \bar{\mathbf{x}}   &amp; \bar{\mathbf{y}}   \\
\end{matrix}
\right]_{n \times 2}
\tag{4}\]</span></span></p>
<p>Given that these means are functions of the elements of <span class="math inline">\(\mathbf{x}\)</span> and <span class="math inline">\(\mathbf{y}\)</span> respectively, we are going to try to create a function that takes in the matrix <span class="math inline">\(X\)</span> and outputs the matrix of means above, (<a href="#eq-mat-means" class="quarto-xref">Equation&nbsp;4</a>).</p>
<section id="the-mean-as-a-matrix-transformation" class="level4">
<h4 class="anchored" data-anchor-id="the-mean-as-a-matrix-transformation">The mean as a matrix transformation</h4>
<p>To build that function, lets start by considering a standard definition of the average and translate it into a “matrix transformation”. The simple summation formulation for the mean is as follows:<br>
<span class="math display">\[
\bar{x} = \frac{1}{n}\sum_{i=1}^n x_i = \sum_{i=1}^n \frac{1}{n}x_i
\]</span> The summation, <span class="math inline">\(\sum_{i=1}^n \frac{1}{n}x_i\)</span>, maps directly to a simple dot product:<br>
<span class="math display">\[
\begin{align*}
\bar{x} &amp;= \sum_{i=1}^n \frac{1}{n}x_i \\
&amp;= \frac{1}{n}x_1 + \frac{1}{n}x_2 + \cdots \frac{1}{n}x_n \\
&amp;= \left[\begin{matrix}\frac{1}{n} &amp; \frac{1}{n} &amp; \cdots &amp; \frac{1}{n}\end{matrix}\right]_{1 \times n} \left[\begin{matrix}x_1\\x_2\\\vdots\\x_n\end{matrix}\right]_{n \times 1}
\end{align*}
\]</span> This is interesting (really), because it looks like if we multiply <span class="math inline">\(\left[\begin{matrix}\frac{1}{n} &amp; \frac{1}{n} &amp; \cdots &amp; \frac{1}{n}\end{matrix}\right]_{1 \times n}\)</span> by any <span class="math inline">\(n \times 1\)</span> vector, we get the mean. So it seems like the following is a function that takes in a vector, multiplies it with another vector, and outputs the average of the input vector: <span id="eq-simple-mean"><span class="math display">\[
\bar{x} = f(\mathbf{x}_{n \times 1}) = \left[\begin{matrix}\frac{1}{n} &amp; \frac{1}{n} &amp; \cdots &amp; \frac{1}{n}\end{matrix}\right]_{1 \times n} \mathbf{x}_{n \times 1}
\tag{5}\]</span></span></p>
<p>Lets confirm this behavior with code:</p>
<div id="cell-32" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"n ="</span>, <span class="bu">len</span>(x))</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"[1/n, 1/n, ... 1/n] = "</span>, <span class="dv">1</span><span class="op">/</span><span class="bu">len</span>(x) <span class="op">*</span> np.ones(<span class="bu">len</span>(x)).T)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"x = "</span>, x.values)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"[1/n, 1/n, ... 1/n] @ x = "</span>, <span class="bu">round</span>(<span class="dv">1</span><span class="op">/</span><span class="bu">len</span>(x) <span class="op">*</span> np.ones(<span class="bu">len</span>(x)).T <span class="op">@</span> x, <span class="dv">5</span>)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"mean = "</span>, x.mean())</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"^ these are equal"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>n = 5
[1/n, 1/n, ... 1/n] =  [0.2 0.2 0.2 0.2 0.2]
x =  [0.19 0.   0.   0.04 0.01]

[1/n, 1/n, ... 1/n] @ x =  0.048
mean =  0.048
^ these are equal</code></pre>
</div>
</div>
<p>Now that we’ve confirmed that the function works, lets create formal notation for it. Consider the vector of 1s, <span class="math inline">\(\mathbf{1}\)</span>:<br>
<span class="math display">\[
\mathbf{1}_{n \times 1} = \left[\begin{matrix}1\\1\\\vdots\\1\end{matrix}\right]_{n \times 1} \\
\]</span> If we mutliply that by <span class="math inline">\(1/n\)</span> and transpose the result, we get the vector from our function, (<a href="#eq-simple-mean" class="quarto-xref">Equation&nbsp;5</a>): <span class="math display">\[
n^{-1}\mathbf{1}_{n \times 1}^\intercal = \left[\begin{matrix}\frac{1}{n} &amp; \frac{1}{n} &amp; \cdots &amp; \frac{1}{n}\end{matrix}\right]_{1 \times n}
\]</span></p>
<p>With that notation, we’ll now redefine the function as the matrix transformation, <span class="math inline">\(T_\text{mean}\)</span>, that transforms a <span class="math inline">\(n \times 1\)</span> matrix (this is just a vector) into its scalar mean. <span class="math display">\[
T_\text{mean}: \mathbb{R}^n \rightarrow \mathbb{R}^1 \quad \text{defined by} \quad T(\mathbf{x}_{n \times 1}) = n^{-1}\mathbf{1}_{n \times 1}^\intercal \mathbf{x}_{n \times 1}
\]</span></p>
<p>Looks weird and potentially useless, but we’ll use this same approach to define notation for the matrix of deviations from the mean from (<a href="#eq-cov-mat" class="quarto-xref">Equation&nbsp;3</a>)</p>
</section>
<section id="deviation-from-the-mean-as-a-matrix-transformation" class="level4">
<h4 class="anchored" data-anchor-id="deviation-from-the-mean-as-a-matrix-transformation">Deviation from the mean as a matrix transformation</h4>
<p><span class="math inline">\(T_\text{mean}\)</span> yields a scalar, <span class="math inline">\(\bar{x}\)</span>, and it could also easily be used to find <span class="math inline">\(\bar{y}\)</span>, but I want the matrix: <span class="math display">\[
\left[
\begin{matrix}
    \bar{\mathbf{x}}   &amp; \bar{\mathbf{y}}   \\
    \bar{\mathbf{x}}   &amp; \bar{\mathbf{y}}   \\
    \vdots   &amp; \vdots   \\
    \bar{\mathbf{x}}   &amp; \bar{\mathbf{y}}   \\
\end{matrix}
\right]_{n \times 2}
\]</span> To move towards that output, an <span class="math inline">\(n \times 2\)</span> matrix, lets consider some points about matrix multiplication.</p>
</section>
<section id="an-aside-about-matrix-multiplication-rules" class="level4">
<h4 class="anchored" data-anchor-id="an-aside-about-matrix-multiplication-rules">An aside about matrix multiplication rules</h4>
<p>In matrix multiplication, the following properties hold with regards to dimensions of the input and output:</p>
<ol type="1">
<li>Operations are only valid if the column dimension of the left input matrix matches the row dimension of the right input matrix.</li>
<li>The output has the row dimension of the left matrix and the column dimension of the right matrix.</li>
</ol>
<p>– <span class="citation" data-cites="cohen_practical_2022">(<a href="#ref-cohen_practical_2022" role="doc-biblioref">Cohen 2022, chap. 5</a>)</span></p>
<p>For example, in all of our previous vector <span class="math inline">\(\times\)</span> vector operations, our dimensionality was as follows:<br>
<span class="math display">\[
\begin{align*}
(1 \times \fbox{n})(\fbox{n} \times 1) \quad&amp; (n = n) \rightarrow \text{Operation is valid} \\
(\fbox{1} \times n)(n \times \fbox{1}) \quad&amp; (1 \times 1) \rightarrow \text{Output is scalar}
\end{align*}
\]</span> (Sometimes we had to transpose one of the vectors for this to be the case).</p>
<p>If we want to produce an <span class="math inline">\(n \times 2\)</span> matrix from a multiplication operation involving an <span class="math inline">\(n \times 2\)</span> input (our data matrix, <span class="math inline">\(X\)</span>), we would need a matrix with the following, underlined dimensionality:<br>
<span class="math display">\[
\underline{(n \times n)} (n \times 2) \rightarrow \text{Valid with output: } (n \times 2)
\]</span> Upon some reflection, the <span class="math inline">\(n \times n\)</span> matrix must be the matrix where every element is <span class="math inline">\(1/n\)</span>. The following operation gives us the desired matrix with all elements set as the original column mean: <span class="math display">\[
\left[
\begin{matrix}
    \frac{1}{n}   &amp; \frac{1}{n}   &amp; \cdots &amp; \frac{1}{n}\\
    \frac{1}{n}   &amp; \frac{1}{n}   &amp; \cdots &amp; \frac{1}{n}\\
    \vdots   &amp; \vdots   &amp; \cdots &amp; \frac{1}{n}\\
    \frac{1}{n}   &amp; \frac{1}{n}   &amp; \cdots &amp; \frac{1}{n}
\end{matrix}
\right]_{n \times n}
\left[
\begin{matrix}
    x_1   &amp; y_1   \\
    x_2   &amp; y_2   \\
    \vdots   &amp; \vdots   \\
    x_n   &amp; y_n   \\
\end{matrix}
\right]_{n \times 2} =
\left[
\begin{matrix}
    \sum_{i=1}^n \frac{x_i}{n}   &amp; \sum_{i=1}^n \frac{y_i}{n}   \\
    \sum_{i=1}^n \frac{x_i}{n}   &amp; \sum_{i=1}^n \frac{y_i}{n}  \\
    \vdots   &amp; \vdots   \\
    \sum_{i=1}^n \frac{x_i}{n}   &amp; \sum_{i=1}^n \frac{y_i}{n}   \\
\end{matrix}
\right]_{n \times 2}
= \left[
\begin{matrix}
    \bar{\mathbf{x}}   &amp; \bar{\mathbf{y}}   \\
    \bar{\mathbf{x}}   &amp; \bar{\mathbf{y}}   \\
    \vdots   &amp; \vdots   \\
    \bar{\mathbf{x}}   &amp; \bar{\mathbf{y}}   \\
\end{matrix}
\right]_{n \times 2}
\]</span></p>
</section>
<section id="notation-of-the-transformation" class="level4">
<h4 class="anchored" data-anchor-id="notation-of-the-transformation">Notation of the transformation</h4>
<p>We will need that matrix of <span class="math inline">\(1/n\)</span> values in our covariance matrix equation. We’ll now formalize the construction of that matrix so that we can write it in an equation, much as we did for the scalar mean in the previous section.</p>
<p>We can construct a square matrix of 1s by multiplying the 1s vector with its transpose, <span class="math inline">\((n \times 1)(1 \times n) \rightarrow (n \times n)\)</span>. Then we can multiply the matrix by <span class="math inline">\(1/n\)</span>, which will apply to each element in the matrix:</p>
<p><span class="math display">\[
\begin{align*}
n^{-1} \mathbf{1}_{n \times 1} \mathbf{1}_{n \times 1}^\intercal &amp;= n^{-1} \left[\begin{matrix}1\\1\\\vdots\\1\end{matrix}\right]_{n \times 1} \left[\begin{matrix}1 &amp; 1 &amp; \cdots &amp; 1\end{matrix}\right]_{1 \times n} \\
&amp;= n^{-1} \left[
\begin{matrix}
    1   &amp; 1   &amp; \cdots &amp; 1\\
    1   &amp; 1   &amp; \cdots &amp; 1\\
    \vdots   &amp; \vdots   &amp; \cdots &amp; 1\\
    1   &amp; 1   &amp; \cdots &amp; 1
\end{matrix}
\right]_{n \times n} \\
&amp;= \left[
\begin{matrix}
    \frac{1}{n}   &amp; \frac{1}{n}   &amp; \cdots &amp; \frac{1}{n}\\
    \frac{1}{n}   &amp; \frac{1}{n}   &amp; \cdots &amp; \frac{1}{n}\\
    \vdots   &amp; \vdots   &amp; \cdots &amp; \frac{1}{n}\\
    \frac{1}{n}   &amp; \frac{1}{n}   &amp; \cdots &amp; \frac{1}{n}
\end{matrix}
\right]_{n \times n}
\end{align*}
\]</span></p>
<p>Thus the transformation that creates the “matrix of means,” (<a href="#eq-mat-means" class="quarto-xref">Equation&nbsp;4</a>) is <span class="math inline">\(n^{-1} \mathbf{1}_{n \times 1} \mathbf{1}_{n \times 1}^\intercal\)</span> applied to an input matrix, <span class="math inline">\(X\)</span>:<br>
<span class="math display">\[
\begin{align*}
n^{-1} \mathbf{1}_{n \times 1} \mathbf{1}_{n \times 1}^\intercal X_{n \times 2} &amp;= \left[
\begin{matrix}
    \frac{1}{n}   &amp; \frac{1}{n}   &amp; \cdots &amp; \frac{1}{n}\\
    \frac{1}{n}   &amp; \frac{1}{n}   &amp; \cdots &amp; \frac{1}{n}\\
    \vdots   &amp; \vdots   &amp; \cdots &amp; \frac{1}{n}\\
    \frac{1}{n}   &amp; \frac{1}{n}   &amp; \cdots &amp; \frac{1}{n}
\end{matrix}
\right]_{n \times n}
\left[
\begin{matrix}
    x_1   &amp; y_1   \\
    x_2   &amp; y_2   \\
    \vdots   &amp; \vdots   \\
    x_n   &amp; y_n   \\
\end{matrix}
\right]_{n \times 2} \\
&amp;= \left[
\begin{matrix}
    \sum_{i=1}^n \frac{x_i}{n}   &amp; \sum_{i=1}^n \frac{y_i}{n}   \\
    \sum_{i=1}^n \frac{x_i}{n}   &amp; \sum_{i=1}^n \frac{y_i}{n}  \\
    \vdots   &amp; \vdots   \\
    \sum_{i=1}^n \frac{x_i}{n}   &amp; \sum_{i=1}^n \frac{y_i}{n}   \\
\end{matrix}
\right]_{n \times 2}  \\
&amp;= \left[
\begin{matrix}
    \bar{\mathbf{x}}   &amp; \bar{\mathbf{y}}   \\
    \bar{\mathbf{x}}   &amp; \bar{\mathbf{y}}   \\
    \vdots   &amp; \vdots   \\
    \bar{\mathbf{x}}   &amp; \bar{\mathbf{y}}   \\
\end{matrix}
\right]_{n \times 2}
\end{align*}
\]</span></p>
<p>Finally, we’ll use our “matrix of means” to yield the original matrix of interest used in (<a href="#eq-cov-mat" class="quarto-xref">Equation&nbsp;3</a>), where each element is the deviation from its column mean:</p>
<p><span class="math display">\[
\begin{align*}
\left[
\begin{matrix}
x_1 - \bar{\mathbf{x}}   &amp; y_1 - \bar{\mathbf{y}}   \\
    x_2 - \bar{\mathbf{x}}   &amp; y_2 - \bar{\mathbf{y}}   \\
    \vdots   &amp; \vdots   \\
    x_n - \bar{\mathbf{x}}   &amp; y_n - \bar{\mathbf{y}}   \\
\end{matrix}
\right]_{n \times 2} &amp;=
\left[
\begin{matrix}
    x_1   &amp; y_1   \\
    x_2   &amp; y_2   \\
    \vdots   &amp; \vdots   \\
    x_n   &amp; y_n   \\
\end{matrix}
\right]_{n \times 2} -
\left[
\begin{matrix}
    \bar{\mathbf{x}}   &amp; \bar{\mathbf{y}}   \\
    \bar{\mathbf{x}}   &amp; \bar{\mathbf{y}}   \\
    \vdots   &amp; \vdots   \\
    \bar{\mathbf{x}}   &amp; \bar{\mathbf{y}}   \\
\end{matrix}
\right]_{n \times 2}  \\
&amp;= X_{n \times m} -  n^{-1} \mathbf{1}_{n \times 1} \mathbf{1}_{n \times 1}^\intercal X_{n \times m} \\
&amp;=  (I_{n \times n} -  n^{-1} \mathbf{1}_{n \times 1} \mathbf{1}_{n \times 1}^\intercal ) X_{n \times m}
\end{align*}
\]</span> (<em>note the <a href="https://en.wikipedia.org/wiki/Identity_matrix">identity matrix, <span class="math inline">\(I\)</span></a>, which, in matrix multiplication, acts like a <span class="math inline">\(1\)</span> would in scalar multiplication</em>)</p>
<p>At this point, we will discard some of the dimension information about the matrices, which I’ve previously been using as guardrails, and simplify notation as follows: <span class="math display">\[
\begin{align*}
  &amp;= (I -  n^{-1} \mathbf{1}_{n} \mathbf{1}_{n}^\intercal ) X
\end{align*}
\]</span></p>
<p>This yields the function for mean centering the matrix, commonly referred to as the <a href="https://en.wikipedia.org/wiki/Centering_matrix">centering matrix</a>:<br>
<span class="math display">\[
T_{\text{center}}: \mathbb{R}^n \rightarrow \mathbb{R}^n \quad \text{defined by} \quad T(X) = (I -  n^{-1} \mathbf{1}_{n} \mathbf{1}_{n}^\intercal ) X
\]</span></p>
<p>In code:</p>
<div id="cell-37" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> T_center(X: np.array) <span class="op">-&gt;</span> np.array:</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(X)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (np.identity(n) <span class="op">-</span> (<span class="dv">1</span><span class="op">/</span>n)<span class="op">*</span>np.ones(shape<span class="op">=</span>(n, n))) <span class="op">@</span> X</span></code></pre></div>
</div>
</section>
</section>
<section id="a-note-on-broadcasting-and-numerical-methods" class="level3">
<h3 class="anchored" data-anchor-id="a-note-on-broadcasting-and-numerical-methods">A note on broadcasting and numerical methods</h3>
<p><code>numpy</code> and <code>pandas</code> support some invalid linear algebra operations, such as matrix addition/subtraction between different sized matrices (these packages use a method called <a href="https://numpy.org/doc/stable/user/basics.broadcasting.html">broadcasting</a> to make the operations valid):</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption>Broadcasting a times b</figcaption>
<p><img src="broadcasting_1.png" class="img-fluid figure-img"></p>
</figure>
</div>
<p>This makes the sort of centering operation we just covered in depth incredibly simple:</p>
<div id="cell-41" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>X <span class="op">-</span> X.mean()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">population</th>
<th data-quarto-table-cell-role="th">householdsize</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0.142</td>
<td>-0.116</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>-0.048</td>
<td>-0.286</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>-0.048</td>
<td>-0.026</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>-0.008</td>
<td>0.324</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>-0.038</td>
<td>0.104</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>We can confirm that our function produced that same centered matrix:</p>
<div id="cell-43" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>T_center(X)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">population</th>
<th data-quarto-table-cell-role="th">householdsize</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0.142</td>
<td>-0.116</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>-0.048</td>
<td>-0.286</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>-0.048</td>
<td>-0.026</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>-0.008</td>
<td>0.324</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>-0.038</td>
<td>0.104</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>At this point we will return to the matrix equation for covariance, (<a href="#eq-cov-mat" class="quarto-xref">Equation&nbsp;3</a>) that we defined earlier: <span class="math display">\[
\begin{align*}
C = (n-1)^{-1} \left[
\begin{matrix}
x_1 - \bar{\mathbf{x}}   &amp; y_1 - \bar{\mathbf{y}}   \\
    x_2 - \bar{\mathbf{x}}   &amp; y_2 - \bar{\mathbf{y}}   \\
    \vdots   &amp; \vdots   \\
    x_n - \bar{\mathbf{x}}   &amp; y_n - \bar{\mathbf{y}}   \\
\end{matrix}
\right]_{n \times 2}^\intercal
\left[
\begin{matrix}
x_1 - \bar{\mathbf{x}}   &amp; y_1 - \bar{\mathbf{y}}   \\
    x_2 - \bar{\mathbf{x}}   &amp; y_2 - \bar{\mathbf{y}}   \\
    \vdots   &amp; \vdots   \\
    x_n - \bar{\mathbf{x}}   &amp; y_n - \bar{\mathbf{y}}   \\
\end{matrix}
\right]_{n \times 2}
\end{align*}
\]</span></p>
<p>We’ll now express it formally.</p>
</section>
</section>
<section id="the-matrix-formulation" class="level2">
<h2 class="anchored" data-anchor-id="the-matrix-formulation">The matrix formulation</h2>
<p>Covariance is fairly simple to write out once you have the centering matrix, <span class="math inline">\(T_{\text{center}}\)</span>. Our equation is as follows:</p>
<p><span class="math display">\[
\begin{align*}
C &amp;= (n - 1)^{-1} T_{\text{center}}(X)^\intercal T_{\text{center}}(X)  \\
&amp;= (n - 1)^{-1}\left[ (I -  n^{-1} \mathbf{1}_{n} \mathbf{1}_{n}^\intercal ) X \right]^\intercal \left[ (I -  n^{-1} \mathbf{1}_{n} \mathbf{1}_{n}^\intercal ) X \right]
\end{align*}
\]</span> This is pretty verbose, and it’s common in textbooks to see some sort of abbreviated version, like the following, <span id="eq-cov"><span class="math display">\[
\begin{align*}
C = (n - 1)^{-1} X_c^\intercal X_c \\
\text{where }X_c = (I -  n^{-1} \mathbf{1}_{n} \mathbf{1}_{n}^\intercal ) X
\end{align*}
\tag{6}\]</span></span></p>
<p><span class="citation" data-cites="cohen_practical_2022">(<a href="#ref-cohen_practical_2022" role="doc-biblioref">Cohen 2022, chap. 7</a>)</span></p>
<div id="cell-47" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> covariance_matrix(X: np.array) <span class="op">-&gt;</span> np.array:</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(X)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Center matrix</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    X_c <span class="op">=</span> T_center(X)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute covariance</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">1</span><span class="op">/</span>(n<span class="op">-</span><span class="dv">1</span>) <span class="op">*</span> X_c.T <span class="op">@</span> X_c</span></code></pre></div>
</div>
<section id="applying-it-to-data" class="level3">
<h3 class="anchored" data-anchor-id="applying-it-to-data">Applying it to data</h3>
<p>We’ll test this formula out with our data:</p>
<div id="cell-50" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>X</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">population</th>
<th data-quarto-table-cell-role="th">householdsize</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0.19</td>
<td>0.33</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0.00</td>
<td>0.16</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0.00</td>
<td>0.42</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0.04</td>
<td>0.77</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0.01</td>
<td>0.55</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>First we’ll define the centered matrix, <span class="math inline">\(X_c = (I -  n^{-1} \mathbf{1}_{n} \mathbf{1}_{n}^\intercal ) X\)</span>:</p>
<div id="cell-52" class="cell" data-execution_count="18">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>C, X_c <span class="op">=</span> sp.symbols(<span class="st">"C X_c"</span>)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>exp <span class="op">=</span> (sp.UnevaluatedExpr(sp.Matrix(np.identity(n).astype(<span class="bu">int</span>))) <span class="op">-</span> sp.UnevaluatedExpr(<span class="dv">1</span><span class="op">/</span>n) <span class="op">*</span> sp.UnevaluatedExpr(sp.Matrix(np.ones(shape<span class="op">=</span>(n, <span class="dv">1</span>)) <span class="op">@</span> np.ones(shape<span class="op">=</span>(n, <span class="dv">1</span>)).T))) <span class="op">*</span> sp.UnevaluatedExpr(sp.Matrix(X))</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>exp_output <span class="op">=</span> (sp.Matrix(</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    np.<span class="bu">round</span>((np.identity(n) <span class="op">-</span> (<span class="dv">1</span><span class="op">/</span>n) <span class="op">*</span> np.ones(shape<span class="op">=</span>(n, <span class="dv">1</span>)) <span class="op">@</span> np.ones(shape<span class="op">=</span>(n, <span class="dv">1</span>)).T) <span class="op">@</span> X, <span class="dv">3</span>)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>sp.Eq(X_c, exp)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display cell-output-markdown" data-execution_count="18">
<p><span class="math inline">\(\displaystyle X_{c} = \left(- 0.2 \left[\begin{matrix}1.0 &amp; 1.0 &amp; 1.0 &amp; 1.0 &amp; 1.0\\1.0 &amp; 1.0 &amp; 1.0 &amp; 1.0 &amp; 1.0\\1.0 &amp; 1.0 &amp; 1.0 &amp; 1.0 &amp; 1.0\\1.0 &amp; 1.0 &amp; 1.0 &amp; 1.0 &amp; 1.0\\1.0 &amp; 1.0 &amp; 1.0 &amp; 1.0 &amp; 1.0\end{matrix}\right] + \left[\begin{matrix}1 &amp; 0 &amp; 0 &amp; 0 &amp; 0\\0 &amp; 1 &amp; 0 &amp; 0 &amp; 0\\0 &amp; 0 &amp; 1 &amp; 0 &amp; 0\\0 &amp; 0 &amp; 0 &amp; 1 &amp; 0\\0 &amp; 0 &amp; 0 &amp; 0 &amp; 1\end{matrix}\right]\right) \left[\begin{matrix}0.19 &amp; 0.33\\0 &amp; 0.16\\0 &amp; 0.42\\0.04 &amp; 0.77\\0.01 &amp; 0.55\end{matrix}\right]\)</span></p>
</div>
</div>
<p>Which evaluates to:</p>
<div id="cell-54" class="cell" data-execution_count="19">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>sp.Eq(X_c, sp.UnevaluatedExpr(exp_output))</span></code></pre></div>
</details>
<div class="cell-output cell-output-display cell-output-markdown" data-execution_count="19">
<p><span class="math inline">\(\displaystyle X_{c} = \left[\begin{matrix}0.142 &amp; -0.116\\-0.048 &amp; -0.286\\-0.048 &amp; -0.026\\-0.008 &amp; 0.324\\-0.038 &amp; 0.104\end{matrix}\right]\)</span></p>
</div>
</div>
<p>And now the main equation: <span class="math display">\[
C = (n - 1)^{-1} X_c^\intercal X_c
\]</span></p>
<div id="cell-56" class="cell" data-execution_count="20">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>out <span class="op">=</span> (</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    sp.UnevaluatedExpr(exp_output.T) <span class="op">*</span> sp.UnevaluatedExpr(exp_output.evalf())</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span> <span class="dv">1</span> <span class="op">/</span> (sp.UnevaluatedExpr(<span class="bu">len</span>(x)) <span class="op">-</span> sp.UnevaluatedExpr(<span class="dv">1</span>))</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>sp.Eq(C, out)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display cell-output-markdown" data-execution_count="20">
<p><span class="math inline">\(\displaystyle C = \left[\begin{matrix}0.142 &amp; -0.048 &amp; -0.048 &amp; -0.008 &amp; -0.038\\-0.116 &amp; -0.286 &amp; -0.026 &amp; 0.324 &amp; 0.104\end{matrix}\right] \left[\begin{matrix}0.142 &amp; -0.116\\-0.048 &amp; -0.286\\-0.048 &amp; -0.026\\-0.008 &amp; 0.324\\-0.038 &amp; 0.104\end{matrix}\right] \left(- 1 + 5\right)^{-1}\)</span></p>
</div>
</div>
<p>Already it should become apparent that this multiplication will be a sequential application of the vector formula for covariance. We can make that abundantly clear by visualizing the multiplication result:</p>
<div id="cell-58" class="cell" data-execution_count="21">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>out <span class="op">=</span> sp.Matrix([[sp.UnevaluatedExpr(sp.Matrix(x<span class="op">-</span>x.mean()).T) <span class="op">*</span> sp.UnevaluatedExpr(sp.Matrix(x<span class="op">-</span>x.mean()))</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>                  <span class="op">*</span> <span class="dv">1</span> <span class="op">/</span> (sp.UnevaluatedExpr(<span class="bu">len</span>(x)) <span class="op">-</span> sp.UnevaluatedExpr(<span class="dv">1</span>)),</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>                  sp.UnevaluatedExpr(sp.Matrix(x<span class="op">-</span>x.mean()).T) <span class="op">*</span> sp.UnevaluatedExpr(sp.Matrix(y<span class="op">-</span>y.mean()))</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>                  <span class="op">*</span> <span class="dv">1</span> <span class="op">/</span> (sp.UnevaluatedExpr(<span class="bu">len</span>(x)) <span class="op">-</span> sp.UnevaluatedExpr(<span class="dv">1</span>))],</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>                  [sp.UnevaluatedExpr(sp.Matrix(y<span class="op">-</span>y.mean()).T) <span class="op">*</span> sp.UnevaluatedExpr(sp.Matrix(x<span class="op">-</span>x.mean()))</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>                   <span class="op">*</span> <span class="dv">1</span> <span class="op">/</span> (sp.UnevaluatedExpr(<span class="bu">len</span>(x)) <span class="op">-</span> sp.UnevaluatedExpr(<span class="dv">1</span>)),</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>                   sp.UnevaluatedExpr(sp.Matrix(y<span class="op">-</span>y.mean()).T) <span class="op">*</span> sp.UnevaluatedExpr(sp.Matrix(y<span class="op">-</span>y.mean()))</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>                   <span class="op">*</span> <span class="dv">1</span> <span class="op">/</span> (sp.UnevaluatedExpr(<span class="bu">len</span>(x)) <span class="op">-</span> sp.UnevaluatedExpr(<span class="dv">1</span>))]</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>                   ])</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>out</span></code></pre></div>
</details>
<div class="cell-output cell-output-display cell-output-markdown" data-execution_count="21">
<p><span class="math inline">\(\displaystyle \left[\begin{matrix}\left[\begin{matrix}0.142 &amp; -0.048 &amp; -0.048 &amp; -0.008 &amp; -0.038\end{matrix}\right] \left[\begin{matrix}0.142\\-0.048\\-0.048\\-0.008\\-0.038\end{matrix}\right] \left(- 1 + 5\right)^{-1} &amp; \left[\begin{matrix}0.142 &amp; -0.048 &amp; -0.048 &amp; -0.008 &amp; -0.038\end{matrix}\right] \left[\begin{matrix}-0.116\\-0.286\\-0.026\\0.324\\0.104\end{matrix}\right] \left(- 1 + 5\right)^{-1}\\\left[\begin{matrix}-0.116 &amp; -0.286 &amp; -0.026 &amp; 0.324 &amp; 0.104\end{matrix}\right] \left[\begin{matrix}0.142\\-0.048\\-0.048\\-0.008\\-0.038\end{matrix}\right] \left(- 1 + 5\right)^{-1} &amp; \left[\begin{matrix}-0.116 &amp; -0.286 &amp; -0.026 &amp; 0.324 &amp; 0.104\end{matrix}\right] \left[\begin{matrix}-0.116\\-0.286\\-0.026\\0.324\\0.104\end{matrix}\right] \left(- 1 + 5\right)^{-1}\end{matrix}\right]\)</span></p>
</div>
</div>
<p>The result:</p>
<div id="cell-60" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>covariance_matrix(X.values)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>array([[ 0.00657, -0.00201],
       [-0.00201,  0.05293]])</code></pre>
</div>
</div>
<p>For a sanity check, we can compare our results with those in <code>numpy</code> and <code>pandas</code>.</p>
<p><code>numpy</code> results:</p>
<div id="cell-63" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>np.cov(x, y)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>array([[ 0.00657, -0.00201],
       [-0.00201,  0.05293]])</code></pre>
</div>
</div>
<p><code>pandas</code> results:</p>
<div id="cell-65" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>X.cov()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">population</th>
<th data-quarto-table-cell-role="th">householdsize</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">population</td>
<td>0.00657</td>
<td>-0.00201</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">householdsize</td>
<td>-0.00201</td>
<td>0.05293</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<section id="visualizing-the-covariance-matrix" class="level4">
<h4 class="anchored" data-anchor-id="visualizing-the-covariance-matrix">Visualizing the Covariance Matrix</h4>
<p>We’ll now return to our original, full dataset from the very start of the exercise.</p>
<div id="cell-67" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>df_num.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>(1994, 99)</code></pre>
</div>
</div>
<p>and we’ll compute the covariance matrix across al 99 features.</p>
<div id="cell-69" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>cov_matrix <span class="op">=</span> covariance_matrix(df_num)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>cov_matrix.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>(99, 99)</code></pre>
</div>
</div>
<p>Looking at a <span class="math inline">\(99 \times 99\)</span> matrix is not particularly useful, so it’s common to use heatmaps to visualize matrices that show association between many variables.</p>
<div id="cell-71" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>plt.imshow(cov_matrix.values)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>plt.colorbar()<span class="op">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-28-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>While this looks cool, I view it as more or less useless as a tool for doing any sort of exploration.</p>
<p>The covariances between variables are highly <a href="https://en.wikipedia.org/wiki/Covariance_and_correlation#:~:text=Notably%2C%20correlation%20is%20dimensionless%20while%20covariance%20is%20in%20units%20obtained%20by%20multiplying%20the%20units%20of%20the%20two%20variables.">influenced by the scale of the original variables</a>. This matrix visualization be much more useful if we convert it into a <strong>correlation matrix</strong>, <span class="math inline">\(R\)</span>, wherein the measures of association, <span class="math inline">\(\rho_{i,j}\)</span> are all normalized, <span class="math inline">\(\rho_{i,j} \in [-1, 1]\)</span>. This in effect adjusts our measures for scale and allows us to actually see which variables are the most associated.</p>
<p>I’ll cover that matrix in a coming blog post…</p>



</section>
</section>
</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-cohen_practical_2022" class="csl-entry" role="listitem">
Cohen, Mike. 2022. <em>Practical <span>Linear</span> <span>Algebra</span> for <span>Data</span> <span>Science</span>: <span>From</span> <span>Core</span> <span>Concepts</span> to <span>Applications</span> <span>Using</span> <span>Python</span></em>. 1st edition. Beijing: O’Reilly Media.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/peter-amerkhanian\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
          // target, if specified
          link.setAttribute("target", "_blank");
          if (link.getAttribute("rel") === null) {
            link.setAttribute("rel", "noopener");
          }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>Copyright 2024, Peter Amerkhanian</p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>