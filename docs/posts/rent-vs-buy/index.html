<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Peter Amerkhanian">
<meta name="dcterms.date" content="2022-08-06">
<meta name="description" content="Using numpy-financial and monte-carlo simulation to evaluate investments.">

<title>Buy vs.&nbsp;Rent, A Financial Modeling Workflow in Python – Peter Amerkhanian</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../profile_backup.jpg" rel="icon" type="image/jpeg">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-1092c56c6cadf2eb47b1bc8063ab382a.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-5d17cd34d2e348db00e20f83fc65b062.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-V95HGLKTEB"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-V95HGLKTEB', { 'anonymize_ip': true});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<meta name="quarto:status" content="draft">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner"><div id="quarto-draft-alert" class="alert alert-warning"><i class="bi bi-pencil-square"></i>Draft</div>
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../profile_backup.jpg" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Home</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../projects.html"> 
<span class="menu-text">Projects</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Buy vs.&nbsp;Rent, A Financial Modeling Workflow in Python</h1>
                  <div>
        <div class="description">
          Using <code>numpy-financial</code> and monte-carlo simulation to evaluate investments.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">Python</div>
                <div class="quarto-category">Probability</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Peter Amerkhanian </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">August 6, 2022</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
        <h2 id="toc-title"><a href="#" class="nav-link">Buy vs.&nbsp;Rent, A Financial Modeling Workflow in Python</a></h2>
     
    <ul>
    <li><a href="#summary" id="toc-summary" class="nav-link active" data-scroll-target="#summary">Summary</a>
    <ul class="collapse">
    <li><a href="#a-note-on-numpy-financial" id="toc-a-note-on-numpy-financial" class="nav-link" data-scroll-target="#a-note-on-numpy-financial">A Note on <code>numpy-financial</code></a></li>
    <li><a href="#environmentpackages" id="toc-environmentpackages" class="nav-link" data-scroll-target="#environmentpackages">Environment/Packages</a></li>
    </ul></li>
    <li><a href="#problem-setup" id="toc-problem-setup" class="nav-link" data-scroll-target="#problem-setup">Problem Setup</a>
    <ul class="collapse">
    <li><a href="#definining-constants" id="toc-definining-constants" class="nav-link" data-scroll-target="#definining-constants">Definining Constants</a></li>
    <li><a href="#defining-random-variables" id="toc-defining-random-variables" class="nav-link" data-scroll-target="#defining-random-variables">Defining Random Variables</a></li>
    </ul></li>
    <li><a href="#scenarios" id="toc-scenarios" class="nav-link" data-scroll-target="#scenarios">Scenarios</a>
    <ul class="collapse">
    <li><a href="#ownership-table" id="toc-ownership-table" class="nav-link" data-scroll-target="#ownership-table">Ownership Table</a></li>
    <li><a href="#rental-table" id="toc-rental-table" class="nav-link" data-scroll-target="#rental-table">Rental Table</a></li>
    </ul></li>
    <li><a href="#results" id="toc-results" class="nav-link" data-scroll-target="#results">Results</a></li>
    </ul>
    <div class="quarto-alternate-formats">
    <ul><li>
    <a id="github" href="#" target="_blank"><i class="bi bi-github"></i>Source Code</a>
  </li></ul>
</div>

  </nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">






<script>
  var githubLink = document.getElementById("github");
  var currentPath = window.location.pathname;
  githubLink.href = "https://github.com/peter-amerkhanian/peter-amerkhanian.github.io/blob/master" + currentPath;
  document.getElementById('toc-title').addEventListener('click', function(event) {
  event.preventDefault(); // Prevent default behavior of anchor tag
  const firstHeader = document.querySelector('body'); // Select the first h2 element
  if (firstHeader) {
    firstHeader.scrollIntoView({ behavior: 'smooth', block: "start", inline: "nearest"}); // Scroll to the first header smoothly
  }
});


</script>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>This post goes through the following exercises:</p>
<ul>
<li>Use <code>numpy-financial</code> to build a <a href="https://en.wikipedia.org/wiki/Amortization_calculator">loan amortization calculator</a> for a home mortgage<br>
</li>
<li>Use said table as well as simulated home and stock equity returns over time to compare year-to-year wealth resulting from the following strategies:
<ol type="1">
<li>buying a residential living space<br>
</li>
<li>renting one instead and investing the dollar amount that would have been your down-payment</li>
</ol></li>
</ul>
<section id="a-note-on-numpy-financial" class="level3">
<h3 class="anchored" data-anchor-id="a-note-on-numpy-financial">A Note on <code>numpy-financial</code></h3>
<p>At one point in time, <code>numpy</code>, the popular Python numerical analysis library, included 10 specialized functions for financial analysis. Given their specific nature, they were eventually removed from <code>numpy</code>, I think in 2019 (<a href="https://numpy.org/neps/nep-0032-remove-financial-functions.html">learn about why that is here</a>) and are now available in the separate library, <code>numpy-financial</code>. The library still seems focused on the same <a href="https://numpy.org/numpy-financial/latest/">10 core functions</a>, which handle tasks like calculating loan payment amounts given some inputs, and applied financial economics tasks like calculating time value of money. Cool… Anyways, I’ll use it to create an amortization schedule for a mortgage.</p>
</section>
<section id="environmentpackages" class="level3">
<h3 class="anchored" data-anchor-id="environmentpackages">Environment/Packages</h3>
<p>I built this notebook in a Google Colab instance, which seems to include most major Python libraries (<a href="https://stackoverflow.com/questions/47109539/what-are-the-available-libraries-within-google-colaboratory">more info</a>).</p>
<p>You’ll probably have to download <code>numpy-financial</code> (it’s not included in Anaconda as far as I know), which you can accomplish within any notebook-like environment using the following command:</p>
<div id="d3f1860b" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> pip install numpy<span class="op">-</span>financial</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>^C</code></pre>
</div>
</div>
<p>You’ll want to load the usual suspects - <code>pandas</code>, <code>numpy</code>, <code>seaborn</code>, <code>matplotlib</code>. I also run <code>from datetime import datetime</code> since we will be working with ranges of dates, and I run <code>sns.set_style()</code> to get my seaborn plots looking a bit more aesthetically pleasing - read more on themes <a href="https://seaborn.pydata.org/generated/seaborn.set_theme.html#seaborn.set_theme">here</a>.</p>
<div id="53acff51" class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy_financial <span class="im">as</span> npf</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span></code></pre></div>
</div>
</section>
</section>
<section id="problem-setup" class="level2">
<h2 class="anchored" data-anchor-id="problem-setup">Problem Setup</h2>
<section id="definining-constants" class="level3">
<h3 class="anchored" data-anchor-id="definining-constants">Definining Constants</h3>
<p>I’ll run this as a comparison between buying an apartment that costs $<b></b>700,000 with a 20% downpayment, versus renting a home for $2,600 a month. This is meant to approximate buying versus renting a two-bed one-bath apartment.</p>
<p>Buying fees are defined at 4%, the homeowners association fees are defined as $700 monthly.</p>
<div id="6ce4bf03" class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Buying Constants</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>interest_rate <span class="op">=</span> <span class="fl">0.065</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>cost <span class="op">=</span> <span class="dv">700000</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>hoa <span class="op">=</span> <span class="dv">700</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>down_payment <span class="op">=</span> cost <span class="op">*</span> <span class="fl">.2</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>principal <span class="op">=</span> cost <span class="op">-</span> down_payment</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>buying_fees <span class="op">=</span> principal<span class="op">*</span><span class="fl">.04</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Renting Constants</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>rent <span class="op">=</span> <span class="dv">2600</span></span></code></pre></div>
</div>
<p><code>npf.pmt()</code> can be used to generate a monthly mortgage payment given those buying constants:</p>
<div id="831397a1" class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>npf.pmt(interest_rate<span class="op">/</span><span class="dv">12</span>, <span class="dv">12</span><span class="op">*</span><span class="dv">30</span>, principal)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>-3539.580931560606</code></pre>
</div>
</div>
<p>alternatively, we can use <code>npf.ppt()</code> to see how much of the payment goes towards the principal, and use <code>npf.ipmt()</code> to see how much goes towards interest (see below for applications of those functions).</p>
</section>
<section id="defining-random-variables" class="level3">
<h3 class="anchored" data-anchor-id="defining-random-variables">Defining Random Variables</h3>
<p>I’ll make the simplifying assumption that both “annual home appreciation” and “annual stock appreciation” are generated from normal distributions. This is a kind of strong assumption, but one that seems to be routinely made at least with regards to stock market returns, even if there might be better distribution choices out there (<a href="https://arxiv.org/ftp/arxiv/papers/1906/1906.10325.pdf">more here</a>).</p>
<p>Here’s a look at how we’ll draw from a normal distribution. Given an average annual return, <span class="math inline">\(\mu = 0.0572\)</span> (<span class="math inline">\(\mu\)</span>, or, mu, is a common variable name for average) and a standard deviation <span class="math inline">\(\sigma = 0.1042\)</span> (<span class="math inline">\(\sigma\)</span>, or, sigma, is the common variable name for standard deviation), we can draw one sample from a normal distribution as follows:</p>
<div id="79f781cf" class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>load_dotenv()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>True</code></pre>
</div>
</div>
<div id="b7398231" class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> yfinance <span class="im">as</span> yf</span></code></pre></div>
</div>
<div id="ca040854" class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Download S&amp;P 500 data</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>sp500 <span class="op">=</span> yf.download(<span class="st">"AAPL"</span>, start<span class="op">=</span><span class="st">"1950-01-01"</span>)[<span class="st">"Adj Close"</span>].dropna()</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>sp500 <span class="op">=</span> sp500.dropna()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[*********************100%***********************]  1 of 1 completed</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>ERROR 
1 Failed download:
ERROR ['AAPL']: Exception('AAPL: No price data found, symbol may be delisted (1d 1950-01-01 -&gt; 2025-05-31)')</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code></code></pre>
</div>
</div>
<div id="197e00b4" class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fredapi <span class="im">import</span> Fred</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>fred <span class="op">=</span> Fred(api_key<span class="op">=</span>os.environ.get(<span class="st">'fred_api'</span>))</span></code></pre></div>
</div>
<div id="18c1a052" class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>sf_home <span class="op">=</span> fred.get_series(<span class="st">'SFXRSA'</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>sf_home <span class="op">=</span> sf_home.dropna()</span></code></pre></div>
</div>
<div id="d1012585" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>sf_home.plot()</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-11-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="adfa73a6" class="cell" data-execution_count="80">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>log_prices <span class="op">=</span> np.log(sf_home)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>log_prices.plot()</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-12-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="a09c8c3b" class="cell" data-execution_count="81">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsmodels.tsa.seasonal <span class="im">import</span> STL</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="co"># -- STL DECOMPOSITION --</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>stl <span class="op">=</span> STL(log_prices, period<span class="op">=</span><span class="dv">36</span>)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> stl.fit()</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>trend <span class="op">=</span> res.trend</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>resid <span class="op">=</span> res.resid</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="co"># === 1. Plot log prices with trend ===</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>plt.figure()</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>plt.plot(log_prices, label<span class="op">=</span><span class="st">'Log(Index)'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>plt.plot(trend, label<span class="op">=</span><span class="st">'STL Trend'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Log-transformed SF Housing Index with STL Trend'</span>)</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-13-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="3ca37ed6" class="cell" data-execution_count="82">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === 2. Residual diagnostics ===</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>plt.figure()</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>plt.plot(resid, label<span class="op">=</span><span class="st">'STL Residuals'</span>, color<span class="op">=</span><span class="st">'orange'</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>plt.axhline(<span class="dv">0</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, color<span class="op">=</span><span class="st">'gray'</span>)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'STL Residuals (Detrended Log Prices)'</span>)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-14-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="57dbaa36" class="cell" data-execution_count="83">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LinearRegression</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> timedelta</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>future_months <span class="op">=</span> <span class="dv">120</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>block_size <span class="op">=</span> <span class="dv">12</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>n_simulations <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>N_years <span class="op">=</span> <span class="dv">10</span></span></code></pre></div>
</div>
<div id="7c0056c9" class="cell" data-execution_count="84">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === 3. Fit linear model to trend (last N years) ===</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>trend_recent <span class="op">=</span> trend.last(<span class="ss">f'</span><span class="sc">{</span>N_years<span class="sc">}</span><span class="ss">Y'</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> np.arange(<span class="bu">len</span>(trend_recent)).reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> trend_recent.values</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> LinearRegression().fit(X, y)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>X_future <span class="op">=</span> np.arange(<span class="bu">len</span>(X), <span class="bu">len</span>(X) <span class="op">+</span> future_months).reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>trend_forecast <span class="op">=</span> model.predict(X_future)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>C:\Users\peteramerkhanian\AppData\Local\Temp\ipykernel_66512\1996583068.py:2: FutureWarning: last is deprecated and will be removed in a future version. Please create a mask and filter using `.loc` instead
  trend_recent = trend.last(f'{N_years}Y')
C:\Users\peteramerkhanian\AppData\Local\Temp\ipykernel_66512\1996583068.py:2: FutureWarning: 'Y' is deprecated and will be removed in a future version, please use 'YE' instead.
  trend_recent = trend.last(f'{N_years}Y')</code></pre>
</div>
</div>
<div id="7049af9d" class="cell" data-execution_count="85">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot extrapolated trend</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>plt.figure()</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>plt.plot(trend, label<span class="op">=</span><span class="st">'Observed Trend'</span>)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>plt.plot(</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    pd.date_range(trend.index[<span class="op">-</span><span class="dv">1</span>] <span class="op">+</span> timedelta(days<span class="op">=</span><span class="dv">30</span>), periods<span class="op">=</span>future_months, freq<span class="op">=</span><span class="st">'MS'</span>),</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    trend_forecast,</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">'red'</span>, label<span class="op">=</span><span class="st">'Forecasted Trend'</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'STL Trend + Linear Extrapolation'</span>)</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-17-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="3e3cd870" class="cell" data-execution_count="97">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === 4. Show example of block bootstrapped residuals ===</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> block_bootstrap(residuals, n_periods, block_size<span class="op">=</span><span class="dv">4</span>):</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    blocks <span class="op">=</span> []</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    n_blocks <span class="op">=</span> <span class="bu">int</span>(np.ceil(n_periods <span class="op">/</span> block_size))</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n_blocks):</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>        start <span class="op">=</span> np.random.randint(<span class="dv">0</span>, <span class="bu">len</span>(residuals) <span class="op">-</span> block_size)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>        blocks.extend(residuals[start:start <span class="op">+</span> block_size])</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.array(blocks[:n_periods])</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>sample_boot <span class="op">=</span> block_bootstrap(resid.dropna(), future_months, block_size)</span></code></pre></div>
</div>
<div id="60c3601d" class="cell" data-execution_count="98">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>plt.figure()</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>plt.plot(sample_boot, color<span class="op">=</span><span class="st">'purple'</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>plt.axhline(<span class="dv">0</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, color<span class="op">=</span><span class="st">'gray'</span>)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Example: Block Bootstrapped Residuals (Simulated Noise)'</span>)</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-19-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="c9315f9d" class="cell" data-execution_count="99">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot extrapolated trend</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>plt.figure()</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>plt.plot(trend, label<span class="op">=</span><span class="st">'Observed Trend'</span>)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>plt.plot(</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    pd.date_range(trend.index[<span class="op">-</span><span class="dv">1</span>] <span class="op">+</span> timedelta(days<span class="op">=</span><span class="dv">30</span>), periods<span class="op">=</span>future_months, freq<span class="op">=</span><span class="st">'MS'</span>),</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    (trend_forecast <span class="op">+</span> sample_boot),</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">'red'</span>, label<span class="op">=</span><span class="st">'Forecasted Trend'</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'STL Trend + Linear Extrapolation'</span>)</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-20-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="ace26978" class="cell" data-execution_count="91">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsmodels.tsa.regime_switching.markov_regression <span class="im">import</span> MarkovRegression</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Convert log prices to returns</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a> <span class="co"># insert your data here</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> np.diff(log_prices)  <span class="co"># log returns</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Fit Markov Switching model (e.g., 2 regimes, AR(1) in each)</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> MarkovRegression(returns, k_regimes<span class="op">=</span><span class="dv">2</span>, trend<span class="op">=</span><span class="st">'c'</span>, switching_variance<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> model.fit()</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Summary and regime probabilities</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(result.summary())</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Smoothed regime probabilities</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>smoothed_probs <span class="op">=</span> result.smoothed_marginal_probabilities</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>plt.plot(smoothed_probs)</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                        Markov Switching Model Results                        
==============================================================================
Dep. Variable:                      y   No. Observations:                  458
Model:               MarkovRegression   Log Likelihood                1485.238
Date:                Sat, 31 May 2025   AIC                          -2958.477
Time:                        12:27:11   BIC                          -2933.715
Sample:                             0   HQIC                         -2948.724
                                - 458                                         
Covariance Type:               approx                                         
                             Regime 0 parameters                              
==============================================================================
                 coef    std err          z      P&gt;|z|      [0.025      0.975]
------------------------------------------------------------------------------
const          0.0009      0.001      1.472      0.141      -0.000       0.002
sigma2      2.722e-05   3.31e-06      8.213      0.000    2.07e-05    3.37e-05
                             Regime 1 parameters                              
==============================================================================
                 coef    std err          z      P&gt;|z|      [0.025      0.975]
------------------------------------------------------------------------------
const          0.0082      0.001      7.744      0.000       0.006       0.010
sigma2         0.0002   2.52e-05      8.680      0.000       0.000       0.000
                         Regime transition parameters                         
==============================================================================
                 coef    std err          z      P&gt;|z|      [0.025      0.975]
------------------------------------------------------------------------------
p[0-&gt;0]        0.9607      0.014     68.720      0.000       0.933       0.988
p[1-&gt;0]        0.0410      0.016      2.640      0.008       0.011       0.071
==============================================================================

Warnings:
[1] Covariance matrix calculated using numerical (complex-step) differentiation.</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-21-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="df8e9cb1" class="cell" data-execution_count="71">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> r2_score, mean_squared_error, mean_absolute_error</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Define split point</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>split_date <span class="op">=</span> <span class="st">'2013-01-01'</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>log_prices_train <span class="op">=</span> log_prices[:split_date]</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>log_prices_test <span class="op">=</span> log_prices[split_date:]</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>n_test <span class="op">=</span> <span class="bu">len</span>(log_prices_test)</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. STL on training data</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>stl_train <span class="op">=</span> STL(log_prices_train, period<span class="op">=</span><span class="dv">12</span>).fit()</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>trend_train <span class="op">=</span> stl_train.trend</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>resid_train <span class="op">=</span> stl_train.resid.dropna()</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Extrapolate trend linearly from last N years of training trend</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>trend_recent <span class="op">=</span> trend_train.last(<span class="st">'10Y'</span>)</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> np.arange(<span class="bu">len</span>(trend_recent)).reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> trend_recent.values</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> LinearRegression().fit(X, y)</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>X_future <span class="op">=</span> np.arange(<span class="bu">len</span>(X), <span class="bu">len</span>(X) <span class="op">+</span> n_test).reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>trend_forecast <span class="op">=</span> model.predict(X_future)</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Bootstrap residuals and add to trend forecast</span></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>sim_resid_stl <span class="op">=</span> block_bootstrap(resid_train, n_test, block_size)</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>sim_log_stl <span class="op">=</span> trend_forecast <span class="op">+</span> sim_resid_stl</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>sim_prices_stl <span class="op">=</span> np.exp(sim_log_stl)</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Fit normal distribution to training log returns</span></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>log_returns_train <span class="op">=</span> log_prices_train.diff().dropna()</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>mu, sigma <span class="op">=</span> log_returns_train.mean(), log_returns_train.std()</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate log returns and add to final value of training log prices</span></span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>sim_log_returns_normal <span class="op">=</span> np.random.normal(mu, sigma, size<span class="op">=</span>n_test)</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>sim_log_normal <span class="op">=</span> [log_prices_train.iloc[<span class="op">-</span><span class="dv">1</span>]]</span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> r <span class="kw">in</span> sim_log_returns_normal:</span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>    sim_log_normal.append(sim_log_normal[<span class="op">-</span><span class="dv">1</span>] <span class="op">+</span> r)</span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>sim_log_normal <span class="op">=</span> sim_log_normal[<span class="dv">1</span>:]</span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a>sim_prices_normal <span class="op">=</span> np.exp(sim_log_normal)</span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. True test log prices</span></span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a>true_log_prices <span class="op">=</span> log_prices_test[:n_test]</span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Evaluation metrics</span></span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluate(pred, truth, label):</span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a>    r2 <span class="op">=</span> r2_score(truth, pred)</span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true" tabindex="-1"></a>    rmse <span class="op">=</span> mean_squared_error(truth, pred, squared<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true" tabindex="-1"></a>    mae <span class="op">=</span> mean_absolute_error(truth, pred)</span>
<span id="cb29-47"><a href="#cb29-47" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"📊 </span><span class="sc">{</span>label<span class="sc">}</span><span class="ss"> Forecast Performance"</span>)</span>
<span id="cb29-48"><a href="#cb29-48" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"R²:   </span><span class="sc">{</span>r2<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb29-49"><a href="#cb29-49" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"RMSE: </span><span class="sc">{</span>rmse<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb29-50"><a href="#cb29-50" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"MAE:  </span><span class="sc">{</span>mae<span class="sc">:.4f}</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb29-51"><a href="#cb29-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-52"><a href="#cb29-52" aria-hidden="true" tabindex="-1"></a>evaluate(sim_log_stl, true_log_prices, <span class="st">"STL + Bootstrap"</span>)</span>
<span id="cb29-53"><a href="#cb29-53" aria-hidden="true" tabindex="-1"></a>evaluate(sim_log_normal, true_log_prices, <span class="st">"Normal Sim"</span>)</span>
<span id="cb29-54"><a href="#cb29-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-55"><a href="#cb29-55" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. Plot for visual comparison</span></span>
<span id="cb29-56"><a href="#cb29-56" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">5</span>))</span>
<span id="cb29-57"><a href="#cb29-57" aria-hidden="true" tabindex="-1"></a>plt.plot(log_prices, label<span class="op">=</span><span class="st">'True Log Prices'</span>)</span>
<span id="cb29-58"><a href="#cb29-58" aria-hidden="true" tabindex="-1"></a>plt.plot(log_prices_test.index, sim_log_stl, label<span class="op">=</span><span class="st">'STL + Bootstrap Forecast'</span>, color<span class="op">=</span><span class="st">'red'</span>)</span>
<span id="cb29-59"><a href="#cb29-59" aria-hidden="true" tabindex="-1"></a>plt.plot(log_prices_test.index, sim_log_normal, label<span class="op">=</span><span class="st">'Normal Sim Forecast'</span>, color<span class="op">=</span><span class="st">'green'</span>)</span>
<span id="cb29-60"><a href="#cb29-60" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Comparison of Forecast Methods (Log Prices)'</span>)</span>
<span id="cb29-61"><a href="#cb29-61" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb29-62"><a href="#cb29-62" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb29-63"><a href="#cb29-63" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>C:\Users\peteramerkhanian\AppData\Local\Temp\ipykernel_66512\2205870326.py:15: FutureWarning: last is deprecated and will be removed in a future version. Please create a mask and filter using `.loc` instead
  trend_recent = trend_train.last('10Y')
C:\Users\peteramerkhanian\AppData\Local\Temp\ipykernel_66512\2205870326.py:15: FutureWarning: 'Y' is deprecated and will be removed in a future version, please use 'YE' instead.
  trend_recent = trend_train.last('10Y')</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>📊 STL + Bootstrap Forecast Performance
R²:   -22.5005
RMSE: 1.1821
MAE:  1.0954

📊 Normal Sim Forecast Performance
R²:   -1.2241
RMSE: 0.3636
MAE:  0.3324
</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-22-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="837fb1dd" class="cell" data-execution_count="75">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsmodels.tsa.regime_switching.markov_regression <span class="im">import</span> MarkovRegression</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Markov switching model with 2 regimes: mean &amp; variance change</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> MarkovRegression(log_prices_train, k_regimes<span class="op">=</span><span class="dv">2</span>, trend<span class="op">=</span><span class="st">'c'</span>, switching_variance<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> model.fit()</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Forecast future values (in-sample first)</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>fitted <span class="op">=</span> res.fittedvalues</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot in-sample fit</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">4</span>))</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>plt.plot(log_prices_train, label<span class="op">=</span><span class="st">'True Log Prices'</span>)</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>plt.plot(fitted, label<span class="op">=</span><span class="st">'Fitted (Markov)'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Markov Switching Model Fit"</span>)</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Show smoothed regime probabilities</span></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>res.smoothed_marginal_probabilities[<span class="dv">0</span>].plot(title<span class="op">=</span><span class="st">"Probability of Regime 0 (e.g. Boom)"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>c:\Users\peteramerkhanian\anaconda3\lib\site-packages\statsmodels\tsa\base\tsa_model.py:471: ValueWarning: No frequency information was provided, so inferred frequency MS will be used.
  self._init_dates(dates, freq)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-23-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-23-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="d7657ebe" class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> yfinance <span class="im">as</span> yf</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fredapi <span class="im">import</span> Fred</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize FRED API (you need to get your own API key from https://fred.stlouisfed.org/)</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>fred <span class="op">=</span> Fred(api_key<span class="op">=</span>os.environ.get(<span class="st">'fred_api'</span>))</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Download S&amp;P 500 data</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>sp500 <span class="op">=</span> yf.download(<span class="st">'^GSPC'</span>, start<span class="op">=</span><span class="st">'2000-01-01'</span>, interval<span class="op">=</span><span class="st">'1mo'</span>)[<span class="st">'Adj Close'</span>]</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>sp500 <span class="op">=</span> sp500.dropna()</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Download San Francisco Home Price Index data</span></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>sf_home <span class="op">=</span> fred.get_series(<span class="st">'SFXRSA'</span>)</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>sf_home <span class="op">=</span> sf_home.dropna()</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Align dates</span></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> pd.DataFrame({<span class="st">'SP500'</span>: sp500, <span class="st">'SF_Home'</span>: sf_home})</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> data.dropna()</span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate monthly returns</span></span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>returns <span class="op">=</span> data.pct_change().dropna()</span></code></pre></div>
</div>
<div id="07110a4a" class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set a random seed for stability of results</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">10</span>)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>mean <span class="op">=</span> <span class="fl">.0572</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>standard_deviation <span class="op">=</span> <span class="fl">.1042</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>samples <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Draw the sample</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>np.random.normal(mean, standard_deviation, samples)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<pre><code>array([0.19595131])</code></pre>
</div>
</div>
<p>We now simulate market returns for every month by supplying mean and standard deviation values for both home and stock market appreciation and drawing 360 samples (360 months in 30 years). For simplicity, we’ll just use world-wide aggregate values from <a href="https://www.frbsf.org/economic-research/wp-content/uploads/sites/4/wp2017-25.pdf">“The Rate of Return on Everything, 1870-2015”</a>.</p>
<div id="b3271725" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>mu_stock <span class="op">=</span> <span class="fl">.1081</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>sigma_stock <span class="op">=</span> <span class="fl">.2267</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>mu_home <span class="op">=</span> <span class="fl">.0572</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>sigma_home <span class="op">=</span> <span class="fl">.1042</span></span></code></pre></div>
</div>
<p>Given that stock and home appreciation is probably correlated, I’ll have ti sample from a bivariate normal distribution using <code>numpy.random.Generator.multivariate_normal</code> - documentation <a href="https://numpy.org/doc/stable/reference/random/generated/numpy.random.Generator.multivariate_normal.html">here</a>, rather than the univariate distribution draw shown above. I am going to assume a correlation coefficient, <span class="math inline">\(\rho_{stock,home}\)</span> of 0.5 - a fairly clear correlation.<br>
In order to use that numpy function, I’ll need to translate my correlation statistic into a covariance statistic, and I’ll use the following formula (<a href="https://en.wikipedia.org/wiki/Correlation">source</a>):<br>
<span class="math display">\[ \begin{align*}
cov_{stock,home} &amp;= \rho_{stock,home} \times \sigma_{stock} \sigma_{home} \\\
cov_{stock,home} &amp;= 0.5 \times .2267 \times .1042 \end{align*}
\]</span></p>
<p>I calculate covariance and confirm that the covariance and correlations match up below:</p>
<div id="12197d34" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>cov <span class="op">=</span> <span class="fl">0.5</span> <span class="op">*</span> sigma_stock <span class="op">*</span> sigma_home</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Covariance:"</span>, cov)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Back to correlation:"</span>, cov <span class="op">/</span> (sigma_stock <span class="op">*</span> sigma_home))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Covariance: 0.01181107
Back to correlation: 0.5</code></pre>
</div>
</div>
<p>Now that I have the covariance, I’ll be able to sample from a bivariate normal distribution of the form shown below (<a href="https://en.wikipedia.org/wiki/Multivariate_normal_distribution#Bivariate_case_2">source</a>).<br>
<span class="math display">\[
\begin{pmatrix} Stock \\\\ Home\end{pmatrix} \sim \mathcal{N} \left[ \begin{pmatrix} \mu_{s} \\\ \mu_{h}\end{pmatrix}, \begin{pmatrix} \sigma_{s}^2 &amp; cov_{s,h} \\\ cov_{s,h} &amp; \sigma_{h}^2\end{pmatrix} \right]
\]</span></p>
<p><em>Note, <span class="math inline">\(s\)</span> is shorthand for stock and <span class="math inline">\(h\)</span> is shorthand for home.</em></p>
<p>Now I’ll code that in Python and confirm that the means and standard deviations of our samples match what we expect:</p>
<div id="a0c82c6b" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>cov_matrix <span class="op">=</span> np.array([[sigma_stock<span class="op">**</span><span class="dv">2</span>, cov],</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>              [cov, sigma_home<span class="op">**</span><span class="dv">2</span>]])</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>returns_df <span class="op">=</span> pd.DataFrame(np.random</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>                          .default_rng(<span class="dv">30</span>)</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>                          .multivariate_normal([mu_stock, mu_home],</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>                                               cov_matrix,</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>                                               <span class="dv">360</span>),</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>                          columns<span class="op">=</span>[<span class="st">"Stock_Appreciation"</span>, <span class="st">"Home_Appreciation"</span>])</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Means:"</span>, returns_df.mean(axis<span class="op">=</span><span class="dv">0</span>).values)</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Std. Devs:"</span>, returns_df.std(axis<span class="op">=</span><span class="dv">0</span>).values)</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>returns_df <span class="op">=</span> (returns_df <span class="op">/</span> <span class="dv">12</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Means: [0.10764063 0.05970695]
Std. Devs: [0.22544095 0.10543034]</code></pre>
</div>
</div>
<p>Plotting the simulated values, we can see that stock market returns are typically higher than home value appreciation.</p>
<div id="28a3725d" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>returns_df.add(<span class="dv">1</span>).cumprod().plot(figsize<span class="op">=</span>(<span class="dv">7</span>,<span class="dv">4</span>))</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Months"</span>)</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Money Multiplier"</span>)</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Simulated Home/Stock Returns"</span>)</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>sns.despine()<span class="op">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-29-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="b68d45fe" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>home_performance <span class="op">=</span> returns_df.add(<span class="dv">1</span>).cumprod()[<span class="st">'Home_Appreciation'</span>]</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>stock_performance <span class="op">=</span> returns_df.add(<span class="dv">1</span>).cumprod()[<span class="st">'Stock_Appreciation'</span>]</span></code></pre></div>
</div>
<p>Now we can define two spread-sheet-like dataframes: - one that shows a mortgage amortization schedule for if you were to buy the $600,000 home, along with the home’s appreciation over time. - one that shows a table of rent payments and the stock market growth of what would have been your down payment (you can invest the down payment since you didn’t end up purchasing a house).</p>
</section>
</section>
<section id="scenarios" class="level2">
<h2 class="anchored" data-anchor-id="scenarios">Scenarios</h2>
<section id="ownership-table" class="level3">
<h3 class="anchored" data-anchor-id="ownership-table">Ownership Table</h3>
<div id="63aaed89" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Buying Table</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>df_own <span class="op">=</span> pd.DataFrame()</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>df_own[<span class="st">"Period"</span>] <span class="op">=</span>  pd.Series(<span class="bu">range</span>(<span class="dv">12</span><span class="op">*</span><span class="dv">30</span>)) <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>df_own[<span class="st">"Date"</span>] <span class="op">=</span> pd.date_range(start<span class="op">=</span>datetime.today(),</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>                           periods<span class="op">=</span><span class="dv">12</span><span class="op">*</span><span class="dv">30</span>,</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>                           freq<span class="op">=</span><span class="st">'MS'</span>,</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>                           name<span class="op">=</span><span class="st">"Date"</span>)</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>df_own[<span class="st">"Principal_Paid"</span>] <span class="op">=</span> npf.ppmt(interest_rate<span class="op">/</span><span class="dv">12</span>,</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>                                    df_own[<span class="st">"Period"</span>],</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>                                    <span class="dv">12</span><span class="op">*</span><span class="dv">30</span>,</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>                                    principal)</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>df_own[<span class="st">"Interest_Paid"</span>] <span class="op">=</span> npf.ipmt(interest_rate<span class="op">/</span><span class="dv">12</span>,</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>                                   df_own[<span class="st">"Period"</span>],</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>                                   <span class="dv">12</span><span class="op">*</span><span class="dv">30</span>,</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>                                   principal)</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>df_own[<span class="st">"HOA_Paid"</span>] <span class="op">=</span> hoa</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>df_own[<span class="st">"HOA_Paid"</span>] <span class="op">=</span> df_own[<span class="st">"HOA_Paid"</span>].cumsum()</span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>df_own[<span class="st">"Balance_Remaining"</span>] <span class="op">=</span> principal <span class="op">+</span> df_own[<span class="st">"Principal_Paid"</span>].cumsum()</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>df_own[<span class="st">"Home_Value"</span>] <span class="op">=</span> <span class="bu">round</span>(cost <span class="op">*</span> home_performance, <span class="dv">2</span>)</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>df_own[<span class="st">"PropTax_Paid"</span>] <span class="op">=</span> (df_own[<span class="st">"Period"</span>]</span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>                          .<span class="bu">apply</span>(<span class="kw">lambda</span> x:</span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>                                 (cost <span class="op">*</span> <span class="fl">1.02</span><span class="op">**</span>((x<span class="op">-</span><span class="dv">1</span>)<span class="op">/</span><span class="dv">12</span>) <span class="op">*</span> <span class="fl">0.01</span>)</span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>                                 <span class="cf">if</span> (x<span class="op">-</span><span class="dv">1</span>) <span class="kw">in</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">0</span>, <span class="dv">12</span><span class="op">*</span><span class="dv">1000</span>, <span class="dv">12</span>))</span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>                                 <span class="cf">else</span> <span class="dv">0</span>)</span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a>                          .cumsum())</span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>df_own[<span class="st">"Sale_Fees"</span>] <span class="op">=</span> df_own[<span class="st">"Home_Value"</span>] <span class="op">*</span> <span class="fl">.07</span></span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a>df_own[<span class="st">"Own_Profit"</span>] <span class="op">=</span> (df_own[<span class="st">"Home_Value"</span>] <span class="op">-</span></span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a>                              df_own[<span class="st">"HOA_Paid"</span>] <span class="op">-</span></span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true" tabindex="-1"></a>                              df_own[<span class="st">"Balance_Remaining"</span>] <span class="op">-</span></span>
<span id="cb44-30"><a href="#cb44-30" aria-hidden="true" tabindex="-1"></a>                              (buying_fees <span class="op">+</span> df_own[<span class="st">"Sale_Fees"</span>]) <span class="op">-</span></span>
<span id="cb44-31"><a href="#cb44-31" aria-hidden="true" tabindex="-1"></a>                              df_own[<span class="st">"PropTax_Paid"</span>])</span>
<span id="cb44-32"><a href="#cb44-32" aria-hidden="true" tabindex="-1"></a>df_own <span class="op">=</span> <span class="bu">round</span>(df_own, <span class="dv">2</span>)</span></code></pre></div>
</div>
<p>Note this code, which is a bit of a monster:</p>
<div id="46874cc0" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>df_own[<span class="st">"PropTax_Paid"</span>] <span class="op">=</span> (df_own[<span class="st">"Period"</span>]</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>                          .<span class="bu">apply</span>(<span class="kw">lambda</span> x:</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>                                 (cost <span class="op">*</span> <span class="fl">1.02</span><span class="op">**</span>((x<span class="op">-</span><span class="dv">1</span>)<span class="op">/</span><span class="dv">12</span>) <span class="op">*</span> <span class="fl">0.01</span>)</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>                                 <span class="cf">if</span> (x<span class="op">-</span><span class="dv">1</span>) <span class="kw">in</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">0</span>, <span class="dv">12</span><span class="op">*</span><span class="dv">1000</span>, <span class="dv">12</span>))</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>                                 <span class="cf">else</span> <span class="dv">0</span>)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>                          .cumsum())</span></code></pre></div>
</div>
<p>What is happening here is a calculation of property assessed value and property tax according to California’s property assessment/tax regime (<a href="https://www.boe.ca.gov/proptaxes/pdf/pub29.pdf">more here)</a>. We’ll look at this in two pieces, first, assessed value. In California, once you purchase a property, its assessed value is set at the purchase price, then increases annually by the lower of 2% or the rate of inflation according to the California Consumer Price Index (CCPI). You could write out an equation for this as follows:</p>
<p><span class="math display">\[
\begin{align*}
AnnualFactor_y =
\begin{cases}
        1 + CCPI_y, &amp; \text{if } CCPI_y &lt; 0.02 \\\
        1.02, &amp; \text{otherwise}
\end{cases}
\end{align*}
\]</span></p>
<p><span class="math inline">\(AnnualFactor\)</span> is the amount that the assessed value of a home will appreciate (expressed as a multiplier) in a given year, <span class="math inline">\(y\)</span>. We define <span class="math inline">\(y^*\)</span> as the year of initial purchase and <span class="math inline">\(PurchasePrice\)</span> as the amount that the home was purchased for. Given that, <span class="math inline">\(AssessedValue\)</span> is defined as follows:</p>
<p><span class="math display">\[ \begin{align*}
AssessedValue_y =
    \begin{cases}
        PurchasePrice, &amp; \text{if } y = y^* \\
        AssessedValue_{y-1} \times AnnualFactor_y, &amp; \text{otherwise }
    \end{cases}
\end{align*}
\]</span></p>
<p>In our code, we will simplify this calculation by excluding the CCPI and just always using 1.02 as our annual factor. Therefore, we get:</p>
<p><span class="math display">\[
  AssessedValue_y = PurchasePrice \times 1.02^y
\]</span></p>
<p>and once we factor in taxes (1%), we get:</p>
<p><span class="math display">\[
  PropertyTax_y = 0.01(PurchasePrice \times 1.02^y)
\]</span></p>
<p>and finally we look at the the cumulative total property tax you’ve paid in a given year <span class="math inline">\(y\)</span>, which is <code>df_own["PropTax_Paid"]</code>:</p>
<p><span class="math display">\[
\begin{equation*}
  PropertyTaxPaid_y = \sum_{y=1}^{30} 0.01(PurchasePrice \times 1.02^y)
\end{equation*}
\]</span></p>
<p>There’s some elements added to the code to work between years and months, but that equation is the gist of it.<br>
We end up with the following table for property ownership:</p>
<div id="df1f7154" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>df_own</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Period</th>
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th">Principal_Paid</th>
<th data-quarto-table-cell-role="th">Interest_Paid</th>
<th data-quarto-table-cell-role="th">HOA_Paid</th>
<th data-quarto-table-cell-role="th">Balance_Remaining</th>
<th data-quarto-table-cell-role="th">Home_Value</th>
<th data-quarto-table-cell-role="th">PropTax_Paid</th>
<th data-quarto-table-cell-role="th">Sale_Fees</th>
<th data-quarto-table-cell-role="th">Own_Profit</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>2025-06-01 08:48:43.587964</td>
<td>-506.25</td>
<td>-3033.33</td>
<td>700</td>
<td>559493.75</td>
<td>701405.73</td>
<td>7000.000000</td>
<td>49098.40</td>
<td>62713.58</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2</td>
<td>2025-07-01 08:48:43.587964</td>
<td>-508.99</td>
<td>-3030.59</td>
<td>1400</td>
<td>558984.76</td>
<td>707155.41</td>
<td>7000.000000</td>
<td>49500.88</td>
<td>67869.77</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>3</td>
<td>2025-08-01 08:48:43.587964</td>
<td>-511.75</td>
<td>-3027.83</td>
<td>2100</td>
<td>558473.02</td>
<td>723324.03</td>
<td>7000.000000</td>
<td>50632.68</td>
<td>82718.33</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>4</td>
<td>2025-09-01 08:48:43.587964</td>
<td>-514.52</td>
<td>-3025.06</td>
<td>2800</td>
<td>557958.50</td>
<td>737245.96</td>
<td>7000.000000</td>
<td>51607.22</td>
<td>95480.25</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>5</td>
<td>2025-10-01 08:48:43.587964</td>
<td>-517.31</td>
<td>-3022.28</td>
<td>3500</td>
<td>557441.19</td>
<td>745606.08</td>
<td>7000.000000</td>
<td>52192.43</td>
<td>103072.46</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">355</td>
<td>356</td>
<td>2055-01-01 08:48:43.587964</td>
<td>-3445.26</td>
<td>-94.33</td>
<td>249200</td>
<td>13968.65</td>
<td>4026844.31</td>
<td>283976.554436</td>
<td>281879.10</td>
<td>3175420.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">356</td>
<td>357</td>
<td>2055-02-01 08:48:43.587964</td>
<td>-3463.92</td>
<td>-75.66</td>
<td>249900</td>
<td>10504.74</td>
<td>4044808.10</td>
<td>283976.554436</td>
<td>283136.57</td>
<td>3194890.24</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">357</td>
<td>358</td>
<td>2055-03-01 08:48:43.587964</td>
<td>-3482.68</td>
<td>-56.90</td>
<td>250600</td>
<td>7022.06</td>
<td>4066823.89</td>
<td>283976.554436</td>
<td>284677.67</td>
<td>3218147.61</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">358</td>
<td>359</td>
<td>2055-04-01 08:48:43.587964</td>
<td>-3501.54</td>
<td>-38.04</td>
<td>251300</td>
<td>3520.51</td>
<td>4096809.97</td>
<td>283976.554436</td>
<td>286776.70</td>
<td>3248836.21</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">359</td>
<td>360</td>
<td>2055-05-01 08:48:43.587964</td>
<td>-3520.51</td>
<td>-19.07</td>
<td>252000</td>
<td>-0.00</td>
<td>4122136.18</td>
<td>283976.554436</td>
<td>288549.53</td>
<td>3275210.09</td>
</tr>
</tbody>
</table>

<p>360 rows × 10 columns</p>
</div>
</div>
</div>
</section>
<section id="rental-table" class="level3">
<h3 class="anchored" data-anchor-id="rental-table">Rental Table</h3>
<p>This one is a but more simple, only examining the total rent you’ve paid in a given month and simulated stock returns at that point.</p>
<div id="a98ec289" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Rental Table</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>df_rent <span class="op">=</span> pd.DataFrame()</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>df_rent[<span class="st">"Period"</span>] <span class="op">=</span>  pd.Series(<span class="bu">range</span>(<span class="dv">12</span><span class="op">*</span><span class="dv">30</span>)) <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>df_rent[<span class="st">"Date"</span>] <span class="op">=</span> pd.date_range(start<span class="op">=</span>datetime.today(),</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>                           periods<span class="op">=</span><span class="dv">12</span><span class="op">*</span><span class="dv">30</span>,</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>                           freq<span class="op">=</span><span class="st">'MS'</span>,</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>                           name<span class="op">=</span><span class="st">"Date"</span>)</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>df_rent[<span class="st">"DownPayment_Invested"</span>] <span class="op">=</span>  stock_performance <span class="op">*</span> down_payment</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>df_rent[<span class="st">"Rent_Paid"</span>] <span class="op">=</span> rent <span class="op">*</span> <span class="fl">1.02</span><span class="op">**</span>(df_rent[<span class="st">"Period"</span>].add(<span class="dv">1</span>) <span class="op">%</span> <span class="dv">12</span> <span class="op">==</span> <span class="dv">0</span>).cumsum()</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>monthly_savings <span class="op">=</span> df_own[[<span class="st">"Principal_Paid"</span>, <span class="st">"Interest_Paid"</span>]].<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>).multiply(<span class="op">-</span><span class="dv">1</span>).add(hoa) <span class="op">-</span> df_rent[<span class="st">"Rent_Paid"</span>]</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>df_rent[<span class="st">"Total_Rent_Paid"</span>] <span class="op">=</span> df_rent[<span class="st">"Rent_Paid"</span>].cumsum()</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>df_rent[<span class="st">"Rent_Profit"</span>] <span class="op">=</span> df_rent[<span class="st">"DownPayment_Invested"</span>] <span class="op">-</span> df_rent[<span class="st">"Total_Rent_Paid"</span>] <span class="op">+</span> monthly_savings.cumsum()</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>df_rent <span class="op">=</span> <span class="bu">round</span>(df_rent, <span class="dv">2</span>)</span></code></pre></div>
</div>
</section>
</section>
<section id="results" class="level2">
<h2 class="anchored" data-anchor-id="results">Results</h2>
<p>At this point, I’ll merge the ownership and rental tables and plot out what happened in this simulation</p>
<div id="af291d06" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>merged <span class="op">=</span> pd.merge(df_own, df_rent, on<span class="op">=</span><span class="st">"Period"</span>)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>merged <span class="op">=</span> merged.melt(value_vars <span class="op">=</span> [<span class="st">"Rent_Profit"</span>, <span class="st">"Own_Profit"</span>], id_vars<span class="op">=</span><span class="st">'Period'</span>)</span></code></pre></div>
</div>
<div id="d9a07596" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">6</span>))</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Wealth Outcomes for Owning vs. Renting a 2b1br Apt"</span>)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>sns.lineplot(data<span class="op">=</span>merged, x<span class="op">=</span><span class="st">"Period"</span>, y<span class="op">=</span><span class="st">"value"</span>, hue<span class="op">=</span><span class="st">"variable"</span>)</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="co"># for x in range(0, 350, 12):</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="co">#     if x == 0:</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="co">#         plt.axvline(x, color="grey", linestyle=":", alpha=1, label="Year")</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="co">#     else:</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a><span class="co">#         plt.axvline(x, color="grey", linestyle=":", alpha=0.7)</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a><span class="co">#     plt.text(x+1, -100000, str(int(x/12)), alpha=0.8)</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>plt.axhline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">"red"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, label<span class="op">=</span><span class="st">"Zero"</span>)</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>sns.despine()</span></code></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-37-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We can quickly see that ownership will clearly build more wealth in the medium and long run:</p>
<div id="ae8f248e" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>years <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Owner after </span><span class="sc">{</span>years<span class="sc">}</span><span class="ss"> years:"</span>, df_own.loc[<span class="dv">12</span><span class="op">*</span>years<span class="op">-</span><span class="dv">1</span>, <span class="st">"Own_Profit"</span>])</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Renter after </span><span class="sc">{</span>years<span class="sc">}</span><span class="ss"> years:"</span>, df_rent.loc[<span class="dv">12</span><span class="op">*</span>years<span class="op">-</span><span class="dv">1</span>, <span class="st">"Rent_Profit"</span>])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Owner after 5 years: 243148.71
Renter after 5 years: 135926.53</code></pre>
</div>
</div>
<p>However, we can see that, in the unlikely case that the home is sold within the first year or so, the wealth of the renter and the owner are very similar, likely due to the owner contending with buying/selling fees:</p>
<div id="360d55e9" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>years <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Owner after </span><span class="sc">{</span>years<span class="sc">}</span><span class="ss"> years:"</span>, df_own.loc[<span class="dv">12</span><span class="op">*</span>years<span class="op">-</span><span class="dv">1</span>, <span class="st">"Own_Profit"</span>])</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Renter after </span><span class="sc">{</span>years<span class="sc">}</span><span class="ss"> years:"</span>, df_rent.loc[<span class="dv">12</span><span class="op">*</span>years<span class="op">-</span><span class="dv">1</span>, <span class="st">"Rent_Profit"</span>])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Owner after 1 years: 115891.0
Renter after 1 years: 135331.15</code></pre>
</div>
</div>
<p>A possible takeaway here is that, as long as you can be confident you’ll be able to hold onto the house for more than a year, it’s probably better to purchase it. Uncertainty estimates would be useful here, and could be obtained by running the simulation under a wide variety of randomly generated market conditions.</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{amerkhanian2022,
  author = {Amerkhanian, Peter},
  title = {Buy Vs. {Rent,} {A} {Financial} {Modeling} {Workflow} in
    {Python}},
  date = {2022-08-06},
  url = {https://peter-amerkhanian.com/posts/rent-vs-buy/},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-amerkhanian2022" class="csl-entry quarto-appendix-citeas" role="listitem">
Amerkhanian, Peter. 2022. <span>“Buy Vs. Rent, A Financial Modeling
Workflow in Python.”</span> August 6, 2022. <a href="https://peter-amerkhanian.com/posts/rent-vs-buy/">https://peter-amerkhanian.com/posts/rent-vs-buy/</a>.
</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/peter-amerkhanian\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
          // target, if specified
          link.setAttribute("target", "_blank");
          if (link.getAttribute("rel") === null) {
            link.setAttribute("rel", "noopener");
          }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>Copyright 2024, Peter Amerkhanian</p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>