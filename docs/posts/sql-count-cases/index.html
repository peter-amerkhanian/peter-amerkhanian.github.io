<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Peter Amerkhanian">
<meta name="dcterms.date" content="2024-11-20">
<meta name="description" content="Using DuckDB to look at some GROUP BY and PARTITION BY statements in SQL.">

<title>Grouping Problems with SQL – Peter Amerkhanian</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../profile_backup.jpg" rel="icon" type="image/jpeg">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-1092c56c6cadf2eb47b1bc8063ab382a.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-5d17cd34d2e348db00e20f83fc65b062.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-V95HGLKTEB"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-V95HGLKTEB', { 'anonymize_ip': true});
</script>
<script src="../../site_libs/quarto-diagram/mermaid.min.js"></script>
<script src="../../site_libs/quarto-diagram/mermaid-init.js"></script>
<link href="../../site_libs/quarto-diagram/mermaid.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../profile_backup.jpg" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Home</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../projects.html"> 
<span class="menu-text">Professional</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Grouping Problems with SQL</h1>
                  <div>
        <div class="description">
          Using DuckDB to look at some <code>GROUP BY</code> and <code>PARTITION BY</code> statements in SQL.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">SQL</div>
                <div class="quarto-category">Data Management</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Peter Amerkhanian </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">November 20, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
        <h2 id="toc-title"><a href="#" class="nav-link">Grouping Problems with SQL</a></h2>
     
    <ul>
    <li><a href="#connecting-to-a-pandas-data-frame-in-duckdb" id="toc-connecting-to-a-pandas-data-frame-in-duckdb" class="nav-link active" data-scroll-target="#connecting-to-a-pandas-data-frame-in-duckdb">Connecting to a <code>pandas</code> data frame in <code>duckdb</code></a>
    <ul class="collapse">
    <li><a href="#executing-and-displaying-sql-in-quarto" id="toc-executing-and-displaying-sql-in-quarto" class="nav-link" data-scroll-target="#executing-and-displaying-sql-in-quarto">Executing and displaying SQL in Quarto</a></li>
    </ul></li>
    <li><a href="#aggregating-with-group-by" id="toc-aggregating-with-group-by" class="nav-link" data-scroll-target="#aggregating-with-group-by">Aggregating with <code>GROUP BY</code></a></li>
    <li><a href="#aggregating-with-partition-by" id="toc-aggregating-with-partition-by" class="nav-link" data-scroll-target="#aggregating-with-partition-by">Aggregating with <code>PARTITION BY</code></a></li>
    <li><a href="#aggregation-across-common-table-expressions" id="toc-aggregation-across-common-table-expressions" class="nav-link" data-scroll-target="#aggregation-across-common-table-expressions">Aggregation across common table expressions</a></li>
    <li><a href="#multiple-aggregations-in-one-table" id="toc-multiple-aggregations-in-one-table" class="nav-link" data-scroll-target="#multiple-aggregations-in-one-table">Multiple aggregations in one table</a></li>
    </ul>
    <div class="quarto-alternate-formats">
    <ul><li>
    <a id="github" href="#" target="_blank"><i class="bi bi-github"></i>Source Code</a>
  </li></ul>
</div>

  </nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">






<script>
  var githubLink = document.getElementById("github");
  var currentPath = window.location.pathname;
  githubLink.href = "https://github.com/peter-amerkhanian/peter-amerkhanian.github.io/blob/master" + currentPath;
  document.getElementById('toc-title').addEventListener('click', function(event) {
  event.preventDefault(); // Prevent default behavior of anchor tag
  const firstHeader = document.querySelector('body'); // Select the first h2 element
  if (firstHeader) {
    firstHeader.scrollIntoView({ behavior: 'smooth', block: "start", inline: "nearest"}); // Scroll to the first header smoothly
  }
});
</script>
<div id="cell-1" class="cell" data-execution_count="388">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> duckdb</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> display, Markdown</span></code></pre></div>
</div>
<p>Lately I’ve been struggling through some SQL query development, and I thought it would be useful to write out some of what I’ve been learning in a blog post. Specifically, I’ve been thinking about how to do various grouping tasks when data have a hierarchical structure. I’ll cover the following SQL concepts:</p>
<ul>
<li>The <code>GROUP BY</code> clause</li>
<li>The <code>PARTITION BY</code> clause</li>
<li>An aggregation task complicated by a dataset’s hierarchy</li>
</ul>
<p>This post is also an opportunity to overview how I display <strong>and</strong> run SQL code with syntax highlighting in Quarto – a nontrivial task as it turns out!</p>
<p>To start, I’ll synthesize a simple dataset that examines car accidents on the Interstate 280 and 580 highways in the Bay Area. I’ll go over the specifics later, but for now just note that this is a standard <code>pandas</code> dataframe stored in local memory as <code>accidents</code>. It contains data on cars’ trips on the two highways, and a flag denoting whether the trip was associated with an accident or not.</p>
<div id="cell-5" class="cell" data-outputid="01d013e7-0cf6-41d6-f422-7e2e9478ee2c" data-execution_count="390">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="dv">1000</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> {</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"license_plate"</span>: [<span class="ss">f"</span><span class="sc">{</span>random<span class="sc">.</span>randint(<span class="dv">90000</span>, <span class="dv">90099</span>)<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n)],</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"highway"</span>: [random.choice([<span class="st">"I280"</span>, <span class="st">"I580"</span>]) <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n)],</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"trip_date"</span>: [<span class="ss">f"2024-11-</span><span class="sc">{</span>random<span class="sc">.</span>randint(<span class="dv">13</span>, <span class="dv">15</span>)<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n)],</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"accident_flag"</span>: np.random.binomial(<span class="dv">1</span>, <span class="fl">.1</span>, n),</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>accidents <span class="op">=</span> pd.DataFrame(data)</span></code></pre></div>
</div>
<section id="connecting-to-a-pandas-data-frame-in-duckdb" class="level2">
<h2 class="anchored" data-anchor-id="connecting-to-a-pandas-data-frame-in-duckdb">Connecting to a <code>pandas</code> data frame in <code>duckdb</code></h2>
<p>The data I simulated are quite small, so using SQL isn’t going to be very practically useful. However, I find that it’s helpful to play with small SQL databases like this to build general comfort with the language and to get a better intuition of how operations will play out when I’m are working at scale.</p>
<p>I’m going to use the <a href="https://duckdb.org/"><code>duckdb</code> database system</a> to directly query the <code>pandas</code> data frame I have in local memory (Note that <code>duckdb</code> can also directly query <a href="https://duckdb.org/docs/api/python/overview.html#data-input">parquet files, csv files, and more</a>).</p>
<div id="cell-7" class="cell" data-execution_count="391">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>duckdb.sql(<span class="st">"SELECT * FROM accidents LIMIT 5;"</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="391">
<pre><code>┌───────────────┬─────────┬────────────┬───────────────┐
│ license_plate │ highway │ trip_date  │ accident_flag │
│    varchar    │ varchar │  varchar   │     int32     │
├───────────────┼─────────┼────────────┼───────────────┤
│ 90092         │ I580    │ 2024-11-14 │             0 │
│ 90095         │ I580    │ 2024-11-14 │             1 │
│ 90080         │ I280    │ 2024-11-15 │             0 │
│ 90026         │ I280    │ 2024-11-15 │             0 │
│ 90093         │ I280    │ 2024-11-13 │             0 │
└───────────────┴─────────┴────────────┴───────────────┘</code></pre>
</div>
</div>
<section id="executing-and-displaying-sql-in-quarto" class="level3">
<h3 class="anchored" data-anchor-id="executing-and-displaying-sql-in-quarto">Executing and displaying SQL in Quarto</h3>
<p>The fact that <code>duckdb</code> can directly query data in memory is great, but two issues arise – the SQL code doesn’t have any syntax highlighting, and it would be preferable if the output were a data frame rather than plain text. I’ll create a wrapper function, <code>run_query</code> that solves these issues:</p>
<div id="cell-10" class="cell" data-execution_count="392">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> run_query(sql_str: <span class="bu">str</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  display(Markdown(<span class="st">"```sql</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> sql_str.strip(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span>) <span class="op">+</span> <span class="st">"</span><span class="ch">\n</span><span class="st">```"</span>))</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> duckdb.sql(sql_str).df()</span></code></pre></div>
</div>
<p>Note the following code elements:</p>
<ol type="1">
<li><code>display(Markdown(...))</code> will display <code>sql_str</code>, the string code for the query, but with a wrapper around it as follows:</li>
</ol>
<div class="sourceCode" id="cb6"><pre class="sourceCode numberSource markdown number-lines"><code class="sourceCode markdown"><span id="cb6-1"><a href="#cb6-1"></a><span class="in">```{sql}</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="in">sql_str </span></span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="in">```</span></span></code></pre></div>
<p>The wrapper alerts Quarto that it should provide SQL syntax-highlighting for the code output.</p>
<ol start="2" type="1">
<li><code>duckdb.sql(sql_str).df()</code> returns the results of the SQL query as a <code>pd.DataFrame</code> object rather than the text-table rendered above.</li>
</ol>
<p>For the rest of the post, I will use that function, within cells with the setting <code>echo: false</code> to carry out my SQL queries. Thus, you won’t see the python function, just a code chunk of the SQL query code and the query result. Here’s an example query, looking at the first five rows of <code>accidents</code>:</p>
<div id="cell-13" class="cell" data-execution_count="393">
<div class="cell-output cell-output-display cell-output-markdown">
<div class="sourceCode" id="cb7"><pre class="sourceCode numberSource sql number-lines"><code class="sourceCode sql"><span id="cb7-1"><a href="#cb7-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> accidents</span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="kw">LIMIT</span> <span class="dv">5</span>;</span></code></pre></div>
</div>
<div class="cell-output cell-output-display" data-execution_count="393">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">license_plate</th>
<th data-quarto-table-cell-role="th">highway</th>
<th data-quarto-table-cell-role="th">trip_date</th>
<th data-quarto-table-cell-role="th">accident_flag</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>90092</td>
<td>I580</td>
<td>2024-11-14</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>90095</td>
<td>I580</td>
<td>2024-11-14</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>90080</td>
<td>I280</td>
<td>2024-11-15</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>90026</td>
<td>I280</td>
<td>2024-11-15</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>90093</td>
<td>I280</td>
<td>2024-11-13</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Note the hierarchy of these trip data:</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart LR

    A[Date] --&gt; B[Highway]
    B --&gt; C[Car&lt;br/&gt;license plate]
    C --&gt; D(["`**Trip**`"])
    D o-.-o E[Accident Flag]
    
    A1[Multiple highways&lt;br/&gt;per date] -.-&gt; B
    B1[Multiple cars&lt;br/&gt;per highway] -.-&gt; C
    C1[Multiple trips&lt;br/&gt;per car] -.-&gt; D
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p>We start with Dates and proceed downward. Each Date can have multiple Highways, each Highway can have multiple Cars (identified by license plate), and each Car can have multiple Trips. Trips are the lowest granularity of the data – each row is a trip. Individual trips are then described by the accident flag column, which denotes whether the trip was associated with an accident or not.</p>
<p>I’ll look at a few key SQL methods using these data.</p>
</section>
</section>
<section id="aggregating-with-group-by" class="level2">
<h2 class="anchored" data-anchor-id="aggregating-with-group-by">Aggregating with <code>GROUP BY</code></h2>
<p>Let’s say we were interested in counting total trips and total accidents for each highway on each day. This is a group aggregation task, where we want to calculate summary statistics (two counts) for subsets of the data grouped by one or more columns. In SQL this is done using the <code>GROUP BY</code> clause and an aggregation function (<code>COUNT</code> and <code>SUM</code> in this case).</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart LR
A[(row: 1k&lt;br&gt;col: 4)] --select --&gt; B[Date]
A --select --&gt; C[Highway]
A--select --&gt; P[Accident&lt;br&gt;Flag]
    B --&gt; E[Group&lt;br&gt;By]
    C --&gt; E
    subgraph sql ["SQL Grouping Operations"]
    E --&gt; M[Agg-&lt;br&gt;regate]
    M --&gt; F["Count rows&lt;br/&gt;COUNT(*)"]
    M --&gt; G["Count accidents&lt;br/&gt;SUM(accident_flag)"]
    end
    P --&gt; M
    F --&gt; Q[(row: 3 X 2&lt;br&gt;col: 4)]
    G --&gt; Q


style sql fill:none
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p>Equivalent <code>pandas</code> code is available via the navbar. In this case, I like the SQL and <code>pandas</code> syntax about equally.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true">SQL</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false"><code>pandas</code></a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div id="cell-20" class="cell" data-execution_count="394">
<div class="cell-output cell-output-display cell-output-markdown">
<div class="sourceCode" id="cb8"><pre class="sourceCode numberSource sql number-lines"><code class="sourceCode sql"><span id="cb8-1"><a href="#cb8-1"></a><span class="kw">SELECT</span></span>
<span id="cb8-2"><a href="#cb8-2"></a>  highway,</span>
<span id="cb8-3"><a href="#cb8-3"></a>  trip_date,</span>
<span id="cb8-4"><a href="#cb8-4"></a>  <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">as</span> n_trips,</span>
<span id="cb8-5"><a href="#cb8-5"></a>  <span class="fu">SUM</span>(accident_flag) <span class="kw">as</span> n_accidents</span>
<span id="cb8-6"><a href="#cb8-6"></a><span class="kw">FROM</span></span>
<span id="cb8-7"><a href="#cb8-7"></a>  accidents</span>
<span id="cb8-8"><a href="#cb8-8"></a><span class="kw">GROUP</span> <span class="kw">BY</span></span>
<span id="cb8-9"><a href="#cb8-9"></a>  highway,</span>
<span id="cb8-10"><a href="#cb8-10"></a>  trip_date</span>
<span id="cb8-11"><a href="#cb8-11"></a><span class="kw">ORDER</span> <span class="kw">BY</span></span>
<span id="cb8-12"><a href="#cb8-12"></a>  highway,</span>
<span id="cb8-13"><a href="#cb8-13"></a>  trip_date</span></code></pre></div>
</div>
<div class="cell-output cell-output-display" data-execution_count="394">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">highway</th>
<th data-quarto-table-cell-role="th">trip_date</th>
<th data-quarto-table-cell-role="th">n_trips</th>
<th data-quarto-table-cell-role="th">n_accidents</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>I280</td>
<td>2024-11-13</td>
<td>151</td>
<td>19.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>I280</td>
<td>2024-11-14</td>
<td>181</td>
<td>22.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>I280</td>
<td>2024-11-15</td>
<td>176</td>
<td>15.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>I580</td>
<td>2024-11-13</td>
<td>171</td>
<td>16.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>I580</td>
<td>2024-11-14</td>
<td>167</td>
<td>13.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>I580</td>
<td>2024-11-15</td>
<td>154</td>
<td>15.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div id="cell-22" class="cell" data-execution_count="395">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1"></a>(</span>
<span id="cb9-2"><a href="#cb9-2"></a>    accidents</span>
<span id="cb9-3"><a href="#cb9-3"></a>    .groupby([<span class="st">'highway'</span>, <span class="st">'trip_date'</span>], as_index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb9-4"><a href="#cb9-4"></a>    .agg(</span>
<span id="cb9-5"><a href="#cb9-5"></a>        n_trips<span class="op">=</span>(<span class="st">'trip_date'</span>, <span class="st">'size'</span>),</span>
<span id="cb9-6"><a href="#cb9-6"></a>        n_accidents_date_highway<span class="op">=</span>(<span class="st">'accident_flag'</span>, <span class="st">'sum'</span>)</span>
<span id="cb9-7"><a href="#cb9-7"></a>    )</span>
<span id="cb9-8"><a href="#cb9-8"></a>    .sort_values(by<span class="op">=</span>[<span class="st">'highway'</span>, <span class="st">'trip_date'</span>])</span>
<span id="cb9-9"><a href="#cb9-9"></a>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="395">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">highway</th>
<th data-quarto-table-cell-role="th">trip_date</th>
<th data-quarto-table-cell-role="th">n_trips</th>
<th data-quarto-table-cell-role="th">n_accidents_date_highway</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>I280</td>
<td>2024-11-13</td>
<td>151</td>
<td>19</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>I280</td>
<td>2024-11-14</td>
<td>181</td>
<td>22</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>I280</td>
<td>2024-11-15</td>
<td>176</td>
<td>15</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>I580</td>
<td>2024-11-13</td>
<td>171</td>
<td>16</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>I580</td>
<td>2024-11-14</td>
<td>167</td>
<td>13</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>I580</td>
<td>2024-11-15</td>
<td>154</td>
<td>15</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
</div>
</div>
<p>Note that the <code>GROUP BY</code> operation reduces our data granularity down to the unique highway-date pairs. This is typical aggregation behavior. Also note in lines 4 and 5 of the SQL code, that for accidents, I use <code>COUNT(*)</code>. This simply counts all rows within the group. In the case of the accident flags, I use <code>SUM(accident_flag)</code> within groups since the column is a 1/0 integer flag.</p>
</section>
<section id="aggregating-with-partition-by" class="level2">
<h2 class="anchored" data-anchor-id="aggregating-with-partition-by">Aggregating with <code>PARTITION BY</code></h2>
<p>The Partition is an odd cousin of the Group that I became aware of only recently. In essence, it accomplishes the same thing as <code>GROUP BY</code>, but it doesn’t compress the data or otherwise change granularity. Instead, it returns a dataframe with a group’s aggregate result replicated at every row where that group exists.</p>
<p>Note the bold portions in the diagram below. The SQL grouping operations look basically the same as when we were using <code>GROUP BY</code> and we will get the same highway-date level aggregates from those operations. However, we have a very different row count in the output, and we are able to still select columns, in this case License Plate, that were not part of the grouping operation. This is because the output rows are still at the trip level, not the highway-date level.</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart LR
A[(row: 1k &lt;br&gt;col: 4)] --select --&gt; B[Date]
A --select --&gt; C[Highway]
A--select --&gt; P[Accident&lt;br&gt;Flag]
A==select ==&gt; J["`**License**&lt;br&gt;**Plate**`"]
    B --&gt; E["`**Partition**&lt;br&gt;**By**`"]
    C --&gt; E
    subgraph sql ["SQL Grouping Operations"]
    E --&gt; M[Agg-&lt;br&gt;regate]
    M --&gt; F["Count rows&lt;br/&gt;COUNT(*)"]
    M --&gt; G["Count accidents&lt;br/&gt;SUM(accident_flag)"]
    end
    P --&gt; M
    F --&gt; Q[("`**row: 1k** &lt;br&gt;col: 5`")]
    G --&gt; Q
    J ==&gt; Q


style sql fill:none
</pre>
</div>
<p></p><figcaption> A diagram of PARTITION BY``</figcaption> </figure><p></p>
</div>
</div>
</div>
<p>I can express this more clearly via example.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" role="tab" aria-controls="tabset-2-1" aria-selected="true">SQL</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" role="tab" aria-controls="tabset-2-2" aria-selected="false"><code>pandas</code></a></li></ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-2-1-tab">
<div id="cell-27" class="cell" data-execution_count="396">
<div class="cell-output cell-output-display cell-output-markdown">
<div class="sourceCode" id="cb10"><pre class="sourceCode numberSource sql number-lines"><code class="sourceCode sql"><span id="cb10-1"><a href="#cb10-1"></a><span class="kw">SELECT</span></span>
<span id="cb10-2"><a href="#cb10-2"></a>    <span class="op">*</span>,</span>
<span id="cb10-3"><a href="#cb10-3"></a>    <span class="fu">SUM</span>(accident_flag)</span>
<span id="cb10-4"><a href="#cb10-4"></a>        <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> highway, trip_date)</span>
<span id="cb10-5"><a href="#cb10-5"></a>    <span class="kw">as</span> n_accidents_date_highway</span>
<span id="cb10-6"><a href="#cb10-6"></a><span class="kw">FROM</span> accidents</span>
<span id="cb10-7"><a href="#cb10-7"></a><span class="kw">ORDER</span> <span class="kw">BY</span></span>
<span id="cb10-8"><a href="#cb10-8"></a>  highway,</span>
<span id="cb10-9"><a href="#cb10-9"></a>  trip_date;</span></code></pre></div>
</div>
<div class="cell-output cell-output-display" data-execution_count="396">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">license_plate</th>
<th data-quarto-table-cell-role="th">highway</th>
<th data-quarto-table-cell-role="th">trip_date</th>
<th data-quarto-table-cell-role="th">accident_flag</th>
<th data-quarto-table-cell-role="th">n_accidents_date_highway</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>90021</td>
<td>I280</td>
<td>2024-11-13</td>
<td>0</td>
<td>19.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>90031</td>
<td>I280</td>
<td>2024-11-13</td>
<td>0</td>
<td>19.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>90019</td>
<td>I280</td>
<td>2024-11-13</td>
<td>0</td>
<td>19.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>90059</td>
<td>I280</td>
<td>2024-11-13</td>
<td>1</td>
<td>19.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>90054</td>
<td>I280</td>
<td>2024-11-13</td>
<td>0</td>
<td>19.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">995</td>
<td>90002</td>
<td>I580</td>
<td>2024-11-15</td>
<td>0</td>
<td>15.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">996</td>
<td>90000</td>
<td>I580</td>
<td>2024-11-15</td>
<td>0</td>
<td>15.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">997</td>
<td>90062</td>
<td>I580</td>
<td>2024-11-15</td>
<td>0</td>
<td>15.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">998</td>
<td>90037</td>
<td>I580</td>
<td>2024-11-15</td>
<td>0</td>
<td>15.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">999</td>
<td>90003</td>
<td>I580</td>
<td>2024-11-15</td>
<td>0</td>
<td>15.0</td>
</tr>
</tbody>
</table>

<p>1000 rows × 5 columns</p>
</div>
</div>
</div>
</div>
<div id="tabset-2-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-2-tab">
<div id="cell-29" class="cell" data-execution_count="397">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource python number-lines"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1"></a>(</span>
<span id="cb11-2"><a href="#cb11-2"></a>    accidents</span>
<span id="cb11-3"><a href="#cb11-3"></a>    .assign(n_accidents_date_highway<span class="op">=</span></span>
<span id="cb11-4"><a href="#cb11-4"></a>            accidents</span>
<span id="cb11-5"><a href="#cb11-5"></a>            .groupby([<span class="st">'highway'</span>, <span class="st">'trip_date'</span>])[<span class="st">'accident_flag'</span>]</span>
<span id="cb11-6"><a href="#cb11-6"></a>            .transform(<span class="st">'sum'</span>)</span>
<span id="cb11-7"><a href="#cb11-7"></a>    )</span>
<span id="cb11-8"><a href="#cb11-8"></a>    .sort_values(by<span class="op">=</span>[<span class="st">'highway'</span>, <span class="st">'trip_date'</span>])</span>
<span id="cb11-9"><a href="#cb11-9"></a>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="397">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">license_plate</th>
<th data-quarto-table-cell-role="th">highway</th>
<th data-quarto-table-cell-role="th">trip_date</th>
<th data-quarto-table-cell-role="th">accident_flag</th>
<th data-quarto-table-cell-role="th">n_accidents_date_highway</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>90093</td>
<td>I280</td>
<td>2024-11-13</td>
<td>0</td>
<td>19</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12</td>
<td>90053</td>
<td>I280</td>
<td>2024-11-13</td>
<td>0</td>
<td>19</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">23</td>
<td>90086</td>
<td>I280</td>
<td>2024-11-13</td>
<td>0</td>
<td>19</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">27</td>
<td>90023</td>
<td>I280</td>
<td>2024-11-13</td>
<td>0</td>
<td>19</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">29</td>
<td>90057</td>
<td>I280</td>
<td>2024-11-13</td>
<td>0</td>
<td>19</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">964</td>
<td>90004</td>
<td>I580</td>
<td>2024-11-15</td>
<td>0</td>
<td>15</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">969</td>
<td>90070</td>
<td>I580</td>
<td>2024-11-15</td>
<td>0</td>
<td>15</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">983</td>
<td>90050</td>
<td>I580</td>
<td>2024-11-15</td>
<td>0</td>
<td>15</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">988</td>
<td>90000</td>
<td>I580</td>
<td>2024-11-15</td>
<td>0</td>
<td>15</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">993</td>
<td>90095</td>
<td>I580</td>
<td>2024-11-15</td>
<td>0</td>
<td>15</td>
</tr>
</tbody>
</table>

<p>1000 rows × 5 columns</p>
</div>
</div>
</div>
</div>
</div>
</div>
<p>Note in the output that the number of accidents on I280 on 11/15/2024 is the same as it was in the grouped output above, but it repeats for every row from highway I280 on 11/15/2024 in the partitioned version. The <code>pandas</code> implementation for this task, available via the navbar, relies on the combination of <code>groupby()</code> and <code>transform()</code>, which I find unintuitive.</p>
<p>Thus, <code>PARTITION BY</code> preserves the long format of the data, while still allowing for the creation of aggregate columns. This can be useful behavior, though can introduce some confusion, since we now have a column of group-level results in a data frame that is not compressed to the group level. I try to use column naming to make that clear, but it’s a little difficult.</p>
</section>
<section id="aggregation-across-common-table-expressions" class="level2">
<h2 class="anchored" data-anchor-id="aggregation-across-common-table-expressions">Aggregation across common table expressions</h2>
<p>Now let’s use <code>GROUP BY</code> and <code>PARTITION BY</code> together in a complex query. At this point I’ll stop providing <code>pandas</code> translations because I view it as less analogous – were I doing queries like this in <code>pandas</code>, I would be stopping to define intermediary tables and things would generally look different.</p>
<p>Suppose we want to know the number of accidents on each highway each day, but we also want to have some information about whether that number of accidents is typical for that highway, or if it’s an outlier. We can use a <a href="https://en.wikipedia.org/wiki/Standard_score">z-score</a> to measure the position of an accident count within the highway’s historical distribution, but computing both the count of accidents at the highway-date level, then computing z-scores per highway is complicated.</p>
<p>In SQL, complex queries like this often involve Common Table Expressions (<a href="https://duckdb.org/docs/sql/query_syntax/with.html">CTEs</a>). I find working with CTEs more than a little difficult because it’s hard to determine what each CTE outputs. Below, I show a full query that uses both <code>GROUP BY</code> and <code>PARTITION BY</code> to complete my task. I also include a navigation bar that allows one to see what each of the three intermediary select statements output, thus expressing the query as a series of smaller queries and making the CTE content more transparent.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-3-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-1" role="tab" aria-controls="tabset-3-1" aria-selected="true">Full Query</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-2" role="tab" aria-controls="tabset-3-2" aria-selected="false">Step 1</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-3" role="tab" aria-controls="tabset-3-3" aria-selected="false">Step 2</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-4" role="tab" aria-controls="tabset-3-4" aria-selected="false">Step 3</a></li></ul>
<div class="tab-content">
<div id="tabset-3-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-3-1-tab">
<div id="cell-36" class="cell" data-execution_count="398">
<div class="cell-output cell-output-display cell-output-markdown">
<div class="sourceCode" id="cb12"><pre class="sourceCode numberSource sql number-lines"><code class="sourceCode sql"><span id="cb12-1"><a href="#cb12-1"></a><span class="kw">WITH</span> grouped_table <span class="kw">as</span> (</span>
<span id="cb12-2"><a href="#cb12-2"></a>  <span class="kw">SELECT</span></span>
<span id="cb12-3"><a href="#cb12-3"></a>    highway,</span>
<span id="cb12-4"><a href="#cb12-4"></a>    trip_date,</span>
<span id="cb12-5"><a href="#cb12-5"></a>    <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">as</span> n_trips,</span>
<span id="cb12-6"><a href="#cb12-6"></a>    <span class="fu">SUM</span>(accident_flag) <span class="kw">as</span> n_accidents </span>
<span id="cb12-7"><a href="#cb12-7"></a>  <span class="kw">FROM</span></span>
<span id="cb12-8"><a href="#cb12-8"></a>    accidents</span>
<span id="cb12-9"><a href="#cb12-9"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span></span>
<span id="cb12-10"><a href="#cb12-10"></a>    highway,</span>
<span id="cb12-11"><a href="#cb12-11"></a>    trip_date</span>
<span id="cb12-12"><a href="#cb12-12"></a>),</span>
<span id="cb12-13"><a href="#cb12-13"></a>          </span>
<span id="cb12-14"><a href="#cb12-14"></a>partitions_table <span class="kw">as</span> (</span>
<span id="cb12-15"><a href="#cb12-15"></a>  <span class="kw">SELECT</span></span>
<span id="cb12-16"><a href="#cb12-16"></a>    <span class="op">*</span>,</span>
<span id="cb12-17"><a href="#cb12-17"></a>    <span class="fu">AVG</span>(n_accidents) <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> highway) <span class="kw">as</span> highway_average,</span>
<span id="cb12-18"><a href="#cb12-18"></a>    <span class="fu">STDDEV_POP</span>(n_accidents) <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> highway) <span class="kw">as</span> highway_std,</span>
<span id="cb12-19"><a href="#cb12-19"></a>  <span class="kw">FROM</span> grouped_table</span>
<span id="cb12-20"><a href="#cb12-20"></a>)</span>
<span id="cb12-21"><a href="#cb12-21"></a></span>
<span id="cb12-22"><a href="#cb12-22"></a><span class="kw">SELECT</span></span>
<span id="cb12-23"><a href="#cb12-23"></a>  highway,</span>
<span id="cb12-24"><a href="#cb12-24"></a>  trip_date,</span>
<span id="cb12-25"><a href="#cb12-25"></a>  n_trips,</span>
<span id="cb12-26"><a href="#cb12-26"></a>  n_accidents,</span>
<span id="cb12-27"><a href="#cb12-27"></a>  (n_accidents <span class="op">-</span> highway_average) <span class="op">/</span> highway_std <span class="kw">as</span> highway_z_score</span>
<span id="cb12-28"><a href="#cb12-28"></a><span class="kw">FROM</span> partitions_table;</span></code></pre></div>
</div>
<div class="cell-output cell-output-display" data-execution_count="398">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">highway</th>
<th data-quarto-table-cell-role="th">trip_date</th>
<th data-quarto-table-cell-role="th">n_trips</th>
<th data-quarto-table-cell-role="th">n_accidents</th>
<th data-quarto-table-cell-role="th">highway_z_score</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>I280</td>
<td>2024-11-13</td>
<td>151</td>
<td>19.0</td>
<td>0.116248</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>I280</td>
<td>2024-11-14</td>
<td>181</td>
<td>22.0</td>
<td>1.162476</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>I280</td>
<td>2024-11-15</td>
<td>176</td>
<td>15.0</td>
<td>-1.278724</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>I580</td>
<td>2024-11-15</td>
<td>154</td>
<td>15.0</td>
<td>0.267261</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>I580</td>
<td>2024-11-13</td>
<td>171</td>
<td>16.0</td>
<td>1.069045</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>I580</td>
<td>2024-11-14</td>
<td>167</td>
<td>13.0</td>
<td>-1.336306</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="tabset-3-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-2-tab">
<p>We start with the same basic grouped table, where each row is a unique highway-date combination with its total trips and total accidents.</p>
<div id="cell-38" class="cell" data-execution_count="399">
<div class="cell-output cell-output-display cell-output-markdown">
<div class="sourceCode" id="cb13"><pre class="sourceCode numberSource sql number-lines"><code class="sourceCode sql"><span id="cb13-1"><a href="#cb13-1"></a><span class="kw">WITH</span> grouped_table <span class="kw">as</span> (</span>
<span id="cb13-2"><a href="#cb13-2"></a>  <span class="kw">SELECT</span></span>
<span id="cb13-3"><a href="#cb13-3"></a>    highway,</span>
<span id="cb13-4"><a href="#cb13-4"></a>    trip_date,</span>
<span id="cb13-5"><a href="#cb13-5"></a>    <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">as</span> n_trips,</span>
<span id="cb13-6"><a href="#cb13-6"></a>    <span class="fu">SUM</span>(accident_flag) <span class="kw">as</span> n_accidents </span>
<span id="cb13-7"><a href="#cb13-7"></a>  <span class="kw">FROM</span></span>
<span id="cb13-8"><a href="#cb13-8"></a>    accidents </span>
<span id="cb13-9"><a href="#cb13-9"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span></span>
<span id="cb13-10"><a href="#cb13-10"></a>    highway,</span>
<span id="cb13-11"><a href="#cb13-11"></a>    trip_date</span>
<span id="cb13-12"><a href="#cb13-12"></a>)</span>
<span id="cb13-13"><a href="#cb13-13"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> grouped_table</span></code></pre></div>
</div>
<div class="cell-output cell-output-display" data-execution_count="399">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">highway</th>
<th data-quarto-table-cell-role="th">trip_date</th>
<th data-quarto-table-cell-role="th">n_trips</th>
<th data-quarto-table-cell-role="th">n_accidents</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>I280</td>
<td>2024-11-15</td>
<td>176</td>
<td>15.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>I580</td>
<td>2024-11-13</td>
<td>171</td>
<td>16.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>I280</td>
<td>2024-11-14</td>
<td>181</td>
<td>22.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>I580</td>
<td>2024-11-14</td>
<td>167</td>
<td>13.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>I280</td>
<td>2024-11-13</td>
<td>151</td>
<td>19.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>I580</td>
<td>2024-11-15</td>
<td>154</td>
<td>15.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="tabset-3-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-3-tab">
<p>We proceed to use <code>PARTITION BY</code> statements on that grouped table, finding the average and standard deviation across dates for each highway.</p>
<div id="cell-40" class="cell" data-execution_count="400">
<div class="cell-output cell-output-display cell-output-markdown">
<div class="sourceCode" id="cb14"><pre class="sourceCode numberSource sql number-lines"><code class="sourceCode sql"><span id="cb14-1"><a href="#cb14-1"></a><span class="kw">WITH</span> partitions_table <span class="kw">as</span> (</span>
<span id="cb14-2"><a href="#cb14-2"></a>  <span class="kw">SELECT</span></span>
<span id="cb14-3"><a href="#cb14-3"></a>    <span class="op">*</span>,</span>
<span id="cb14-4"><a href="#cb14-4"></a>    <span class="fu">AVG</span>(n_accidents) <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> highway) <span class="kw">as</span> highway_average,</span>
<span id="cb14-5"><a href="#cb14-5"></a>    <span class="fu">STDDEV_POP</span>(n_accidents) <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> highway) <span class="kw">as</span> highway_std,</span>
<span id="cb14-6"><a href="#cb14-6"></a>  <span class="kw">FROM</span> grouped_table</span>
<span id="cb14-7"><a href="#cb14-7"></a>)</span>
<span id="cb14-8"><a href="#cb14-8"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> partitions_table;</span></code></pre></div>
</div>
<div class="cell-output cell-output-display" data-execution_count="400">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">highway</th>
<th data-quarto-table-cell-role="th">trip_date</th>
<th data-quarto-table-cell-role="th">n_trips</th>
<th data-quarto-table-cell-role="th">n_accidents</th>
<th data-quarto-table-cell-role="th">highway_average</th>
<th data-quarto-table-cell-role="th">highway_std</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>I580</td>
<td>2024-11-13</td>
<td>171</td>
<td>16.0</td>
<td>14.666667</td>
<td>1.247219</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>I580</td>
<td>2024-11-14</td>
<td>167</td>
<td>13.0</td>
<td>14.666667</td>
<td>1.247219</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>I580</td>
<td>2024-11-15</td>
<td>154</td>
<td>15.0</td>
<td>14.666667</td>
<td>1.247219</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>I280</td>
<td>2024-11-15</td>
<td>176</td>
<td>15.0</td>
<td>18.666667</td>
<td>2.867442</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>I280</td>
<td>2024-11-14</td>
<td>181</td>
<td>22.0</td>
<td>18.666667</td>
<td>2.867442</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>I280</td>
<td>2024-11-13</td>
<td>151</td>
<td>19.0</td>
<td>18.666667</td>
<td>2.867442</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="tabset-3-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-4-tab">
<p>Finally, we can write a straightforward select statement that gets our desired final columns out of <code>partitions_table</code>.</p>
<div id="cell-42" class="cell" data-execution_count="401">
<div class="cell-output cell-output-display cell-output-markdown">
<div class="sourceCode" id="cb15"><pre class="sourceCode numberSource sql number-lines"><code class="sourceCode sql"><span id="cb15-1"><a href="#cb15-1"></a><span class="kw">SELECT</span></span>
<span id="cb15-2"><a href="#cb15-2"></a>  highway,</span>
<span id="cb15-3"><a href="#cb15-3"></a>  trip_date,</span>
<span id="cb15-4"><a href="#cb15-4"></a>  n_trips,</span>
<span id="cb15-5"><a href="#cb15-5"></a>  n_accidents,</span>
<span id="cb15-6"><a href="#cb15-6"></a>  (n_accidents <span class="op">-</span> highway_average) <span class="op">/</span> highway_std <span class="kw">as</span> highway_z_score</span>
<span id="cb15-7"><a href="#cb15-7"></a><span class="kw">FROM</span> partitions_table;</span></code></pre></div>
</div>
<div class="cell-output cell-output-display" data-execution_count="401">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">highway</th>
<th data-quarto-table-cell-role="th">trip_date</th>
<th data-quarto-table-cell-role="th">n_trips</th>
<th data-quarto-table-cell-role="th">n_accidents</th>
<th data-quarto-table-cell-role="th">highway_z_score</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>I580</td>
<td>2024-11-13</td>
<td>171</td>
<td>16.0</td>
<td>1.069045</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>I580</td>
<td>2024-11-14</td>
<td>167</td>
<td>13.0</td>
<td>-1.336306</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>I580</td>
<td>2024-11-15</td>
<td>154</td>
<td>15.0</td>
<td>0.267261</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>I280</td>
<td>2024-11-15</td>
<td>176</td>
<td>15.0</td>
<td>-1.278724</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>I280</td>
<td>2024-11-14</td>
<td>181</td>
<td>22.0</td>
<td>1.162476</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>I280</td>
<td>2024-11-13</td>
<td>151</td>
<td>19.0</td>
<td>0.116248</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="multiple-aggregations-in-one-table" class="level2">
<h2 class="anchored" data-anchor-id="multiple-aggregations-in-one-table">Multiple aggregations in one table</h2>
<p>Let’s say that, in addition to trips that were associated with accidents on highways, we were interested in counting cars that were associated with accidents on highways. This would give us a sense of if some cars are involved in multiple accidents on the same highway in the same day. Thus, we want to know:</p>
<ol type="1">
<li>The number of unique cars that traveled on each highway on each day</li>
<li>The number of unique cars that were associated with an accident on each highway on each day, alongside</li>
<li>The trip count and</li>
<li>The accident count, all in one table.</li>
</ol>
<p>This implies two distinct levels of aggregation within a table, which can be complex in SQL. To start this, I’ll just look at how I would count up unique cars alone. We’ll lean on the <code>COUNT(DISTINCT {column})</code> aggregation function in SQL, which counts unique rows in some column over a grouping.</p>
<blockquote class="blockquote">
<p>When the DISTINCT clause is provided, only distinct values are considered in the computation of the aggregate. This is typically used in combination with the count aggregate to get the number of distinct elements; but it can be used together with any aggregate function in the system.<br>
– <a href="https://duckdb.org/docs/sql/functions/aggregates.html#distinct-clause-in-aggregate-functions">DuckDB Documentation</a></p>
</blockquote>
<div id="cell-46" class="cell" data-outputid="810ef9ee-7566-42e8-bfba-74e6c11154e6" data-execution_count="402">
<div class="cell-output cell-output-display cell-output-markdown">
<div class="sourceCode" id="cb16"><pre class="sourceCode numberSource sql number-lines"><code class="sourceCode sql"><span id="cb16-1"><a href="#cb16-1"></a><span class="kw">SELECT</span></span>
<span id="cb16-2"><a href="#cb16-2"></a>  highway,</span>
<span id="cb16-3"><a href="#cb16-3"></a>  trip_date,</span>
<span id="cb16-4"><a href="#cb16-4"></a>  <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> license_plate) <span class="kw">AS</span> n_cars</span>
<span id="cb16-5"><a href="#cb16-5"></a><span class="kw">FROM</span></span>
<span id="cb16-6"><a href="#cb16-6"></a>  accidents </span>
<span id="cb16-7"><a href="#cb16-7"></a><span class="kw">GROUP</span> <span class="kw">BY</span></span>
<span id="cb16-8"><a href="#cb16-8"></a>  highway,</span>
<span id="cb16-9"><a href="#cb16-9"></a>  trip_date</span></code></pre></div>
</div>
<div class="cell-output cell-output-display" data-execution_count="402">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">highway</th>
<th data-quarto-table-cell-role="th">trip_date</th>
<th data-quarto-table-cell-role="th">n_cars</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>I280</td>
<td>2024-11-14</td>
<td>83</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>I280</td>
<td>2024-11-15</td>
<td>83</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>I580</td>
<td>2024-11-13</td>
<td>86</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>I580</td>
<td>2024-11-14</td>
<td>83</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>I580</td>
<td>2024-11-15</td>
<td>78</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>I280</td>
<td>2024-11-13</td>
<td>82</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>That’s fine and good, but we also want to know the count of those cars that were involved in accidents on each highway/day. This is a little complicated due to the structure of the data. Recall that the accident flag is defined at the trip level, not the car level.</p>
<ul>
<li><strong>Date</strong>
<ul>
<li><strong>Highway</strong>
<ul>
<li>A highway will have multiple cars that use it.
<ul>
<li><strong>Car</strong> (license plate)
<ul>
<li>A car can make multiple trips.
<ul>
<li><strong>Trip</strong> (each row is a trip)
<ul>
<li>Associated with:
<ul>
<li><strong>Accident flag</strong></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
<p>We’ll need to move that flag up a level in the hierarchy, so that we have something like the following:</p>
<ul>
<li><strong>Date</strong>
<ul>
<li><strong>Highway</strong>
<ul>
<li>A highway will have multiple cars that use it.
<ul>
<li><strong>Car</strong> (license plate)
<ul>
<li><strong>Accident flag</strong></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
<p>One approach to this problem is to use <code>GROUP BY</code>, with grouping on highway, date, and car, then figuring out if that group (car-highway-date) had any accident flag via <code>CASE WHEN SUM(accident_flag) &gt; 0 THEN 1 ELSE 0 END</code>. Then, I can use <code>GROUP BY</code> again to return to the highway-date level and aggregate the number of cars and number of cars with accidents. After that, I can do a similar grouping exercise to count up the number of trips and trips resulting in accident, and then I can merge the two distinct tables. In other words:</p>
<ol type="1">
<li>define the car with accident flag</li>
<li>group by date-highway, aggregate cars</li>
<li>group by date-highway, aggregate trips</li>
<li>merge (1) and (2)</li>
</ol>
<p>Here’s the whole process, executed.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-4-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-1" role="tab" aria-controls="tabset-4-1" aria-selected="true">Full Query</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-4-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-2" role="tab" aria-controls="tabset-4-2" aria-selected="false">Step 1</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-4-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-3" role="tab" aria-controls="tabset-4-3" aria-selected="false">Step 2</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-4-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-4" role="tab" aria-controls="tabset-4-4" aria-selected="false">Step 3</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-4-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-5" role="tab" aria-controls="tabset-4-5" aria-selected="false">Step 4</a></li></ul>
<div class="tab-content">
<div id="tabset-4-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-4-1-tab">
<div id="cell-49" class="cell" data-execution_count="403">
<div class="cell-output cell-output-display cell-output-markdown">
<div class="sourceCode" id="cb17"><pre class="sourceCode numberSource sql number-lines"><code class="sourceCode sql"><span id="cb17-1"><a href="#cb17-1"></a><span class="kw">WITH</span> car_table <span class="kw">as</span> (<span class="kw">SELECT</span></span>
<span id="cb17-2"><a href="#cb17-2"></a>  license_plate,</span>
<span id="cb17-3"><a href="#cb17-3"></a>  highway,</span>
<span id="cb17-4"><a href="#cb17-4"></a>  trip_date,</span>
<span id="cb17-5"><a href="#cb17-5"></a>  <span class="cf">CASE</span> <span class="cf">WHEN</span> <span class="fu">SUM</span>(accident_flag) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">THEN</span> <span class="dv">1</span> <span class="cf">ELSE</span> <span class="dv">0</span> <span class="cf">END</span> <span class="kw">AS</span> car_w_accident</span>
<span id="cb17-6"><a href="#cb17-6"></a><span class="kw">FROM</span></span>
<span id="cb17-7"><a href="#cb17-7"></a>  accidents </span>
<span id="cb17-8"><a href="#cb17-8"></a><span class="kw">GROUP</span> <span class="kw">BY</span></span>
<span id="cb17-9"><a href="#cb17-9"></a>  license_plate,</span>
<span id="cb17-10"><a href="#cb17-10"></a>  highway,</span>
<span id="cb17-11"><a href="#cb17-11"></a>  trip_date</span>
<span id="cb17-12"><a href="#cb17-12"></a>),</span>
<span id="cb17-13"><a href="#cb17-13"></a></span>
<span id="cb17-14"><a href="#cb17-14"></a>cars_w_accident_count <span class="kw">as</span> (<span class="kw">SELECT</span> </span>
<span id="cb17-15"><a href="#cb17-15"></a>  highway,</span>
<span id="cb17-16"><a href="#cb17-16"></a>  trip_date,</span>
<span id="cb17-17"><a href="#cb17-17"></a>  <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> license_plate) <span class="kw">as</span> n_cars,</span>
<span id="cb17-18"><a href="#cb17-18"></a>  <span class="fu">SUM</span>(car_w_accident) <span class="kw">as</span> n_cars_w_accident</span>
<span id="cb17-19"><a href="#cb17-19"></a><span class="kw">FROM</span></span>
<span id="cb17-20"><a href="#cb17-20"></a>  car_table</span>
<span id="cb17-21"><a href="#cb17-21"></a><span class="kw">GROUP</span> <span class="kw">BY</span></span>
<span id="cb17-22"><a href="#cb17-22"></a>  highway,</span>
<span id="cb17-23"><a href="#cb17-23"></a>  trip_date),</span>
<span id="cb17-24"><a href="#cb17-24"></a></span>
<span id="cb17-25"><a href="#cb17-25"></a>accident_count <span class="kw">as</span> (<span class="kw">SELECT</span></span>
<span id="cb17-26"><a href="#cb17-26"></a>  highway,</span>
<span id="cb17-27"><a href="#cb17-27"></a>  trip_date,</span>
<span id="cb17-28"><a href="#cb17-28"></a>  <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">as</span> n_trips,</span>
<span id="cb17-29"><a href="#cb17-29"></a>  <span class="fu">SUM</span>(accident_flag) <span class="kw">as</span> n_accidents</span>
<span id="cb17-30"><a href="#cb17-30"></a><span class="kw">FROM</span></span>
<span id="cb17-31"><a href="#cb17-31"></a>  accidents </span>
<span id="cb17-32"><a href="#cb17-32"></a><span class="kw">GROUP</span> <span class="kw">BY</span></span>
<span id="cb17-33"><a href="#cb17-33"></a>  highway,</span>
<span id="cb17-34"><a href="#cb17-34"></a>  trip_date</span>
<span id="cb17-35"><a href="#cb17-35"></a><span class="kw">ORDER</span> <span class="kw">BY</span></span>
<span id="cb17-36"><a href="#cb17-36"></a>  highway,</span>
<span id="cb17-37"><a href="#cb17-37"></a>  trip_date)</span>
<span id="cb17-38"><a href="#cb17-38"></a></span>
<span id="cb17-39"><a href="#cb17-39"></a><span class="kw">SELECT</span></span>
<span id="cb17-40"><a href="#cb17-40"></a>a.highway,</span>
<span id="cb17-41"><a href="#cb17-41"></a>a.trip_date,</span>
<span id="cb17-42"><a href="#cb17-42"></a>a.n_trips,</span>
<span id="cb17-43"><a href="#cb17-43"></a>a.n_accidents,</span>
<span id="cb17-44"><a href="#cb17-44"></a>b.n_cars,</span>
<span id="cb17-45"><a href="#cb17-45"></a>b.n_cars_w_accident</span>
<span id="cb17-46"><a href="#cb17-46"></a><span class="kw">FROM</span> </span>
<span id="cb17-47"><a href="#cb17-47"></a>  accident_count a</span>
<span id="cb17-48"><a href="#cb17-48"></a>  <span class="kw">JOIN</span> cars_w_accident_count b</span>
<span id="cb17-49"><a href="#cb17-49"></a>    <span class="kw">ON</span> (a.highway <span class="op">=</span> b.highway <span class="kw">AND</span> a.trip_date <span class="op">=</span> b.trip_date)</span></code></pre></div>
</div>
<div class="cell-output cell-output-display" data-execution_count="403">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">highway</th>
<th data-quarto-table-cell-role="th">trip_date</th>
<th data-quarto-table-cell-role="th">n_trips</th>
<th data-quarto-table-cell-role="th">n_accidents</th>
<th data-quarto-table-cell-role="th">n_cars</th>
<th data-quarto-table-cell-role="th">n_cars_w_accident</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>I280</td>
<td>2024-11-13</td>
<td>151</td>
<td>19.0</td>
<td>82</td>
<td>18.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>I280</td>
<td>2024-11-14</td>
<td>181</td>
<td>22.0</td>
<td>83</td>
<td>20.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>I280</td>
<td>2024-11-15</td>
<td>176</td>
<td>15.0</td>
<td>83</td>
<td>15.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>I580</td>
<td>2024-11-13</td>
<td>171</td>
<td>16.0</td>
<td>86</td>
<td>16.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>I580</td>
<td>2024-11-14</td>
<td>167</td>
<td>13.0</td>
<td>83</td>
<td>12.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>I580</td>
<td>2024-11-15</td>
<td>154</td>
<td>15.0</td>
<td>78</td>
<td>15.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="tabset-4-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-4-2-tab">
<p>Create an accident flag at the car/day/highway level. Note the use of <a href="https://duckdb.org/docs/sql/expressions/case.html"><code>CASE WHEN</code></a>.</p>
<div id="cell-51" class="cell" data-execution_count="404">
<div class="cell-output cell-output-display cell-output-markdown">
<div class="sourceCode" id="cb18"><pre class="sourceCode numberSource sql number-lines"><code class="sourceCode sql"><span id="cb18-1"><a href="#cb18-1"></a><span class="kw">WITH</span> car_table <span class="kw">as</span> (<span class="kw">SELECT</span></span>
<span id="cb18-2"><a href="#cb18-2"></a>  license_plate,</span>
<span id="cb18-3"><a href="#cb18-3"></a>  highway,</span>
<span id="cb18-4"><a href="#cb18-4"></a>  trip_date,</span>
<span id="cb18-5"><a href="#cb18-5"></a>  <span class="cf">CASE</span> <span class="cf">WHEN</span> <span class="fu">SUM</span>(accident_flag) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">THEN</span> <span class="dv">1</span> <span class="cf">ELSE</span> <span class="dv">0</span> <span class="cf">END</span> <span class="kw">AS</span> car_w_accident</span>
<span id="cb18-6"><a href="#cb18-6"></a><span class="kw">FROM</span></span>
<span id="cb18-7"><a href="#cb18-7"></a>  accidents </span>
<span id="cb18-8"><a href="#cb18-8"></a><span class="kw">GROUP</span> <span class="kw">BY</span></span>
<span id="cb18-9"><a href="#cb18-9"></a>  license_plate,</span>
<span id="cb18-10"><a href="#cb18-10"></a>  highway,</span>
<span id="cb18-11"><a href="#cb18-11"></a>  trip_date</span>
<span id="cb18-12"><a href="#cb18-12"></a>)</span>
<span id="cb18-13"><a href="#cb18-13"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> car_table  </span></code></pre></div>
</div>
<div class="cell-output cell-output-display" data-execution_count="404">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">license_plate</th>
<th data-quarto-table-cell-role="th">highway</th>
<th data-quarto-table-cell-role="th">trip_date</th>
<th data-quarto-table-cell-role="th">car_w_accident</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>90093</td>
<td>I280</td>
<td>2024-11-13</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>90062</td>
<td>I580</td>
<td>2024-11-13</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>90086</td>
<td>I280</td>
<td>2024-11-13</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>90050</td>
<td>I580</td>
<td>2024-11-13</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>90069</td>
<td>I580</td>
<td>2024-11-14</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">490</td>
<td>90006</td>
<td>I580</td>
<td>2024-11-13</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">491</td>
<td>90021</td>
<td>I280</td>
<td>2024-11-13</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">492</td>
<td>90009</td>
<td>I580</td>
<td>2024-11-14</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">493</td>
<td>90024</td>
<td>I280</td>
<td>2024-11-14</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">494</td>
<td>90068</td>
<td>I580</td>
<td>2024-11-13</td>
<td>0</td>
</tr>
</tbody>
</table>

<p>495 rows × 4 columns</p>
</div>
</div>
</div>
</div>
<div id="tabset-4-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-4-3-tab">
<p>Aggregate cars.</p>
<div id="cell-53" class="cell" data-execution_count="405">
<div class="cell-output cell-output-display cell-output-markdown">
<div class="sourceCode" id="cb19"><pre class="sourceCode numberSource sql number-lines"><code class="sourceCode sql"><span id="cb19-1"><a href="#cb19-1"></a><span class="kw">WITH</span> cars_w_accident_count <span class="kw">as</span> (<span class="kw">SELECT</span> </span>
<span id="cb19-2"><a href="#cb19-2"></a>  highway,</span>
<span id="cb19-3"><a href="#cb19-3"></a>  trip_date,</span>
<span id="cb19-4"><a href="#cb19-4"></a>  <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> license_plate) <span class="kw">as</span> n_cars,</span>
<span id="cb19-5"><a href="#cb19-5"></a>  <span class="fu">SUM</span>(car_w_accident) <span class="kw">as</span> n_cars_w_accident</span>
<span id="cb19-6"><a href="#cb19-6"></a><span class="kw">FROM</span></span>
<span id="cb19-7"><a href="#cb19-7"></a>  car_table</span>
<span id="cb19-8"><a href="#cb19-8"></a><span class="kw">GROUP</span> <span class="kw">BY</span></span>
<span id="cb19-9"><a href="#cb19-9"></a>  highway,</span>
<span id="cb19-10"><a href="#cb19-10"></a>  trip_date)</span>
<span id="cb19-11"><a href="#cb19-11"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> cars_w_accident_count;</span></code></pre></div>
</div>
<div class="cell-output cell-output-display" data-execution_count="405">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">highway</th>
<th data-quarto-table-cell-role="th">trip_date</th>
<th data-quarto-table-cell-role="th">n_cars</th>
<th data-quarto-table-cell-role="th">n_cars_w_accident</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>I580</td>
<td>2024-11-13</td>
<td>86</td>
<td>16.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>I280</td>
<td>2024-11-15</td>
<td>83</td>
<td>15.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>I280</td>
<td>2024-11-14</td>
<td>83</td>
<td>20.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>I580</td>
<td>2024-11-14</td>
<td>83</td>
<td>12.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>I280</td>
<td>2024-11-13</td>
<td>82</td>
<td>18.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>I580</td>
<td>2024-11-15</td>
<td>78</td>
<td>15.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="tabset-4-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-4-4-tab">
<p>Aggregate trips (this is a table we’ve already created once before).</p>
<div id="cell-55" class="cell" data-execution_count="406">
<div class="cell-output cell-output-display cell-output-markdown">
<div class="sourceCode" id="cb20"><pre class="sourceCode numberSource sql number-lines"><code class="sourceCode sql"><span id="cb20-1"><a href="#cb20-1"></a><span class="kw">WITH</span> accident_count <span class="kw">as</span> (<span class="kw">SELECT</span></span>
<span id="cb20-2"><a href="#cb20-2"></a>  highway,</span>
<span id="cb20-3"><a href="#cb20-3"></a>  trip_date,</span>
<span id="cb20-4"><a href="#cb20-4"></a>  <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">as</span> n_trips,</span>
<span id="cb20-5"><a href="#cb20-5"></a>  <span class="fu">SUM</span>(accident_flag) <span class="kw">as</span> n_accidents </span>
<span id="cb20-6"><a href="#cb20-6"></a><span class="kw">FROM</span></span>
<span id="cb20-7"><a href="#cb20-7"></a>  accidents </span>
<span id="cb20-8"><a href="#cb20-8"></a><span class="kw">GROUP</span> <span class="kw">BY</span></span>
<span id="cb20-9"><a href="#cb20-9"></a>  highway,</span>
<span id="cb20-10"><a href="#cb20-10"></a>  trip_date</span>
<span id="cb20-11"><a href="#cb20-11"></a><span class="kw">ORDER</span> <span class="kw">BY</span></span>
<span id="cb20-12"><a href="#cb20-12"></a>  highway,</span>
<span id="cb20-13"><a href="#cb20-13"></a>  trip_date)</span>
<span id="cb20-14"><a href="#cb20-14"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> accident_count;</span></code></pre></div>
</div>
<div class="cell-output cell-output-display" data-execution_count="406">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">highway</th>
<th data-quarto-table-cell-role="th">trip_date</th>
<th data-quarto-table-cell-role="th">n_cars</th>
<th data-quarto-table-cell-role="th">n_cars_w_accident</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>I580</td>
<td>2024-11-13</td>
<td>86</td>
<td>16.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>I280</td>
<td>2024-11-15</td>
<td>83</td>
<td>15.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>I280</td>
<td>2024-11-14</td>
<td>83</td>
<td>20.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>I580</td>
<td>2024-11-14</td>
<td>83</td>
<td>12.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>I280</td>
<td>2024-11-13</td>
<td>82</td>
<td>18.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>I580</td>
<td>2024-11-15</td>
<td>78</td>
<td>15.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="tabset-4-5" class="tab-pane" role="tabpanel" aria-labelledby="tabset-4-5-tab">
<p>Merge the trip and car aggregates.</p>
<div id="cell-57" class="cell" data-execution_count="407">
<div class="cell-output cell-output-display cell-output-markdown">
<div class="sourceCode" id="cb21"><pre class="sourceCode numberSource sql number-lines"><code class="sourceCode sql"><span id="cb21-1"><a href="#cb21-1"></a><span class="kw">SELECT</span></span>
<span id="cb21-2"><a href="#cb21-2"></a>a.highway,</span>
<span id="cb21-3"><a href="#cb21-3"></a>a.trip_date,</span>
<span id="cb21-4"><a href="#cb21-4"></a>a.n_accidents,</span>
<span id="cb21-5"><a href="#cb21-5"></a>a.n_accidents,</span>
<span id="cb21-6"><a href="#cb21-6"></a>b.n_cars,</span>
<span id="cb21-7"><a href="#cb21-7"></a>b.n_cars_w_accident</span>
<span id="cb21-8"><a href="#cb21-8"></a><span class="kw">FROM</span> </span>
<span id="cb21-9"><a href="#cb21-9"></a>  accident_count a</span>
<span id="cb21-10"><a href="#cb21-10"></a>  <span class="kw">JOIN</span> cars_w_accident_count b</span>
<span id="cb21-11"><a href="#cb21-11"></a>    <span class="kw">ON</span> (a.highway <span class="op">=</span> b.highway <span class="kw">AND</span> a.trip_date <span class="op">=</span> b.trip_date)</span></code></pre></div>
</div>
<div class="cell-output cell-output-display" data-execution_count="407">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">highway</th>
<th data-quarto-table-cell-role="th">trip_date</th>
<th data-quarto-table-cell-role="th">n_accidents</th>
<th data-quarto-table-cell-role="th">n_accidents_1</th>
<th data-quarto-table-cell-role="th">n_cars</th>
<th data-quarto-table-cell-role="th">n_cars_w_accident</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>I580</td>
<td>2024-11-13</td>
<td>16.0</td>
<td>16.0</td>
<td>86</td>
<td>16.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>I280</td>
<td>2024-11-15</td>
<td>15.0</td>
<td>15.0</td>
<td>83</td>
<td>15.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>I280</td>
<td>2024-11-14</td>
<td>22.0</td>
<td>22.0</td>
<td>83</td>
<td>20.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>I580</td>
<td>2024-11-14</td>
<td>13.0</td>
<td>13.0</td>
<td>83</td>
<td>12.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>I280</td>
<td>2024-11-13</td>
<td>19.0</td>
<td>19.0</td>
<td>82</td>
<td>18.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>I580</td>
<td>2024-11-15</td>
<td>15.0</td>
<td>15.0</td>
<td>78</td>
<td>15.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
</div>
</div>
<p>Seems great, right? Maybe not – it’s a very long and overly complicated query because it goes down two separate paths of aggregation:</p>
<ol type="1">
<li>group by date-highway, aggregate cars</li>
<li>group by date-highway, aggregate trips</li>
</ol>
<p>If we can avoid entering two distinct group/aggregation paths, the merge can be eliminated, we won’t need CTEs, and this can be simplified to the following:</p>
<ol type="1">
<li>group by date-highway, aggregate cars, aggregate trips</li>
</ol>
<p>It certainly isn’t immediately obvious (to me), but we can actually exploit a combination of <code>CASE WHEN</code> and <code>COUNT (DISTINCT)</code> to accomplish this simplification:</p>
<ol type="1">
<li>group by date-highway.
<ul>
<li>aggregate cars with <code>CASE WHEN</code> and <code>COUNT (DISTINCT)</code></li>
<li>aggregate trips with <code>COUNT(*)</code> and <code>SUM</code></li>
</ul></li>
</ol>
<div id="cell-60" class="cell" data-outputid="44f66b53-cbb8-4255-d3b8-56895c729531" data-execution_count="408">
<div class="cell-output cell-output-display cell-output-markdown">
<div class="sourceCode" id="cb22"><pre class="sourceCode numberSource sql number-lines"><code class="sourceCode sql"><span id="cb22-1"><a href="#cb22-1"></a><span class="kw">SELECT</span></span>
<span id="cb22-2"><a href="#cb22-2"></a>    highway,</span>
<span id="cb22-3"><a href="#cb22-3"></a>    trip_date,</span>
<span id="cb22-4"><a href="#cb22-4"></a>    <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">as</span> n_trips,</span>
<span id="cb22-5"><a href="#cb22-5"></a>    <span class="fu">SUM</span>(accident_flag) <span class="kw">as</span> n_accidents,</span>
<span id="cb22-6"><a href="#cb22-6"></a>    <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> license_plate) <span class="kw">AS</span> n_cars,</span>
<span id="cb22-7"><a href="#cb22-7"></a>    <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span></span>
<span id="cb22-8"><a href="#cb22-8"></a>        (<span class="cf">CASE</span> <span class="cf">WHEN</span> accident_flag <span class="op">=</span> <span class="dv">1</span> <span class="cf">THEN</span> license_plate <span class="cf">ELSE</span> <span class="kw">NULL</span> <span class="cf">END</span>))</span>
<span id="cb22-9"><a href="#cb22-9"></a>        <span class="kw">AS</span> n_cars_w_accident</span>
<span id="cb22-10"><a href="#cb22-10"></a><span class="kw">FROM</span></span>
<span id="cb22-11"><a href="#cb22-11"></a>  accidents </span>
<span id="cb22-12"><a href="#cb22-12"></a><span class="kw">GROUP</span> <span class="kw">BY</span></span>
<span id="cb22-13"><a href="#cb22-13"></a>  highway,</span>
<span id="cb22-14"><a href="#cb22-14"></a>  trip_date</span></code></pre></div>
</div>
<div class="cell-output cell-output-display" data-execution_count="408">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">highway</th>
<th data-quarto-table-cell-role="th">trip_date</th>
<th data-quarto-table-cell-role="th">n_trips</th>
<th data-quarto-table-cell-role="th">n_accidents</th>
<th data-quarto-table-cell-role="th">n_cars</th>
<th data-quarto-table-cell-role="th">n_cars_w_accident</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>I280</td>
<td>2024-11-13</td>
<td>151</td>
<td>19.0</td>
<td>82</td>
<td>18</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>I580</td>
<td>2024-11-15</td>
<td>154</td>
<td>15.0</td>
<td>78</td>
<td>15</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>I280</td>
<td>2024-11-14</td>
<td>181</td>
<td>22.0</td>
<td>83</td>
<td>20</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>I280</td>
<td>2024-11-15</td>
<td>176</td>
<td>15.0</td>
<td>83</td>
<td>15</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>I580</td>
<td>2024-11-13</td>
<td>171</td>
<td>16.0</td>
<td>86</td>
<td>16</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>I580</td>
<td>2024-11-14</td>
<td>167</td>
<td>13.0</td>
<td>83</td>
<td>12</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>This exploits the fact that <code>NULL</code> values are ignored by most aggregate functions. Thus, we create a column that is essentially the same as the suspicious transaction flag, but instead of 1/0, it contains the license plate number for the car (if it was in a trip that resulted in an accident) or <code>NULL</code>. When we count distinct values for that column, grouped by highway and date, we then effectively count up how many unique cars associated with accidents there were in that highway-date group.</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{amerkhanian2024,
  author = {Amerkhanian, Peter},
  title = {Grouping {Problems} with {SQL}},
  date = {2024-11-20},
  url = {https://peter-amerkhanian.com/posts/sql-count-cases/},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-amerkhanian2024" class="csl-entry quarto-appendix-citeas" role="listitem">
Amerkhanian, Peter. 2024. <span>“Grouping Problems with SQL.”</span>
November 20, 2024. <a href="https://peter-amerkhanian.com/posts/sql-count-cases/">https://peter-amerkhanian.com/posts/sql-count-cases/</a>.
</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/peter-amerkhanian\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
          // target, if specified
          link.setAttribute("target", "_blank");
          if (link.getAttribute("rel") === null) {
            link.setAttribute("rel", "noopener");
          }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>Copyright 2024, Peter Amerkhanian</p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>